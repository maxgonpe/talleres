{% extends "base.html" %}
{% load static crispy_forms_tags humanize %}

{% block title %}Ingreso de Diagn√≥stico (Flujo Fusionado){% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'css/centralized-colors.css' %}">
  <style>
    .wizard-progress { background: var(--bg-card); border-radius: 16px; padding: 1.5rem; box-shadow: var(--shadow-md); margin-bottom: 2rem; }
    .wizard-steps { display: flex; justify-content: center; gap: 2.5rem; }
    .wizard-step { text-align: center; min-width: 110px; }
    .wizard-step-circle { width: 42px; height: 42px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-weight: 700; margin-bottom: .35rem; }
    .wizard-step.active .wizard-step-circle { background: var(--primary-600); color: #fff; }
    .wizard-step.done .wizard-step-circle { background: var(--success-500); color: #fff; }
    .wizard-step.pending .wizard-step-circle { background: var(--border-color); color: var(--text-secondary); }
    .wizard-step-label { font-size: .9rem; font-weight: 600; color: var(--text-secondary); }

    .wizard-pane { display: none; }
    .wizard-pane.active { display: block; }

    /* Estilos para el acorde√≥n de componentes - Bordes blancos en tema oscuro */
    body.theme-piedra .accordion-item,
    body.theme-dark .accordion-item,
    body.theme-forest .accordion-item { border: 2px solid #ffffff; border-radius: 12px; }
    body.theme-piedra .accordion-button,
    body.theme-dark .accordion-button,
    body.theme-forest .accordion-button { border-bottom: 2px solid #ffffff !important; }
    body.theme-piedra .accordion-button:not(.collapsed),
    body.theme-dark .accordion-button:not(.collapsed),
    body.theme-forest .accordion-button:not(.collapsed) { border-bottom: 2px solid #ffffff !important; }

    .componente-item { border: 1px solid var(--border-color); border-radius: 12px; padding: 1rem 1.25rem; margin-bottom: 1rem; background: var(--bg-card); transition: border .3s, box-shadow .3s; }
    .componente-item.active { border-color: var(--primary-500); box-shadow: 0 8px 24px rgba(13, 110, 253, .12); }
    body.theme-piedra .componente-item,
    body.theme-dark .componente-item,
    body.theme-forest .componente-item { border: 2px solid #ffffff; }
    /* Primer nivel: Card activa - Azul marino */
    body.theme-piedra .componente-item.active,
    body.theme-dark .componente-item.active,
    body.theme-forest .componente-item.active { 
      border: 2px solid #ffffff; 
      background: #001f3f !important; /* Azul marino */
    }
    /* Segundo nivel: Elementos dentro de la card activa - Azul el√©ctrico */
    body.theme-piedra .componente-item.active .componente-header,
    body.theme-piedra .componente-item.active .acciones-panel,
    body.theme-dark .componente-item.active .componente-header,
    body.theme-dark .componente-item.active .acciones-panel,
    body.theme-forest .componente-item.active .componente-header,
    body.theme-forest .componente-item.active .acciones-panel { 
      background: #0066ff !important; /* Azul el√©ctrico */
    }
    .componente-header { display: flex; align-items: center; justify-content: space-between; gap: 1rem; cursor: pointer; }
    .componente-header strong { font-size: 1.05rem; color: var(--text-primary); }
    .acciones-panel { margin-top: 1rem; border-top: 1px dashed var(--border-color); padding-top: 1rem; display: none; }
    .acciones-panel.show { display: block; }
    .accion-item { border: 1px solid var(--border-color); border-radius: 10px; padding: .85rem; margin-bottom: .75rem; background: var(--bg-secondary); }
    .accion-item.seleccionada { border-color: var(--primary-500); background: rgba(13, 110, 253, 0.08); }
    body.theme-piedra .accion-item,
    body.theme-dark .accion-item,
    body.theme-forest .accion-item { border: 2px solid #ffffff; }
    body.theme-piedra .accion-item.seleccionada,
    body.theme-dark .accion-item.seleccionada,
    body.theme-forest .accion-item.seleccionada { border: 2px solid #ffffff; }
    .accion-item .accion-head { display: flex; justify-content: space-between; align-items: center; gap: .75rem; }
    .accion-item .accion-head .badge { font-size: .75rem; text-transform: uppercase; letter-spacing: .04em; }
    .accion-item .accion-controls { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: .75rem; margin-top: .75rem; }
    .accion-item .accion-subtotal { text-align: right; font-weight: 700; color: var(--success-600); }
    /* Precio en rojo para modo oscuro */
    body.theme-piedra .accion-item .accion-subtotal,
    body.theme-dark .accion-item .accion-subtotal,
    body.theme-forest .accion-item .accion-subtotal { color: #ff0000 !important; }
    /* Capitalizar primera letra de componentes y acciones */
    .accordion-button,
    .componente-header strong,
    .accion-item .form-check-label { text-transform: capitalize; }

    .resumen-card { border: 1px solid var(--border-color); border-radius: 12px; padding: 1.25rem; background: var(--bg-card); box-shadow: var(--shadow-sm); }
    body.theme-oscuro .resumen-card { border: 2px solid var(--border-color); }
    .resumen-card h5 { font-size: 1.05rem; font-weight: 700; color: var(--text-secondary); margin-bottom: .75rem; }
    .resumen-card ul { list-style: none; padding: 0; margin: 0; }
    .resumen-card ul li { padding: .35rem 0; border-bottom: 1px dashed var(--border-color); font-size: .95rem; }
    .resumen-card ul li:last-child { border-bottom: none; }

    .total-mano-obra { font-size: 1.4rem; font-weight: 800; color: var(--primary-700); }
    .wizard-navigation { position: sticky; bottom: 0; background: var(--bg-card); padding: 1rem 0; margin-top: 1.5rem; border-top: 1px solid var(--border-color); box-shadow: 0 -4px 24px rgba(0,0,0,.05); z-index: 50; }

    @media (max-width: 992px) {
      .wizard-steps { flex-direction: column; gap: 1rem; }
      .componente-header { flex-direction: column; align-items: flex-start; }
      .wizard-navigation { position: static; box-shadow: none; border-top: none; }
    }
  </style>
{% endblock %}

{% block content %}
<div class="container py-4" id="ingreso-fusionado-root"
     data-acciones-template="{% url 'acciones_por_componente' 0 %}">

  <h1 class="mb-4">üöó Ingreso de Diagn√≥stico ‚Äì Flujo Fusionado..</h1>
  <p class="text-muted mb-4">
    Este dise√±o integra la selecci√≥n de componentes y las acciones sugeridas en un mismo paso, reduciendo
    el cambio de contexto y permitiendo que el t√©cnico confirme todo en un mismo lugar. √ösalo con el
    par√°metro <code>?layout=fusionado</code> para evaluarlo sin afectar el flujo actual.
  </p>

  <div class="wizard-progress">
    <div class="wizard-steps">
      <div class="wizard-step active" data-step="1">
        <div class="wizard-step-circle">1</div>
        <div class="wizard-step-label">Cliente y Veh√≠culo</div>
      </div>
      <div class="wizard-step" data-step="2">
        <div class="wizard-step-circle">2</div>
        <div class="wizard-step-label">Diagn√≥stico + Acciones</div>
      </div>
      <div class="wizard-step" data-step="3">
        <div class="wizard-step-circle">3</div>
        <div class="wizard-step-label">Repuestos y Resumen</div>
      </div>
    </div>
  </div>

  <form id="form-ingreso" method="post" action="{% url 'ingreso_rapido' %}" novalidate>
    {% csrf_token %}

    <!-- Paso 1 -->
    <section class="wizard-pane active" data-step-pane="1">
      <div class="row g-4">
        <div class="col-lg-6">
          <div class="resumen-card h-100">
            <h5>üë§ Cliente</h5>
            <div class="mb-3">
              <label class="form-label">Cliente existente</label>
              <select id="cliente_existente" name="cliente_existente" class="form-select">
                <option value="">-- Nuevo cliente --</option>
                {% for cliente in clientes_existentes %}
                  <option value="{{ cliente.rut }}"
                    {% if selected_cliente and selected_cliente|stringformat:"s" == cliente.rut|stringformat:"s" %}selected{% endif %}>
                    {{ cliente.nombre }} ({{ cliente.rut }}) ‚Äì {{ cliente.telefono|default:"Sin tel√©fono" }}
                  </option>
                {% endfor %}
              </select>
            </div>
            <div id="nuevo_cliente_campos">
              {{ cliente_form|crispy }}
            </div>
          </div>
        </div>
        <div class="col-lg-6">
          <div class="resumen-card h-100">
            <h5>üöò Veh√≠culo</h5>
            <div class="mb-3">
              <label class="form-label">Seleccionar veh√≠culo existente</label>
              <select id="vehiculo_select" name="vehiculo_existente" class="form-select"
                      data-selected="{{ selected_vehiculo|default:'' }}">
                <option value="">-- Nuevo veh√≠culo --</option>
              </select>
            </div>
            <div id="vehiculo_fields">
              <div class="alert alert-info border border-primary border-3 rounded-3 p-4 mb-4 shadow-sm" style="background: linear-gradient(135deg, rgba(13, 110, 253, 0.12) 0%, rgba(13, 110, 253, 0.05) 100%);">
                <div class="d-flex align-items-center mb-3">
                  <div class="bg-primary text-white rounded-circle p-3 me-3" style="width: 52px; height: 52px; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-search fa-lg"></i>
                  </div>
                  <div>
                    <h6 class="mb-1 text-primary fw-bold">Buscar datos del veh√≠culo</h6>
                    <p class="mb-0 text-muted small">Introduce la placa y consulta la API para autocompletar los campos.</p>
                  </div>
                </div>
                <label for="vehiculo-placa" class="form-label fw-semibold">Placa del veh√≠culo</label>
                <div class="input-group">
                  <input type="text"
                         id="vehiculo-placa"
                         name="vehiculo-placa"
                         class="form-control text-uppercase fw-semibold"
                         placeholder="Ej: JGCX79"
                         autocomplete="off"
                         style="letter-spacing: 0.12em;">
                  <button type="button" class="btn btn-primary" id="btn-buscar-vehiculo">
                    <i class="fas fa-search me-1"></i> Buscar en API
                  </button>
                </div>
                <small class="text-muted d-block mt-2">
                  Consejo: presiona Enter o sal del campo para buscar autom√°ticamente.
                </small>
              </div>
              {{ vehiculo_form|crispy }}
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Paso 2 -->
    <section class="wizard-pane" data-step-pane="2">
      <div class="row g-4">
        <div class="col-xl-8">
          <div class="resumen-card mb-4">
            <h5>üìù Descripci√≥n del problema</h5>
            {{ diagnostico_form|crispy }}
          </div>

          <div class="resumen-card">
            <div class="d-flex align-items-center justify-content-between mb-3">
              <h5 class="mb-0">üîß Componentes y Acciones</h5>
              <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse"
                      data-bs-target="#plano-colapsable" aria-expanded="false">
                üó∫Ô∏è Mostrar plano interactivo
              </button>
            </div>

            <div class="accordion" id="componentesAccordion">
              {% for padre in componentes %}
                <div class="accordion-item mb-3">
                  <h2 class="accordion-header" id="heading-{{ padre.id }}">
                    <button class="accordion-button collapsed" type="button"
                            data-bs-toggle="collapse" data-bs-target="#collapse-{{ padre.id }}"
                            aria-expanded="false" aria-controls="collapse-{{ padre.id }}">
                      {{ padre.nombre }}
                    </button>
                  </h2>
                  <div id="collapse-{{ padre.id }}" class="accordion-collapse collapse"
                       aria-labelledby="heading-{{ padre.id }}" data-bs-parent="#componentesAccordion">
                    <div class="accordion-body">
                      {% for hijo in padre.hijos.all|dictsort:"nombre" %}
                        <div class="componente-item" data-componente-id="{{ hijo.id }}">
                          <div class="componente-header">
                            <div>
                              <div class="form-check form-switch mb-1">
                                <input class="form-check-input componente-checkbox"
                                       type="checkbox"
                                       id="comp-{{ hijo.id }}"
                                       name="componentes_seleccionados"
                                       value="{{ hijo.id }}"
                                       data-nombre="{{ hijo.nombre }}"
                                       {% if hijo.id in selected_componentes_ids %}checked{% endif %}>
                                <label class="form-check-label fw-semibold" for="comp-{{ hijo.id }}">
                                  {{ hijo.nombre }}
                                </label>
                              </div>
                              <small class="text-muted">ID: {{ hijo.id }} ‚Ä¢ C√≥digo: {{ hijo.codigo }}</small>
                            </div>
                            <div class="text-end">
                              <span class="badge bg-secondary">Acciones sugeridas</span>
                              <div class="small text-muted">Se cargan al activar el componente</div>
                            </div>
                          </div>
                          <div class="acciones-panel" id="acciones-panel-{{ hijo.id }}">
                            <div class="acciones-placeholder text-muted small">
                              Activa el componente para ver las acciones disponibles.
                            </div>
                            <div class="acciones-contenido"></div>
                          </div>
                        </div>
                      {% empty %}
                        <p class="text-muted small">No hay subcomponentes registrados en este grupo.</p>
                      {% endfor %}
                    </div>
                  </div>
                </div>
              {% empty %}
                <div class="alert alert-info mb-0">No existen componentes disponibles.</div>
              {% endfor %}
            </div>
          </div>

          <div class="collapse mt-4" id="plano-colapsable">
            <div class="resumen-card">
              <h5 class="mb-3">üó∫Ô∏è Plano interactivo</h5>
              <div id="plano-container"
                   style="border:1px solid var(--border-color); max-height:600px; min-height:400px; overflow:auto;"
                   data-inicial-url="{% static 'images/vehiculo-desde-abajo.svg' %}">
                <div style="transform:scale(1.024); transform-origin: top left;">
                  {{ svg|safe }}
                </div>
              </div>
              <button id="btn-reset-plano" type="button" class="btn btn-outline-secondary btn-sm mt-3">
                ‚¨ÖÔ∏è Resetear plano
              </button>
            </div>
          </div>
        </div>

        <div class="col-xl-4">
          <div class="resumen-card mb-4">
            <h5>‚úÖ Componentes Seleccionados</h5>
            <ul id="lista-seleccionados" class="list-unstyled mb-0">
              <li class="text-muted">A√∫n no hay componentes seleccionados.</li>
            </ul>
          </div>

          <div class="resumen-card">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h5 class="mb-0">‚ö° Acciones Confirmadas</h5>
              <span class="badge bg-primary-subtle text-primary-emphasis" id="acciones-count">0 acciones</span>
            </div>
            <div class="table-responsive">
              <table class="table table-sm align-middle mb-0" id="acciones-resumen-table">
                <thead class="table-light">
                  <tr>
                    <th>Componente</th>
                    <th>Acci√≥n</th>
                    <th class="text-end">Subtotal</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td colspan="3" class="text-muted text-center small">
                      Selecciona acciones para ver el resumen.
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="mt-3 text-end">
              <div class="small text-muted">Total Mano de Obra</div>
              <div class="total-mano-obra" id="total_mano_obra">$0</div>
            </div>
          </div>
        </div>
      </div>

      <input type="hidden" id="acciones_componentes_json" name="acciones_componentes_json" value="[]">
    </section>

    <!-- Paso 3 -->
    <section class="wizard-pane" data-step-pane="3">
      <div class="row g-4">
        <div class="col-lg-7">
          <div class="resumen-card h-100">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h5 class="mb-0">üì¶ Repuestos sugeridos</h5>
              <div>
                <button type="button" class="btn btn-outline-primary btn-sm" onclick="cargarRepuestos()">
                  üì¶ Inventario propio
                </button>
                <button type="button" class="btn btn-outline-success btn-sm" data-bs-toggle="modal"
                        data-bs-target="#modalRepuestosExternos">
                  üåê Proveedores externos
                </button>
              </div>
            </div>

            <div id="diagnostico-meta"
                 data-diagnostico-id="{{ diagnostico.id|default:'' }}"
                 data-csrf="{{ csrf_token }}">
            </div>

            <div id="repuestos-list"
                 data-preview-url="{% url 'sugerir_repuestos_preview' %}"
                 data-with-id-template="{% url 'sugerir_repuestos' 0 %}">
              <p class="text-muted">Selecciona componentes para recibir sugerencias autom√°ticas.</p>
            </div>

            <div class="mt-3 text-end">
              <button class="btn btn-success" type="button" onclick="prepararRepuestosParaEnvio()">
                üíæ Guardar selecci√≥n de repuestos
              </button>
            </div>
          </div>
        </div>
        <div class="col-lg-5">
          <div class="resumen-card mb-4">
            <h5>üßæ Resumen de repuestos/insumos</h5>
            <div id="tabla-contenido">
              <p class="text-muted">Los repuestos agregados aparecer√°n aqu√≠.</p>
            </div>
          </div>

          <div class="resumen-card">
            <h5>üß∞ Insumos r√°pidos</h5>
            <div class="mb-2">
              <label for="buscar-insumo" class="form-label small">Buscar insumo</label>
              <div class="input-group input-group-sm">
                <input type="text" id="buscar-insumo" class="form-control"
                       placeholder="Nombre, SKU, c√≥digo‚Ä¶">
                <button class="btn btn-outline-primary" type="button" onclick="buscarInsumos()">Buscar</button>
              </div>
              <small class="text-muted">La b√∫squeda inicia con 2 caracteres.</small>
            </div>
            <div id="insumos-disponibles" class="mb-3">
              <div class="list-group" id="lista-insumos-disponibles">
                <div class="alert alert-info small mb-0">Escribe para ver insumos disponibles.</div>
              </div>
            </div>
            <button class="btn btn-success w-100" type="button" onclick="agregarInsumos()">
              ‚ûï Agregar insumos seleccionados
            </button>
            <div class="alert alert-success mt-3 small" id="insumos-agregados-mensaje" style="display:none;">
              ‚úÖ Insumos agregados. Revisa la tabla de repuestos.
            </div>
          </div>
        </div>
      </div>

      <input type="hidden" name="repuestos_json" id="repuestos-json">
      <input type="hidden" name="repuestos_externos_json" id="repuestos-externos-json">
      <input type="hidden" name="insumos_json" id="insumos-json">
    </section>

    <div class="wizard-navigation">
      <div class="container">
        <div class="d-flex flex-wrap justify-content-between align-items-center gap-3">
          <button type="button" class="btn btn-outline-secondary" id="wizard-prev" style="display:none;">
            ‚Üê Anterior
          </button>
          <div class="flex-grow-1"></div>
          <div class="d-flex gap-2">
            <button type="button" class="btn btn-primary" id="wizard-next">
              Siguiente ‚Üí
            </button>
            <button type="button" class="btn btn-primary" id="wizard-save-approve-create" style="display:none;"
                    onclick="guardarAprobarYCrearOT()">
              ‚úÖ Guardar Aprobar y Crear OT
            </button>
            <button type="submit" class="btn btn-success" id="wizard-submit" style="display:none;">
              üíæ Guardar diagn√≥stico
            </button>
            <button type="button" class="btn btn-outline-warning" id="wizard-skip" style="display:none;"
                    onclick="skipRepuestosAndSubmit()">
              ‚è≠Ô∏è Omitir repuestos y guardar
            </button>
          </div>
          <a href="javascript:history.back()" class="btn btn-secondary">
            Cancelar
          </a>
        </div>
      </div>
    </div>
  </form>

  <div id="acciones-endpoints" data-acciones-url-template="{% url 'acciones_por_componente' 0 %}"></div>
  <div id="componentes-endpoints" data-lookup-url="{% url 'componentes_lookup' %}"></div>
  <div id="repuestos-endpoints"
       data-preview-url="{% url 'sugerir_repuestos_preview' %}"
       data-with-id-template="{% url 'sugerir_repuestos' 0 %}"></div>
</div>

{% include "car/partials/repuestos_externos_modal.html" %}
{% endblock %}

{% block extra_js %}
  <script src="{% static 'js/ingreso_fusionado.js' %}"></script>
{% endblock %}

