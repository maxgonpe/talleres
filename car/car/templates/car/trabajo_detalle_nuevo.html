{% extends "base.html" %}
{% load static %}
{% load humanize %}

{% block title %}Trabajo #{{ trabajo.id }} - {{ trabajo.vehiculo }}{% endblock %}

{% block extra_head %}
<style>
    .trabajo-container {
        max-width: 100%;
        margin: 0;
        padding: 0.5rem;
    }
    
    .trabajo-header {
        background: linear-gradient(135deg, var(--btn-bg) 0%, var(--muted) 100%);
        color: var(--btn-fg);
        padding: 1rem;
        border-radius: 10px;
        margin-bottom: 1rem;
        text-align: center;
    }
    
    .estado-badge {
        font-size: 1.1rem;
        padding: 0.5rem 1rem;
        border-radius: 25px;
        font-weight: 600;
        margin: 0.5rem;
        display: inline-block;
        min-width: 120px;
    }
    
    .estado-iniciado { background: #ffc107; color: #000; }
    .estado-trabajando { background: #0d6efd; color: #fff; }
    .estado-completado { background: #198754; color: #fff; }
    .estado-entregado { background: #6c757d; color: #fff; }
    
    .tab-container {
        background: var(--card-bg);
        border-radius: 10px;
        margin-bottom: 1rem;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    /* Esquemas claros - Tab-container con tonos m√°s oscuros para mejor contraste */
    .theme-cyan .tab-container {
        background-color: #b2dfdb !important; /* Tono m√°s oscuro del cyan */
    }
    
    .theme-sand .tab-container {
        background-color: #d7ccc8 !important; /* Tono m√°s oscuro del sand */
    }
    
    .theme-sage .tab-container {
        background-color: #c8e6c9 !important; /* Tono m√°s oscuro del sage */
    }
    
    .theme-sky .tab-container {
        background-color: #bbdefb !important; /* Tono m√°s oscuro del sky */
    }
    
    .tab-nav {
        display: flex;
        background: var(--muted);
        border-radius: 10px 10px 0 0;
        overflow-x: auto;
    }
    
    .tab-btn {
        flex: 1;
        padding: 0.75rem;
        border: none;
        background: transparent;
        color: var(--fg);
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        white-space: nowrap;
        min-width: 80px;
    }
    
    .tab-btn.active {
        background: var(--btn-bg);
        color: var(--btn-fg);
    }
    
    .tab-content {
        padding: 1rem;
        display: none;
    }
    
    .tab-content.active {
        display: block;
    }
    
    .info-card {
        background: var(--card-bg);
        border-radius: 10px;
        padding: 1rem;
        margin-bottom: 1rem;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    /* Esquemas claros - Cards con tonos m√°s oscuros para mejor contraste */
    .theme-cyan .info-card {
        background-color: #b2dfdb !important; /* Tono m√°s oscuro del cyan */
    }
    
    .theme-sand .info-card {
        background-color: #d7ccc8 !important; /* Tono m√°s oscuro del sand */
    }
    
    .theme-sage .info-card {
        background-color: #c8e6c9 !important; /* Tono m√°s oscuro del sage */
    }
    
    .theme-sky .info-card {
        background-color: #bbdefb !important; /* Tono m√°s oscuro del sky */
    }
    
    .info-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 0;
        border-bottom: 1px solid var(--muted);
    }
    
    .info-row:last-child {
        border-bottom: none;
    }
    
    .info-label {
        font-weight: 600;
        color: var(--btn-bg);
    }
    
    .info-value {
        color: var(--fg);
        text-align: right;
    }
    
    .btn-action {
        border-radius: 25px;
        padding: 0.5rem 1rem;
        font-weight: 600;
        margin: 0.25rem;
        min-width: 100px;
        font-size: 0.9rem;
    }
    
    .btn-mobile {
        width: 100%;
        padding: 1rem;
        font-size: 1.1rem;
        margin-bottom: 0.5rem;
    }
    
    .form-group {
        margin-bottom: 1rem;
    }
    
    .form-control {
        background: var(--card-bg);
        border: 2px solid var(--muted);
        color: var(--fg);
        border-radius: 8px;
        padding: 0.75rem;
    }
    
    .form-control:focus {
        border-color: var(--btn-bg);
        box-shadow: 0 0 0 0.2rem rgba(var(--btn-bg), 0.25);
    }
    
    /* Esquemas claros - Selector de mec√°nicos con color de bot√≥n */
    .theme-cyan input[type="checkbox"]:checked,
    .theme-cyan input[type="checkbox"]:checked + label,
    .theme-cyan ul li input[type="checkbox"]:checked,
    .theme-cyan ul li input[type="checkbox"]:checked + label {
        background-color: #004d40 !important; /* Color de bot√≥n cyan */
        border-color: #004d40 !important;
        color: #ffffff !important;
    }
    
    .theme-sand input[type="checkbox"]:checked,
    .theme-sand input[type="checkbox"]:checked + label,
    .theme-sand ul li input[type="checkbox"]:checked,
    .theme-sand ul li input[type="checkbox"]:checked + label {
        background-color: #3e2723 !important; /* Color de bot√≥n sand */
        border-color: #3e2723 !important;
        color: #ffffff !important;
    }
    
    .theme-sage input[type="checkbox"]:checked,
    .theme-sage input[type="checkbox"]:checked + label,
    .theme-sage ul li input[type="checkbox"]:checked,
    .theme-sage ul li input[type="checkbox"]:checked + label {
        background-color: #1b5e20 !important; /* Color de bot√≥n sage */
        border-color: #1b5e20 !important;
        color: #ffffff !important;
    }
    
    .theme-sky input[type="checkbox"]:checked,
    .theme-sky input[type="checkbox"]:checked + label,
    .theme-sky ul li input[type="checkbox"]:checked,
    .theme-sky ul li input[type="checkbox"]:checked + label {
        background-color: #0d47a1 !important; /* Color de bot√≥n sky */
        border-color: #0d47a1 !important;
        color: #ffffff !important;
    }
    
    .item-list {
        background: var(--card-bg);
        border-radius: 10px;
        padding: 1rem;
        margin-bottom: 1rem;
    }
    
    .item-card {
        background: var(--muted);
        border-radius: 8px;
        padding: 0.75rem;
        margin-bottom: 0.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        color: #2c3e50 !important; /* Texto oscuro para mejor contraste */
    }
    
    .item-card strong {
        color: #1a252f !important; /* Texto m√°s oscuro para t√≠tulos */
    }
    
    .item-card small {
        color: #34495e !important; /* Texto oscuro para subt√≠tulos */
    }
    
    /* Esquemas claros - Item-cards con tonos m√°s oscuros para mejor contraste */
    .theme-cyan .item-card {
        background-color: #b2dfdb !important; /* Tono m√°s oscuro del cyan */
        color: #004d40 !important; /* Texto verde oscuro para cyan */
    }
    
    .theme-cyan .item-card strong {
        color: #00251a !important; /* T√≠tulo m√°s oscuro para cyan */
    }
    
    .theme-cyan .item-card small {
        color: #00695c !important; /* Subt√≠tulo oscuro para cyan */
    }
    
    .theme-sand .item-card {
        background-color: #d7ccc8 !important; /* Tono m√°s oscuro del sand */
        color: #3e2723 !important; /* Texto marr√≥n oscuro para sand */
    }
    
    .theme-sand .item-card strong {
        color: #1c0e0a !important; /* T√≠tulo m√°s oscuro para sand */
    }
    
    .theme-sand .item-card small {
        color: #5d4037 !important; /* Subt√≠tulo oscuro para sand */
    }
    
    .theme-sage .item-card {
        background-color: #c8e6c9 !important; /* Tono m√°s oscuro del sage */
        color: #1b5e20 !important; /* Texto verde oscuro para sage */
    }
    
    .theme-sage .item-card strong {
        color: #0d3a0f !important; /* T√≠tulo m√°s oscuro para sage */
    }
    
    .theme-sage .item-card small {
        color: #2e7d32 !important; /* Subt√≠tulo oscuro para sage */
    }
    
    .theme-sky .item-card {
        background-color: #bbdefb !important; /* Tono m√°s oscuro del sky */
        color: #0d47a1 !important; /* Texto azul oscuro para sky */
    }
    
    .theme-sky .item-card strong {
        color: #051f4a !important; /* T√≠tulo m√°s oscuro para sky */
    }
    
    .theme-sky .item-card small {
        color: #1565c0 !important; /* Subt√≠tulo oscuro para sky */
    }
    
    .item-card.completado {
        background: #d4edda;
        border-left: 4px solid #198754;
        color: #155724 !important; /* Texto verde oscuro para completado */
    }
    
    .item-card.completado strong {
        color: #0d4a1a !important; /* T√≠tulo m√°s oscuro para completado */
    }
    
    .item-card.completado small {
        color: #1e7e34 !important; /* Subt√≠tulo oscuro para completado */
    }
    
    .item-card.pendiente {
        background: #fff3cd;
        border-left: 4px solid #ffc107;
        color: #856404 !important; /* Texto amarillo oscuro para pendiente */
    }
    
    .item-card.pendiente strong {
        color: #533f03 !important; /* T√≠tulo m√°s oscuro para pendiente */
    }
    
    .item-card.pendiente small {
        color: #6c5a04 !important; /* Subt√≠tulo oscuro para pendiente */
    }
    
    /* Estilos espec√≠ficos para completado y pendiente en cada tema */
    .theme-cyan .item-card.completado {
        background: #a5d6a7 !important; /* Verde m√°s oscuro para cyan */
        color: #1b5e20 !important;
    }
    
    .theme-cyan .item-card.pendiente {
        background: #fff9c4 !important; /* Amarillo m√°s oscuro para cyan */
        color: #f57f17 !important;
    }
    
    .theme-sand .item-card.completado {
        background: #a5d6a7 !important; /* Verde m√°s oscuro para sand */
        color: #1b5e20 !important;
    }
    
    .theme-sand .item-card.pendiente {
        background: #fff9c4 !important; /* Amarillo m√°s oscuro para sand */
        color: #f57f17 !important;
    }
    
    .theme-sage .item-card.completado {
        background: #a5d6a7 !important; /* Verde m√°s oscuro para sage */
        color: #1b5e20 !important;
    }
    
    .theme-sage .item-card.pendiente {
        background: #fff9c4 !important; /* Amarillo m√°s oscuro para sage */
        color: #f57f17 !important;
    }
    
    .theme-sky .item-card.completado {
        background: #a5d6a7 !important; /* Verde m√°s oscuro para sky */
        color: #1b5e20 !important;
    }
    
    .theme-sky .item-card.pendiente {
        background: #fff9c4 !important; /* Amarillo m√°s oscuro para sky */
        color: #f57f17 !important;
    }
    
    .toggle-btn {
        border: none;
        border-radius: 20px;
        padding: 0.25rem 0.75rem;
        font-size: 0.8rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .toggle-btn.completado {
        background: #198754;
        color: white;
    }
    
    .toggle-btn.pendiente {
        background: #ffc107;
        color: #000;
    }
    
    .progress-container {
        background: var(--card-bg);
        border-radius: 10px;
        padding: 1rem;
        margin-bottom: 1rem;
    }
    
    .progress-bar-custom {
        height: 25px;
        background: var(--muted);
        border-radius: 15px;
        overflow: hidden;
        position: relative;
    }
    
    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #ffc107 0%, #198754 100%);
        border-radius: 15px;
        transition: width 0.5s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
    }
    
    .foto-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        gap: 0.5rem;
        margin-top: 1rem;
    }
    
    .foto-item {
        aspect-ratio: 1;
        border-radius: 8px;
        overflow: hidden;
        position: relative;
    }
    
    .foto-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    .foto-item .delete-btn {
        position: absolute;
        top: 2px;
        right: 2px;
        background: rgba(220, 53, 69, 0.8);
        color: white;
        border: none;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        font-size: 0.7rem;
        cursor: pointer;
    }
    
    .add-form {
        background: var(--muted);
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
        display: none;
    }
    
    .add-form.active {
        display: block;
    }
    
    .btn-toggle-form {
        width: 100%;
        margin-bottom: 1rem;
    }
    
    @media (max-width: 768px) {
        .trabajo-container {
            padding: 0.25rem;
        }
        
        .tab-nav {
            flex-direction: column;
        }
        
        .tab-btn {
            border-bottom: 1px solid var(--muted);
        }
        
        .tab-btn:last-child {
            border-bottom: none;
        }
        
        .info-row {
            flex-direction: column;
            align-items: flex-start;
        }
        
        .info-value {
            text-align: left;
            margin-top: 0.25rem;
        }
        
        .btn-action {
            width: 100%;
            margin: 0.25rem 0;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="trabajo-container">
    <!-- Header del Trabajo -->
    <div class="trabajo-header">
        <h2>üîß Trabajo #{{ trabajo.id }}</h2>
        <h4>{{ trabajo.vehiculo }}</h4>
        <p class="mb-0">{{ trabajo.vehiculo.cliente.nombre }} - {{ trabajo.vehiculo.cliente.telefono }}</p>
    </div>

    <!-- Estado Actual -->
    <div class="info-card text-center">
        <h5>Estado Actual</h5>
        <div class="estado-badge estado-{{ trabajo.estado }}">
            {% if trabajo.estado == 'iniciado' %}üü° Iniciado
            {% elif trabajo.estado == 'trabajando' %}üîµ Trabajando
            {% elif trabajo.estado == 'completado' %}üü¢ Completado
            {% elif trabajo.estado == 'entregado' %}‚ö´ Entregado
            {% endif %}
        </div>
        
        <!-- Barra de Progreso -->
        <div class="progress-container">
            <div class="progress-bar-custom">
                <div class="progress-fill" style="width: {{ trabajo.porcentaje_avance }}%;">
                    {{ trabajo.porcentaje_avance }}%
                </div>
            </div>
        </div>
    </div>

    <!-- Navegaci√≥n por Pesta√±as -->
    <div class="tab-container">
        <div class="tab-nav">
            <button class="tab-btn {% if active_tab == 'info' %}active{% endif %}" onclick="showTab('info')">üìã Info</button>
            <button class="tab-btn {% if active_tab == 'acciones' %}active{% endif %}" onclick="showTab('acciones')">üõ†Ô∏è Acciones</button>
            <button class="tab-btn {% if active_tab == 'repuestos' %}active{% endif %}" onclick="showTab('repuestos')">üîß Repuestos</button>
            <button class="tab-btn {% if active_tab == 'fotos' %}active{% endif %}" onclick="showTab('fotos')">üì∑ Fotos</button>
            <button class="tab-btn {% if active_tab == 'estado' %}active{% endif %}" onclick="showTab('estado')">‚ö° Estado</button>
        </div>

        <!-- Pesta√±a: Informaci√≥n -->
        <div id="tab-info" class="tab-content {% if active_tab == 'info' %}active{% endif %}">
            <div class="info-card">
                <h5>üìã Informaci√≥n del Trabajo</h5>
                
                <div class="info-row">
                    <span class="info-label">Cliente:</span>
                    <span class="info-value">{{ trabajo.vehiculo.cliente.nombre }}</span>
                </div>
                
                <div class="info-row">
                    <span class="info-label">Tel√©fono:</span>
                    <span class="info-value">{{ trabajo.vehiculo.cliente.telefono }}</span>
                </div>
                
                <div class="info-row">
                    <span class="info-label">Veh√≠culo:</span>
                    <span class="info-value">{{ trabajo.vehiculo.marca }} {{ trabajo.vehiculo.modelo }} {{ trabajo.vehiculo.anio }}</span>
                </div>
                
                <div class="info-row">
                    <span class="info-label">Placa:</span>
                    <span class="info-value">{{ trabajo.vehiculo.placa }}</span>
                </div>
                
                <div class="info-row">
                    <span class="info-label">Fecha Inicio:</span>
                    <span class="info-value">{{ trabajo.fecha_inicio|date:"d/m/Y H:i"|default:"No iniciado" }}</span>
                </div>
                
                <div class="info-row">
                    <span class="info-label">Fecha Fin:</span>
                    <span class="info-value">{{ trabajo.fecha_fin|date:"d/m/Y H:i"|default:"En progreso" }}</span>
                </div>
                
                <div class="info-row">
                    <span class="info-label">Total:</span>
                    <span class="info-value">${{ trabajo.total_general|default:0|floatformat:0|intcomma }}</span>
                </div>
            </div>

            <!-- Campo Observaciones -->
            <div class="info-card">
                <h5>üìù Observaciones</h5>
                <form method="post" id="observaciones-form">
                    {% csrf_token %}
                    <textarea name="observaciones" class="form-control" rows="4" 
                              placeholder="Agregar observaciones sobre el trabajo...">{{ trabajo.observaciones|default:"" }}</textarea>
                    <button type="submit" name="guardar_observaciones" class="btn btn-primary btn-action mt-2">
                        üíæ Guardar Observaciones
                    </button>
                </form>
            </div>

            <!-- Mec√°nicos Asignados -->
            <div class="info-card">
                <h5>üë∑ Mec√°nicos Asignados</h5>
                {% if trabajo.mecanicos.exists %}
                    {% for mec in trabajo.mecanicos.all %}
                        <div class="item-card">
                            <div>
                                <strong>{{ mec.user.get_full_name|default:mec.user.first_name }}</strong>
                                {% if mec.especialidad %}
                                    <br><small>{{ mec.especialidad }}</small>
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <p class="text-muted">No hay mec√°nicos asignados</p>
                {% endif %}
                
                <form method="post">
                    {% csrf_token %}
                    {{ asignar_form.as_p }}
                    <button type="submit" name="asignar_mecanicos" class="btn btn-primary btn-action">
                        üë∑ Asignar Mec√°nicos
                    </button>
                </form>
            </div>
        </div>

        <!-- Pesta√±a: Acciones -->
        <div id="tab-acciones" class="tab-content {% if active_tab == 'acciones' %}active{% endif %}">
            <div class="info-card">
                <h5>üõ†Ô∏è Acciones del Trabajo</h5>
                
                <!-- Bot√≥n para agregar acci√≥n -->
                <button class="btn btn-success btn-toggle-form" onclick="toggleAddForm('accion')">
                    ‚ûï Agregar Acci√≥n
                </button>
                
                <!-- Formulario para agregar acci√≥n -->
                <div id="add-accion-form" class="add-form">
                    <form method="post">
                        {% csrf_token %}
                        <div class="form-group">
                            <label>Componente:</label>
                            <select name="componente" class="form-control" required>
                                <option value="">Seleccionar componente...</option>
                                {% for componente in componentes_disponibles %}
                                    <option value="{{ componente.id }}">{{ componente.nombre }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Acci√≥n:</label>
                            <select name="accion" class="form-control" required>
                                <option value="">Seleccionar acci√≥n...</option>
                                {% for accion in acciones_disponibles %}
                                    <option value="{{ accion.id }}">{{ accion.nombre }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Precio Mano de Obra:</label>
                            <input type="number" name="precio_mano_obra" class="form-control" step="0.01" min="0">
                        </div>
                        <button type="submit" name="agregar_accion" class="btn btn-primary btn-action">
                            ‚ûï Agregar
                        </button>
                        <button type="button" class="btn btn-secondary btn-action" onclick="toggleAddForm('accion')">
                            ‚ùå Cancelar
                        </button>
                    </form>
                </div>
                
                <!-- Lista de acciones -->
                {% for accion in trabajo.acciones.all %}
                    <div class="item-card {% if accion.completado %}completado{% else %}pendiente{% endif %}">
                        <div>
                            <strong>{{ accion.componente.nombre }}</strong><br>
                            <small>{{ accion.accion.nombre }}</small>
                            {% if accion.precio_mano_obra %}
                                <br><small class="text-success">${{ accion.precio_mano_obra|floatformat:0|intcomma }}</small>
                            {% endif %}
                        </div>
                        <div>
                            <form method="post" style="display: inline;">
                                {% csrf_token %}
                                <input type="hidden" name="accion_id" value="{{ accion.id }}">
                                <button type="submit" name="toggle_accion" 
                                        class="toggle-btn {% if accion.completado %}completado{% else %}pendiente{% endif %}">
                                    {% if accion.completado %}‚úÖ Completado{% else %}‚è≥ Pendiente{% endif %}
                                </button>
                            </form>
                            <form method="post" style="display: inline;">
                                {% csrf_token %}
                                <input type="hidden" name="accion_id" value="{{ accion.id }}">
                                <button type="submit" name="eliminar_accion" class="btn btn-danger btn-sm" 
                                        onclick="return confirm('¬øEliminar esta acci√≥n?')">
                                    üóëÔ∏è
                                </button>
                            </form>
                        </div>
                    </div>
                {% empty %}
                    <p class="text-muted">No hay acciones registradas</p>
                {% endfor %}
            </div>
        </div>

        <!-- Pesta√±a: Repuestos -->
        <div id="tab-repuestos" class="tab-content {% if active_tab == 'repuestos' %}active{% endif %}">
            <div class="info-card">
                <h5>üîß Repuestos del Trabajo</h5>
                
                <!-- Informaci√≥n del filtro inteligente -->
                <div class="alert alert-info mb-3">
                    <small>
                        <strong>üß† Filtro Inteligente Activo:</strong> 
                        Los repuestos mostrados est√°n filtrados autom√°ticamente por las caracter√≠sticas del veh√≠culo 
                        (marca: <strong>{{ trabajo.vehiculo.marca|default:"No especificada" }}</strong>, 
                        motor: <strong>{{ trabajo.vehiculo.descripcion_motor|default:"No especificado" }}</strong>).
                        Solo se muestran repuestos compatibles o de uso general.
                    </small>
                </div>
                
                <!-- Bot√≥n para agregar repuesto -->
                <button class="btn btn-success btn-toggle-form" onclick="toggleAddForm('repuesto')">
                    ‚ûï Agregar Repuesto
                </button>
                
                <!-- Formulario para agregar repuesto -->
                <div id="add-repuesto-form" class="add-form">
                    <form method="post">
                        {% csrf_token %}
                        <div class="form-group">
                            <label>Repuesto:</label>
                            <select name="repuesto" class="form-control" required>
                                <option value="">Seleccionar repuesto...</option>
                                {% for repuesto in repuestos_disponibles %}
                                    <option value="{{ repuesto.id }}" 
                                            data-marca="{{ repuesto.marca_veh|default:'General' }}"
                                            data-motor="{{ repuesto.tipo_de_motor|default:'General' }}"
                                            data-stock="{{ repuesto.stock|default:0 }}">
                                        {{ repuesto.nombre }} - ${{ repuesto.precio_venta|default:0|floatformat:0|intcomma }}
                                        {% if repuesto.marca_veh %} ({{ repuesto.marca_veh }}){% endif %}
                                        {% if repuesto.stock > 0 %} - Stock: {{ repuesto.stock }}{% endif %}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Cantidad:</label>
                            <input type="number" name="cantidad" class="form-control" min="1" value="1" required>
                        </div>
                        <div class="form-group">
                            <label>Precio Unitario:</label>
                            <input type="number" name="precio_unitario" id="precio-unitario" class="form-control" step="0.01" min="0" placeholder="Se llena autom√°ticamente">
                        </div>
                        <button type="submit" name="agregar_repuesto" class="btn btn-primary btn-action">
                            ‚ûï Agregar
                        </button>
                        <button type="button" class="btn btn-secondary btn-action" onclick="toggleAddForm('repuesto')">
                            ‚ùå Cancelar
                        </button>
                    </form>
                </div>
                
                <!-- Lista de repuestos -->
                {% for repuesto in trabajo.repuestos.all %}
                    <div class="item-card {% if repuesto.completado %}completado{% else %}pendiente{% endif %}">
                        <div>
                            <strong>{{ repuesto.repuesto.nombre }}</strong><br>
                            <small>Cantidad: {{ repuesto.cantidad }}</small>
                            {% if repuesto.precio_unitario %}
                                <br><small class="text-success">${{ repuesto.precio_unitario|floatformat:0|intcomma }} c/u</small>
                            {% endif %}
                        </div>
                        <div>
                            <form method="post" style="display: inline;">
                                {% csrf_token %}
                                <input type="hidden" name="repuesto_id" value="{{ repuesto.id }}">
                                <button type="submit" name="toggle_repuesto" 
                                        class="toggle-btn {% if repuesto.completado %}completado{% else %}pendiente{% endif %}">
                                    {% if repuesto.completado %}‚úÖ Completado{% else %}‚è≥ Pendiente{% endif %}
                                </button>
                            </form>
                            <form method="post" style="display: inline;">
                                {% csrf_token %}
                                <input type="hidden" name="repuesto_id" value="{{ repuesto.id }}">
                                <button type="submit" name="eliminar_repuesto" class="btn btn-danger btn-sm" 
                                        onclick="return confirm('¬øEliminar este repuesto?')">
                                    üóëÔ∏è
                                </button>
                            </form>
                        </div>
                    </div>
                {% empty %}
                    <p class="text-muted">No hay repuestos registrados</p>
                {% endfor %}
            </div>
        </div>

        <!-- Pesta√±a: Fotos -->
        <div id="tab-fotos" class="tab-content {% if active_tab == 'fotos' %}active{% endif %}">
            <div class="info-card">
                <h5>üì∑ Fotos del Progreso</h5>
                
                <!-- Formulario para subir foto -->
                <form method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="form-group">
                        <input type="file" name="imagen" class="form-control" accept="image/*" required>
                    </div>
                    <div class="form-group">
                        <input type="text" name="descripcion" class="form-control" placeholder="Descripci√≥n de la foto (opcional)">
                    </div>
                    <button type="submit" name="subir_foto" class="btn btn-primary btn-action">
                        üì∑ Subir Foto
                    </button>
                </form>
                
                <!-- Grid de fotos -->
                <div class="foto-grid">
                    {% for foto in trabajo.fotos.all %}
                        <div class="foto-item">
                            <img src="{{ foto.imagen.url }}" alt="{{ foto.descripcion|default:'Foto del trabajo' }}">
                            <button class="delete-btn" onclick="eliminarFoto({{ foto.id }})" title="Eliminar foto">√ó</button>
                        </div>
                    {% empty %}
                        <p class="text-muted">No hay fotos subidas</p>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Pesta√±a: Estado -->
        <div id="tab-estado" class="tab-content {% if active_tab == 'estado' %}active{% endif %}">
            <div class="info-card">
                <h5>‚ö° Cambiar Estado del Trabajo</h5>
                <p class="text-muted">Selecciona el nuevo estado para este trabajo:</p>
                
                <form method="post">
                    {% csrf_token %}
                    <div class="row g-2">
                        <div class="col-6">
                            <button type="submit" name="cambiar_estado" value="iniciado" 
                                    class="btn btn-mobile {% if trabajo.estado == 'iniciado' %}btn-warning{% else %}btn-outline-warning{% endif %}">
                                üü° Iniciado
                            </button>
                        </div>
                        <div class="col-6">
                            <button type="submit" name="cambiar_estado" value="trabajando" 
                                    class="btn btn-mobile {% if trabajo.estado == 'trabajando' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                                üîµ Trabajando
                            </button>
                        </div>
                        <div class="col-6">
                            <button type="submit" name="cambiar_estado" value="completado" 
                                    class="btn btn-mobile {% if trabajo.estado == 'completado' %}btn-success{% else %}btn-outline-success{% endif %}">
                                üü¢ Completado
                            </button>
                        </div>
                        <div class="col-6">
                            <button type="submit" name="cambiar_estado" value="entregado" 
                                    class="btn btn-mobile {% if trabajo.estado == 'entregado' %}btn-dark{% else %}btn-outline-dark{% endif %}">
                                ‚ö´ Entregado
                            </button>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Botones de Acci√≥n -->
            <div class="info-card">
                <h5>üìÑ Acciones Adicionales</h5>
                
                <a href="{% url 'trabajo_pdf' trabajo.pk %}" class="btn btn-info btn-mobile" target="_blank">
                    üìÑ Generar PDF de Estado
                </a>
                
                <a href="{% url 'panel_principal' %}" class="btn btn-secondary btn-mobile">
                    üè† Volver a la Pizarra
                </a>
                
                <a href="javascript:history.back()" class="btn btn-outline-secondary btn-mobile">
                    ‚Üê Regresar
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Funciones para las pesta√±as
function showTab(tabName) {
    // Ocultar todas las pesta√±as
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Remover clase active de todos los botones
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Mostrar la pesta√±a seleccionada
    document.getElementById('tab-' + tabName).classList.add('active');
    
    // Activar el bot√≥n correspondiente
    if (event && event.target) {
        event.target.classList.add('active');
    } else {
        // Si no hay event (llamada program√°tica), buscar el bot√≥n correcto
        document.querySelector(`[onclick="showTab('${tabName}')"]`).classList.add('active');
    }
}

// üîπ Inicializar pesta√±a activa al cargar la p√°gina
document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const activeTab = urlParams.get('tab');
    if (activeTab) {
        showTab(activeTab);
    }
});

// Funciones para formularios de agregar
function toggleAddForm(type) {
    const form = document.getElementById('add-' + type + '-form');
    form.classList.toggle('active');
}

// Funci√≥n para eliminar foto
function eliminarFoto(fotoId) {
    if (confirm('¬øEliminar esta foto?')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.innerHTML = `
            {% csrf_token %}
            <input type="hidden" name="eliminar_foto" value="${fotoId}">
        `;
        document.body.appendChild(form);
        form.submit();
    }
}

// Funci√≥n para generar PDF
function generarPDF() {
    // Aqu√≠ implementaremos la generaci√≥n de PDF
    alert('Funci√≥n de PDF en desarrollo...');
}

// Auto-guardar observaciones
document.addEventListener('DOMContentLoaded', function() {
    const observacionesTextarea = document.querySelector('textarea[name="observaciones"]');
    if (observacionesTextarea) {
        let timeout;
        observacionesTextarea.addEventListener('input', function() {
            clearTimeout(timeout);
            timeout = setTimeout(() => {
                // Auto-guardar despu√©s de 2 segundos de inactividad
                const form = document.getElementById('observaciones-form');
                if (form) {
                    form.submit();
                }
            }, 2000);
        });
    }
    
    // üîπ FILTRO INTELIGENTE: Mostrar informaci√≥n de compatibilidad al seleccionar repuesto
    const repuestoSelect = document.querySelector('select[name="repuesto"]');
    if (repuestoSelect) {
        // Crear elemento para mostrar informaci√≥n de compatibilidad
        const infoDiv = document.createElement('div');
        infoDiv.id = 'repuesto-compatibilidad-info';
        infoDiv.className = 'mt-2 p-2 bg-light rounded';
        infoDiv.style.display = 'none';
        repuestoSelect.parentNode.appendChild(infoDiv);
        
        repuestoSelect.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            if (selectedOption.value) {
                const marca = selectedOption.dataset.marca;
                const motor = selectedOption.dataset.motor;
                const stock = selectedOption.dataset.stock;
                
                // üîπ Llenar autom√°ticamente el precio unitario
                const precioInput = document.getElementById('precio-unitario');
                if (precioInput) {
                    // Extraer precio del texto de la opci√≥n (formato: "Nombre - $precio")
                    const optionText = selectedOption.textContent;
                    const precioMatch = optionText.match(/\$([0-9,]+)/);
                    if (precioMatch) {
                        const precio = precioMatch[1].replace(/,/g, '');
                        precioInput.value = precio;
                    }
                }
                
                let compatibilidadText = '';
                let compatibilidadClass = 'bg-secondary';
                
                // Calcular compatibilidad b√°sica
                if (marca && marca !== 'General') {
                    compatibilidadText += `‚úÖ Marca espec√≠fica: ${marca}<br>`;
                    compatibilidadClass = 'bg-success';
                } else {
                    compatibilidadText += `‚ö†Ô∏è Marca general<br>`;
                }
                
                if (motor && motor !== 'General') {
                    compatibilidadText += `‚úÖ Motor espec√≠fico: ${motor}<br>`;
                    if (compatibilidadClass === 'bg-secondary') compatibilidadClass = 'bg-warning';
                } else {
                    compatibilidadText += `‚ö†Ô∏è Motor general<br>`;
                }
                
                if (parseInt(stock) > 0) {
                    compatibilidadText += `‚úÖ Stock disponible: ${stock} unidades`;
                } else {
                    compatibilidadText += `‚ùå Sin stock disponible`;
                    compatibilidadClass = 'bg-danger';
                }
                
                infoDiv.innerHTML = `
                    <small class="text-muted">
                        <strong>Compatibilidad:</strong><br>
                        ${compatibilidadText}
                    </small>
                `;
                infoDiv.className = `mt-2 p-2 rounded ${compatibilidadClass} text-white`;
                infoDiv.style.display = 'block';
            } else {
                infoDiv.style.display = 'none';
            }
        });
    }
    
    // üîπ Calcular subtotal autom√°ticamente
    const cantidadInput = document.querySelector('input[name="cantidad"]');
    const precioInput = document.getElementById('precio-unitario');
    
    function calcularSubtotal() {
        if (cantidadInput && precioInput) {
            const cantidad = parseInt(cantidadInput.value) || 0;
            const precio = parseFloat(precioInput.value) || 0;
            const subtotal = cantidad * precio;
            
            // Mostrar subtotal en alg√∫n lugar (opcional)
            let subtotalDiv = document.getElementById('subtotal-preview');
            if (!subtotalDiv) {
                subtotalDiv = document.createElement('div');
                subtotalDiv.id = 'subtotal-preview';
                subtotalDiv.className = 'mt-2 p-2 bg-info text-white rounded';
                precioInput.parentNode.appendChild(subtotalDiv);
            }
            
            if (subtotal > 0) {
                subtotalDiv.innerHTML = `<small><strong>Subtotal: $${subtotal.toLocaleString()}</strong></small>`;
                subtotalDiv.style.display = 'block';
            } else {
                subtotalDiv.style.display = 'none';
            }
        }
    }
    
    if (cantidadInput) {
        cantidadInput.addEventListener('input', calcularSubtotal);
    }
    if (precioInput) {
        precioInput.addEventListener('input', calcularSubtotal);
    }
});
</script>
{% endblock %}
