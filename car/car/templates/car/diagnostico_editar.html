{% extends "base.html" %}
{% load static %}
{% load humanize %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'css/centralized-colors.css' %}">
{% endblock %}

{% block title %}Editar Diagnóstico #{{ diagnostico.id }}{% endblock %}

{% block extra_head %}
<style>
    .diagnostico-container {
        max-width: 100%;
        margin: 0;
        padding: var(--spacing-sm);
    }
    
    .diagnostico-header {
        background: linear-gradient(135deg, var(--accent) 0%, var(--primary-600) 100%);
        color: var(--text-inverse);
        padding: var(--spacing-md);
        border-radius: var(--border-radius-lg);
        margin-bottom: var(--spacing-md);
        text-align: center;
    }
    
    .tab-container {
        background-color: var(--bg-card);
        border-radius: var(--border-radius-lg);
        margin-bottom: var(--spacing-md);
        box-shadow: var(--shadow-md);
        border: 1px solid var(--border-color);
    }
    
    .tab-nav {
        display: flex;
        background-color: var(--bg-secondary);
        border-radius: var(--border-radius-lg) var(--border-radius-lg) 0 0;
        overflow-x: auto;
    }
    
    .tab-btn {
        flex: 1;
        padding: var(--spacing-md);
        border: none;
        background: transparent;
        color: var(--text-secondary);
        cursor: pointer;
        transition: all 0.3s ease;
        border-bottom: 3px solid transparent;
        font-weight: 500;
        white-space: nowrap;
    }
    
    .tab-btn:hover {
        background-color: var(--hover-bg);
        color: var(--text-primary);
    }
    
    .tab-btn.active {
        background-color: var(--bg-card);
        color: var(--text-primary);
        border-bottom-color: var(--accent);
    }
    
    .tab-content {
        display: none;
        padding: var(--spacing-lg);
    }
    
    .tab-content.active {
        display: block;
    }
    
    .info-card {
        background-color: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius-md);
        padding: var(--spacing-md);
        margin-bottom: var(--spacing-md);
        box-shadow: var(--shadow-sm);
    }
    
    .form-group {
        margin-bottom: var(--spacing-md);
    }
    
    .form-label {
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: var(--spacing-sm);
    }
    
    .form-control, .form-select {
        background-color: var(--bg-input);
        border: 1px solid var(--border-color);
        color: var(--text-primary);
        border-radius: var(--border-radius-sm);
        padding: var(--spacing-sm);
    }
    
    .form-control:focus, .form-select:focus {
        border-color: var(--accent);
        box-shadow: 0 0 0 0.2rem var(--accent-200);
        background-color: var(--bg-input);
        color: var(--text-primary);
    }
    
    .btn {
        border-radius: var(--border-radius-sm);
        padding: var(--spacing-sm) var(--spacing-md);
        font-weight: 500;
        transition: all 0.3s ease;
        border: none;
        cursor: pointer;
    }
    
    .btn-primary {
        background-color: var(--primary-600);
        color: var(--text-inverse);
    }
    
    .btn-primary:hover {
        background-color: var(--primary-700);
        transform: translateY(-1px);
    }
    
    .btn-success {
        background-color: var(--success-600);
        color: var(--text-inverse);
    }
    
    .btn-success:hover {
        background-color: var(--success-700);
    }
    
    .btn-warning {
        background-color: var(--warning-600);
        color: var(--text-inverse);
    }
    
    .btn-warning:hover {
        background-color: var(--warning-700);
    }
    
    .btn-danger {
        background-color: var(--danger-600);
        color: var(--text-inverse);
    }
    
    .btn-danger:hover {
        background-color: var(--danger-700);
    }
    
    .btn-outline-primary {
        background-color: transparent;
        border: 1px solid var(--primary-600);
        color: var(--primary-600);
    }
    
    .btn-outline-primary:hover {
        background-color: var(--primary-600);
        color: var(--text-inverse);
    }
    
    .list-group-item {
        background-color: var(--bg-card);
        border: 1px solid var(--border-color);
        color: var(--text-primary);
        padding: var(--spacing-md);
    }
    
    .list-group-item:hover {
        background-color: var(--hover-bg);
    }
    
    .badge {
        padding: var(--spacing-xs) var(--spacing-sm);
        border-radius: var(--border-radius-full);
        font-size: 0.75rem;
        font-weight: 600;
    }
    
    .badge.bg-success {
        background-color: var(--success-600) !important;
        color: var(--text-inverse);
    }
    
    .badge.bg-warning {
        background-color: var(--warning-600) !important;
        color: var(--text-inverse);
    }
    
    .badge.bg-info {
        background-color: var(--info-600) !important;
        color: var(--text-inverse);
    }
    
    .alert {
        border-radius: var(--border-radius-sm);
        padding: var(--spacing-md);
        margin-bottom: var(--spacing-md);
        border: 1px solid transparent;
    }
    
    .alert-info {
        background-color: var(--info-100);
        border-color: var(--info-300);
        color: var(--info-800);
    }
    
    .alert-warning {
        background-color: var(--warning-100);
        border-color: var(--warning-300);
        color: var(--warning-800);
    }
    
    .alert-success {
        background-color: var(--success-100);
        border-color: var(--success-300);
        color: var(--success-800);
    }
    
    .table {
        background-color: var(--bg-card);
        color: var(--text-primary);
        border-collapse: collapse;
        width: 100%;
    }
    
    .table th {
        background-color: var(--bg-secondary);
        color: var(--text-primary);
        font-weight: 600;
        padding: var(--spacing-md);
        border-bottom: 2px solid var(--border-color);
    }
    
    .table td {
        padding: var(--spacing-md);
        border-bottom: 1px solid var(--border-color);
    }
    
    .table-striped tbody tr:nth-of-type(odd) {
        background-color: var(--bg-secondary);
    }
    
    .table-hover tbody tr:hover {
        background-color: var(--hover-bg);
    }
    
    .text-muted {
        color: var(--text-secondary) !important;
    }
    
    .text-center {
        text-align: center;
    }
    
    .text-end {
        text-align: right;
    }
    
    .fw-bold {
        font-weight: 600;
    }
    
    .mb-3 {
        margin-bottom: var(--spacing-md);
    }
    
    .mt-3 {
        margin-top: var(--spacing-md);
    }
    
    .d-flex {
        display: flex;
    }
    
    .justify-content-between {
        justify-content: space-between;
    }
    
    .align-items-center {
        align-items: center;
    }
    
    .w-100 {
        width: 100%;
    }
    
    .input-group {
        display: flex;
        width: 100%;
    }
    
    .input-group .form-control {
        border-radius: var(--border-radius-sm) 0 0 var(--border-radius-sm);
    }
    
    .input-group .btn {
        border-radius: 0 var(--border-radius-sm) var(--border-radius-sm) 0;
    }
    
    .input-group-text {
        background-color: var(--bg-secondary);
        border: 1px solid var(--border-color);
        color: var(--text-secondary);
        padding: var(--spacing-sm) var(--spacing-md);
        border-radius: 0 var(--border-radius-sm) var(--border-radius-sm) 0;
    }
    
    .form-check {
        display: flex;
        align-items: center;
        margin-bottom: var(--spacing-sm);
    }
    
    .form-check-input {
        margin-right: var(--spacing-sm);
    }
    
    .form-check-label {
        color: var(--text-primary);
        cursor: pointer;
    }
    
    .progress {
        background-color: var(--bg-secondary);
        border-radius: var(--border-radius-full);
        height: 20px;
        overflow: hidden;
    }
    
    .progress-bar {
        background: linear-gradient(90deg, var(--primary-500), var(--success-500));
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--text-inverse);
        font-weight: 600;
        font-size: 0.75rem;
    }
    
    /* ========================================
       ACORDEÓN DE COMPONENTES
       ======================================== */
    
    .accordion {
        background-color: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius-md);
        overflow: hidden;
    }
    
    .accordion-item {
        border: 1px solid var(--border-color);
        background-color: var(--bg-card);
    }
    
    .accordion-button {
        background-color: var(--bg-secondary);
        color: var(--text-primary);
        border: none;
        font-weight: 600;
        padding: var(--spacing-md);
    }
    
    .accordion-button:not(.collapsed) {
        background-color: var(--accent-100);
        color: var(--text-primary);
        box-shadow: none;
    }
    
    .accordion-button:focus {
        box-shadow: 0 0 0 0.25rem var(--accent-200);
        border-color: var(--accent);
    }
    
    .accordion-body {
        background-color: var(--bg-card);
        color: var(--text-primary);
        padding: var(--spacing-md);
    }
    
    .form-check {
        margin-bottom: var(--spacing-sm);
    }
    
    .form-check-input {
        background-color: var(--bg-input);
        border: 1px solid var(--border-color);
    }
    
    .form-check-input:checked {
        background-color: var(--accent);
        border-color: var(--accent);
    }
    
    .form-check-input:focus {
        box-shadow: 0 0 0 0.25rem var(--accent-200);
    }
    
    .form-check-label {
        color: var(--text-primary);
        font-weight: 500;
        cursor: pointer;
    }
    
    .componente-seleccionado {
        background-color: var(--accent-100);
        border: 2px solid var(--accent);
        border-radius: var(--border-radius-sm);
        padding: var(--spacing-sm);
        margin-bottom: var(--spacing-md);
        font-weight: 600;
        color: var(--text-primary);
    }
</style>
{% endblock %}

{% block content %}
<div class="diagnostico-container">
    <!-- Header del Diagnóstico -->
    <div class="diagnostico-header">
        <h2>🔧 Editar Diagnóstico #{{ diagnostico.id }}</h2>
        <h4>{{ diagnostico.vehiculo }}</h4>
        <p class="mb-0">{{ diagnostico.vehiculo.cliente.nombre }} - {{ diagnostico.vehiculo.cliente.telefono }}</p>
    </div>

    <!-- Información General -->
    <div class="info-card">
        <h5>📋 Información del Diagnóstico</h5>
        <form method="post">
            {% csrf_token %}
            <div class="form-group">
                <label for="id_descripcion_problema" class="form-label">Descripción del Problema:</label>
                {{ diagnostico_form.descripcion_problema }}
            </div>
            <button type="submit" name="actualizar_descripcion" class="btn btn-primary">
                <i class="fas fa-save"></i> Actualizar Descripción
            </button>
        </form>
    </div>

    <!-- Navegación por Pestañas -->
    <div class="tab-container">
        <div class="tab-nav">
            <button class="tab-btn {% if active_tab == 'acciones' %}active{% endif %}" onclick="showTab('acciones')">🛠️ Acciones</button>
            <button class="tab-btn {% if active_tab == 'repuestos' %}active{% endif %}" onclick="showTab('repuestos')">🔧 Repuestos</button>
            <button class="tab-btn {% if active_tab == 'insumos' %}active{% endif %}" onclick="showTab('insumos')">📦 Insumos</button>
        </div>

        <!-- Pestaña: Acciones -->
        <div id="tab-acciones" class="tab-content {% if active_tab == 'acciones' %}active{% endif %}">
            <div class="info-card">
                <h5>🛠️ Acciones del Diagnóstico</h5>
                
                <!-- Acordeón de Componentes -->
                <div class="mb-4">
                    <h6>🔧 Seleccionar Componentes:</h6>
                    <div class="accordion" id="componentesAccordion">
                        {% for padre in componentes %}
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="heading-{{ padre.id }}">
                                    <button class="accordion-button collapsed" type="button"
                                            data-bs-toggle="collapse" data-bs-target="#collapse-{{ padre.id }}"
                                            aria-expanded="false" aria-controls="collapse-{{ padre.id }}">
                                        {{ padre.nombre }}
                                    </button>
                                </h2>
                                <div id="collapse-{{ padre.id }}" class="accordion-collapse collapse"
                                     aria-labelledby="heading-{{ padre.id }}" data-bs-parent="#componentesAccordion">
                                    <div class="accordion-body">
                                        {% for hijo in padre.hijos.all %}
                                            <div class="form-check">
                                                <input class="form-check-input componente-check"
                                                       type="checkbox"
                                                       value="{{ hijo.id }}"
                                                       id="comp-{{ hijo.id }}"
                                                       data-nombre="{{ hijo.nombre }}"
                                                       data-padre="{{ padre.nombre }}">
                                                <label class="form-check-label" for="comp-{{ hijo.id }}">
                                                    {{ hijo.nombre }}
                                                </label>
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Formulario para agregar acción -->
                <div class="mb-4">
                    <div class="row">
                        <div class="col-md-6">
                            <label for="componente-seleccionado" class="form-label">Componente Seleccionado:</label>
                            <input type="text" id="componente-seleccionado" class="form-control" readonly placeholder="Selecciona un componente del acordeón">
                            <input type="hidden" name="componente" id="componente-id">
                        </div>
                        <div class="col-md-6">
                            <label for="precio_mano_obra" class="form-label">Precio M.O.:</label>
                            <input type="number" name="precio_mano_obra" id="precio_mano_obra" class="form-control" step="0.01" min="0" placeholder="0.00">
                        </div>
                    </div>
                </div>

                <!-- Acciones disponibles para el componente seleccionado -->
                <div id="acciones-disponibles" class="mb-4" style="display: none;">
                    <h6>🛠️ Acciones Disponibles para el Componente:</h6>
                    <div class="card">
                        <div class="card-body">
                            <div id="lista-acciones-componente" class="list-group">
                                <!-- Las acciones se cargarán aquí dinámicamente -->
                            </div>
                            <div class="d-flex justify-content-between align-items-center mt-3">
                                <div>
                                    <strong>Total Mano de Obra:</strong> 
                                    <span id="total-mano-obra" class="text-success fw-bold">$0</span>
                                </div>
                                <button type="button" id="btn-agregar-acciones" class="btn btn-success" onclick="agregarAccionesSeleccionadas()">
                                    <i class="fas fa-plus"></i> Agregar Acciones Seleccionadas
                                </button>
                                <button type="button" class="btn btn-outline-info btn-sm ms-2" onclick="debugAcciones()">
                                    <i class="fas fa-bug"></i> Debug
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Formulario oculto para enviar acciones -->
                <form method="post" id="form-acciones" style="display: none;">
                    {% csrf_token %}
                    <input type="hidden" name="acciones_json" id="acciones-json">
                </form>

                <!-- Lista de acciones -->
                {% if diagnostico.acciones_componentes.all %}
                    <div class="list-group">
                        {% for dca in diagnostico.acciones_componentes.all %}
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>{{ dca.componente.nombre }}</strong> — {{ dca.accion.nombre }}
                                </div>
                                <div>
                                    <span class="badge bg-primary me-2">
                                        ${{ dca.precio_mano_obra|default:0|floatformat:0|intcomma }}
                                    </span>
                                    <form method="post" style="display: inline;">
                                        {% csrf_token %}
                                        <button type="submit" name="quitar_accion" value="{{ dca.id }}" 
                                                class="btn btn-sm btn-outline-danger"
                                                onclick="return confirm('¿Quitar esta acción del diagnóstico?')">
                                            🗑️ Quitar
                                        </button>
                                    </form>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> No hay acciones registradas para este diagnóstico.
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Pestaña: Repuestos -->
        <div id="tab-repuestos" class="tab-content {% if active_tab == 'repuestos' %}active{% endif %}">
            <div class="info-card">
                <h5>🔧 Repuestos del Diagnóstico</h5>
                
                <!-- Información del filtro inteligente -->
                <div class="alert alert-info mb-3">
                    <small>
                        <strong>🔍 Filtro Inteligente:</strong> 
                        Los repuestos se filtran automáticamente por la marca, modelo y año del vehículo del diagnóstico.
                        <br><strong>Vehículo:</strong> {{ diagnostico.vehiculo.marca }} {{ diagnostico.vehiculo.modelo }} {{ diagnostico.vehiculo.anio }}
                    </small>
                </div>
                
                <!-- Búsqueda de repuestos -->
                <div class="mb-3">
                    <label for="buscar-repuesto" class="form-label">🔍 Buscar Repuesto:</label>
                    <div class="input-group">
                        <input type="text" id="buscar-repuesto" class="form-control" placeholder="Buscar por nombre, SKU, marca... (escribe para filtrar)">
                        <button class="btn btn-outline-primary" type="button" onclick="buscarRepuestos()">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                    <small class="text-muted">La búsqueda se realiza automáticamente mientras escribes (mínimo 2 caracteres)</small>
                    <div class="mt-2">
                        <button class="btn btn-sm btn-outline-secondary" onclick="document.getElementById('buscar-repuesto').value='filtro'; buscarRepuestos();">Probar: filtro</button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="document.getElementById('buscar-repuesto').value='{{ diagnostico.vehiculo.marca }}'; buscarRepuestos();">Probar: {{ diagnostico.vehiculo.marca }}</button>
                    </div>
                </div>
                
                <!-- Lista de repuestos disponibles -->
                <div id="repuestos-disponibles" class="mb-3">
                    <h6>📋 Repuestos Disponibles:</h6>
                    <div class="list-group" id="lista-repuestos-disponibles">
                        <!-- Los repuestos se cargarán aquí dinámicamente -->
                    </div>
                </div>
                
                <!-- Repuestos agregados al diagnóstico - Lista espejo -->
                <div class="mb-3">
                    <h6>✅ Repuestos Agregados al Diagnóstico:</h6>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> 
                        <strong>Lista Espejo:</strong> Los repuestos agregados aparecerán automáticamente en la lista de repuestos del diagnóstico.
                        <br><small>Esta sección es para buscar y agregar nuevos repuestos.</small>
                    </div>
                </div>
                
                <!-- Botón para agregar repuestos -->
                <div class="d-grid">
                    <button class="btn btn-success" onclick="agregarRepuestos()">
                        <i class="fas fa-plus"></i> Agregar Repuestos al Diagnóstico
                    </button>
                </div>
                
                <!-- Formulario oculto para enviar datos -->
                <form method="post" id="form-repuestos" style="display: none;">
                    {% csrf_token %}
                    <input type="hidden" name="repuestos_json" id="repuestos-json-diagnostico">
                </form>

                <!-- Lista de repuestos -->
                {% if diagnostico.repuestos.all %}
                    <div class="list-group">
                        {% for dr in diagnostico.repuestos.all %}
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>{{ dr.repuesto.nombre }}</strong>
                                    <br>
                                    <small class="text-muted">
                                        Cantidad: {{ dr.cantidad }} | 
                                        Precio: ${{ dr.precio_unitario|default:0|floatformat:0|intcomma }} | 
                                        Subtotal: ${{ dr.subtotal|default:0|floatformat:0|intcomma }}
                                    </small>
                                </div>
                                <div>
                                    <form method="post" style="display: inline;">
                                        {% csrf_token %}
                                        <button type="submit" name="quitar_repuesto" value="{{ dr.id }}" 
                                                class="btn btn-sm btn-outline-danger"
                                                onclick="return confirm('¿Quitar este repuesto del diagnóstico?')">
                                            🗑️ Quitar
                                        </button>
                                    </form>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> No hay repuestos registrados para este diagnóstico.
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Pestaña: Insumos -->
        <div id="tab-insumos" class="tab-content {% if active_tab == 'insumos' %}active{% endif %}">
            <div class="info-card">
                <h5>📦 Insumos del Diagnóstico</h5>
                
                <!-- Información del filtro amplio -->
                <div class="alert alert-warning mb-3">
                    <small>
                        <strong>🔍 Filtro Amplio:</strong> 
                        Aquí puedes agregar cualquier insumo del inventario sin restricciones de compatibilidad.
                        Filtro inicial: SKU que contenga 'xxxx' o 'zzzzzz'
                    </small>
                </div>
                
                <!-- Búsqueda de insumos -->
                <div class="mb-3">
                    <label for="buscar-insumo" class="form-label">🔍 Buscar Insumo:</label>
                    <div class="input-group">
                        <input type="text" id="buscar-insumo" class="form-control" placeholder="Buscar por nombre, SKU, código... (escribe para filtrar)">
                        <button class="btn btn-outline-primary" type="button" onclick="buscarInsumos()">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                    <small class="text-muted">La búsqueda se realiza automáticamente mientras escribes (mínimo 2 caracteres)</small>
                    <div class="mt-2">
                        <button class="btn btn-sm btn-outline-secondary" onclick="document.getElementById('buscar-insumo').value='aceite'; buscarInsumos();">Probar: aceite</button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="document.getElementById('buscar-insumo').value='xxxx'; buscarInsumos();">Probar: xxxx</button>
                    </div>
                </div>
                
                <!-- Lista de insumos disponibles -->
                <div id="insumos-disponibles" class="mb-3">
                    <h6>📋 Insumos Disponibles:</h6>
                    <div class="list-group" id="lista-insumos-disponibles">
                        <!-- Los insumos se cargarán aquí dinámicamente -->
                    </div>
                </div>
                
                <!-- Insumos agregados al diagnóstico - Lista espejo -->
                <div class="mb-3">
                    <h6>✅ Insumos Agregados al Diagnóstico:</h6>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> 
                        <strong>Lista Espejo:</strong> Los insumos agregados aparecerán automáticamente en la pestaña "Repuestos" del diagnóstico.
                        <br><small>Esta pestaña es para buscar y agregar nuevos insumos.</small>
                    </div>
                </div>
                
                <!-- Botón para agregar insumos -->
                <div class="d-grid">
                    <button class="btn btn-success" onclick="agregarInsumos()">
                        <i class="fas fa-plus"></i> Agregar Insumos al Diagnóstico
                    </button>
                </div>
                
                <!-- Formulario oculto para enviar datos -->
                <form method="post" id="form-insumos" style="display: none;">
                    {% csrf_token %}
                    <input type="hidden" name="insumos_json" id="insumos-json-diagnostico">
                </form>
            </div>
        </div>
    </div>

    <!-- Botones de Acción -->
    <div class="info-card">
        <h5>📄 Acciones Adicionales</h5>
        
        <a href="{% url 'lista_diagnosticos' %}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Volver a Diagnósticos
        </a>
        
        <a href="javascript:history.back()" class="btn btn-outline-secondary">
            ← Regresar
        </a>
    </div>
</div>

<!-- Punto de referencia para endpoints -->
<div id="acciones-endpoints" data-acciones-url-template="{% url 'acciones_por_componente' 0 %}"></div>

<script>
// ========================================
// FUNCIONES PARA PESTAÑAS
// ========================================

function showTab(tabName) {
    // Ocultar todas las pestañas
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Remover clase active de todos los botones
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Mostrar la pestaña seleccionada
    const selectedTab = document.getElementById(`tab-${tabName}`);
    if (selectedTab) {
        selectedTab.classList.add('active');
    }
    
    // Activar el botón correspondiente
    const selectedBtn = document.querySelector(`.tab-btn[onclick="showTab('${tabName}')"]`);
    if (selectedBtn) {
        selectedBtn.classList.add('active');
    }
    
    // Si es la pestaña de insumos, configurar búsqueda
    if (tabName === 'insumos') {
        setTimeout(() => {
            configurarBusquedaInsumos();
        }, 100);
    }
    
    // Si es la pestaña de repuestos, configurar búsqueda
    if (tabName === 'repuestos') {
        setTimeout(() => {
            configurarBusquedaRepuestos();
        }, 100);
    }
    
    // Si es la pestaña de acciones, configurar acordeón
    if (tabName === 'acciones') {
        setTimeout(() => {
            configurarAcordeonComponentes();
        }, 100);
    }
}

// ========================================
// FUNCIONES PARA INSUMOS
// ========================================

// Función para buscar insumos (con debounce para búsqueda en tiempo real)
let buscarInsumosTimeout;
window.buscarInsumos = async function() {
    console.log('🔍 buscarInsumos llamado');
    
    const buscarInput = document.getElementById('buscar-insumo');
    const cont = document.getElementById('lista-insumos-disponibles');
    
    if (!buscarInput) {
        console.error('❌ Input de búsqueda no encontrado');
        return;
    }
    
    if (!cont) {
        console.error('❌ Contenedor de resultados no encontrado');
        return;
    }
    
    const busqueda = buscarInput.value.trim();
    console.log('🔍 Término de búsqueda:', busqueda);
    
    if (busqueda.length < 2) {
        cont.innerHTML = '<div class="alert alert-info">Escribe al menos 2 caracteres para buscar</div>';
        return;
    }
    
    console.log('🔍 Buscando insumos con término:', busqueda);
    
    // Mostrar indicador de carga
    cont.innerHTML = '<div class="alert alert-info"><i class="fas fa-spinner fa-spin"></i> Buscando insumos...</div>';
    
    try {
        const url = `/car/repuestos/buscar-insumos/?q=${encodeURIComponent(busqueda)}`;
        console.log('🌐 URL de búsqueda:', url);
        
        const response = await fetch(url);
        console.log('📡 Respuesta del servidor:', response.status);
        
        const data = await response.json();
        console.log('📦 Datos recibidos:', data);
        
        if (data.insumos && data.insumos.length > 0) {
            console.log(`✅ Encontrados ${data.insumos.length} insumos`);
            cont.innerHTML = '';
            data.insumos.forEach((insumo, index) => {
                console.log(`📦 Procesando insumo ${index + 1}:`, insumo.nombre);
                const item = document.createElement('div');
                item.className = 'list-group-item d-flex justify-content-between align-items-center';
                item.innerHTML = `
                    <div class="form-check">
                        <input class="form-check-input insumo-check" type="checkbox" 
                               data-id="${insumo.id}" 
                               data-nombre="${escapeHtml(insumo.nombre)}"
                               data-precio="${insumo.precio || 0}"
                               data-stock="${insumo.stock || 0}">
                        <label class="form-check-label">
                            <strong>${escapeHtml(insumo.nombre)}</strong><br>
                            <small class="text-muted">
                                SKU: ${escapeHtml(insumo.sku || 'N/A')} | 
                                ${insumo.marca ? 'Marca: ' + escapeHtml(insumo.marca) + ' | ' : ''}
                                ${insumo.oem ? 'OEM: ' + escapeHtml(insumo.oem) + ' | ' : ''}
                                Precio: $${(insumo.precio || 0).toLocaleString()} | 
                                Stock: ${insumo.stock || 0}
                                ${insumo.deposito ? ' | Depósito: ' + escapeHtml(insumo.deposito) : ''}
                            </small>
                        </label>
                    </div>
                    <div class="input-group" style="width: 120px;">
                        <input type="number" class="form-control insumo-cantidad" 
                               data-id="${insumo.id}" value="1" min="1" max="${insumo.stock || 999}">
                    </div>
                `;
                cont.appendChild(item);
            });
        } else {
            console.log('ℹ️ No se encontraron insumos');
            cont.innerHTML = '<div class="alert alert-info">No se encontraron insumos con ese término de búsqueda</div>';
        }
        
    } catch (error) {
        console.error('❌ Error buscando insumos:', error);
        cont.innerHTML = '<div class="alert alert-danger">❌ Error buscando insumos: ' + error.message + '</div>';
    }
};

// Función con debounce para búsqueda en tiempo real
window.buscarInsumosDebounced = function() {
    clearTimeout(buscarInsumosTimeout);
    buscarInsumosTimeout = setTimeout(buscarInsumos, 300); // 300ms de delay
};

// Función para agregar insumos al diagnóstico
window.agregarInsumos = async function() {
    console.log('📦 agregarInsumos llamado');
    
    const insumos = [];
    document.querySelectorAll("#lista-insumos-disponibles input.insumo-check:checked").forEach(chk => {
        const cantidadInput = document.querySelector(
            `#lista-insumos-disponibles input.insumo-cantidad[data-id="${chk.dataset.id}"]`
        );
        const cantidad = cantidadInput ? parseInt(cantidadInput.value) || 1 : 1;
        insumos.push({
            id: chk.dataset.id,
            nombre: chk.dataset.nombre,
            cantidad: cantidad,
            precio_unitario: parseFloat(chk.dataset.precio) || 0
        });
    });
    
    console.log('📦 Insumos seleccionados:', insumos);
    
    if (insumos.length === 0) {
        alert('⚠️ No hay insumos seleccionados para agregar');
        return;
    }
    
    try {
        // Crear formulario para enviar datos
        const formData = new FormData();
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        formData.append('insumos_json', JSON.stringify(insumos));
        formData.append('agregar_insumos_multiples', 'true');
        
        const response = await fetch(window.location.href, {
            method: 'POST',
            body: formData
        });
        
        console.log('📡 Respuesta del servidor:', response);
        
        if (response.ok || response.status === 302) {
            console.log('✅ Insumos agregados exitosamente');
            alert('✅ Insumos agregados exitosamente');
            
            // Recargar la página manteniendo la pestaña de insumos activa
            window.location.href = window.location.pathname + '?tab=insumos';
        } else {
            console.error('❌ Error al agregar insumos:', response.status);
            alert('❌ Error al agregar los insumos');
        }
        
    } catch (error) {
        console.error('❌ Error en la petición:', error);
        alert('❌ Error al agregar los insumos');
    }
};

// Configurar búsqueda en tiempo real para insumos
function configurarBusquedaInsumos() {
    console.log('🔧 Configurando búsqueda de insumos...');
    const buscarInsumoInput = document.getElementById('buscar-insumo');
    
    if (buscarInsumoInput) {
        console.log('✅ Input de búsqueda encontrado');
        
        // Remover event listeners existentes
        buscarInsumoInput.removeEventListener('input', buscarInsumosDebounced);
        
        // Event listener para búsqueda en tiempo real
        buscarInsumoInput.addEventListener('input', function(e) {
            console.log('🔍 Input detectado:', e.target.value);
            buscarInsumosDebounced();
        });
        
        // Cargar insumos iniciales si estamos en la pestaña de insumos
        if (window.location.search.includes('tab=insumos')) {
            console.log('📦 Cargando insumos iniciales...');
            buscarInsumoInput.value = 'xxxx zzzzzz';
            buscarInsumos();
        }
    } else {
        console.log('❌ Input de búsqueda no encontrado');
    }
}

// Función helper para escapar HTML
function escapeHtml(text) {
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, function(m) { return map[m]; });
}

// ========================================
// FUNCIONES PARA REPUESTOS
// ========================================

// Función para buscar repuestos (con debounce para búsqueda en tiempo real)
let buscarRepuestosTimeout;
window.buscarRepuestos = async function() {
    console.log('🔍 buscarRepuestos llamado');
    
    const buscarInput = document.getElementById('buscar-repuesto');
    const cont = document.getElementById('lista-repuestos-disponibles');
    
    if (!buscarInput) {
        console.error('❌ Input de búsqueda no encontrado');
        return;
    }
    
    if (!cont) {
        console.error('❌ Contenedor de resultados no encontrado');
        return;
    }
    
    const busqueda = buscarInput.value.trim();
    console.log('🔍 Término de búsqueda:', busqueda);
    
    if (busqueda.length < 2) {
        cont.innerHTML = '<div class="alert alert-info">Escribe al menos 2 caracteres para buscar</div>';
        return;
    }
    
    console.log('🔍 Buscando repuestos con término:', busqueda);
    
    // Mostrar indicador de carga
    cont.innerHTML = '<div class="alert alert-info"><i class="fas fa-spinner fa-spin"></i> Buscando repuestos...</div>';
    
    try {
        const url = `/car/repuestos/buscar-insumos/?q=${encodeURIComponent(busqueda)}`;
        console.log('🌐 URL de búsqueda:', url);
        
        const response = await fetch(url);
        console.log('📡 Respuesta del servidor:', response.status);
        
        const data = await response.json();
        console.log('🔧 Datos recibidos:', data);
        
        if (data.insumos && data.insumos.length > 0) {
            console.log(`✅ Encontrados ${data.insumos.length} repuestos`);
            cont.innerHTML = '';
            data.insumos.forEach((repuesto, index) => {
                console.log(`🔧 Procesando repuesto ${index + 1}:`, repuesto.nombre);
                const item = document.createElement('div');
                item.className = 'list-group-item d-flex justify-content-between align-items-center';
                item.innerHTML = `
                    <div class="form-check">
                        <input class="form-check-input repuesto-check" type="checkbox" 
                               data-id="${repuesto.id}" 
                               data-nombre="${escapeHtml(repuesto.nombre)}"
                               data-precio="${repuesto.precio || 0}"
                               data-stock="${repuesto.stock || 0}">
                        <label class="form-check-label">
                            <strong>${escapeHtml(repuesto.nombre)}</strong><br>
                            <small class="text-muted">
                                SKU: ${escapeHtml(repuesto.sku || 'N/A')} | 
                                ${repuesto.marca ? 'Marca: ' + escapeHtml(repuesto.marca) + ' | ' : ''}
                                ${repuesto.oem ? 'OEM: ' + escapeHtml(repuesto.oem) + ' | ' : ''}
                                Precio: $${(repuesto.precio || 0).toLocaleString()} | 
                                Stock: ${repuesto.stock || 0}
                                ${repuesto.deposito ? ' | Depósito: ' + escapeHtml(repuesto.deposito) : ''}
                            </small>
                        </label>
                    </div>
                    <div class="input-group" style="width: 120px;">
                        <input type="number" class="form-control repuesto-cantidad" 
                               data-id="${repuesto.id}" value="1" min="1" max="${repuesto.stock || 999}">
                    </div>
                `;
                cont.appendChild(item);
            });
        } else {
            console.log('ℹ️ No se encontraron repuestos');
            cont.innerHTML = '<div class="alert alert-info">No se encontraron repuestos con ese término de búsqueda</div>';
        }
        
    } catch (error) {
        console.error('❌ Error buscando repuestos:', error);
        cont.innerHTML = '<div class="alert alert-danger">❌ Error buscando repuestos: ' + error.message + '</div>';
    }
};

// Función con debounce para búsqueda en tiempo real
window.buscarRepuestosDebounced = function() {
    clearTimeout(buscarRepuestosTimeout);
    buscarRepuestosTimeout = setTimeout(buscarRepuestos, 300); // 300ms de delay
};

// Función para agregar repuestos al diagnóstico
window.agregarRepuestos = async function() {
    console.log('🔧 agregarRepuestos llamado');
    
    const repuestos = [];
    document.querySelectorAll("#lista-repuestos-disponibles input.repuesto-check:checked").forEach(chk => {
        const cantidadInput = document.querySelector(
            `#lista-repuestos-disponibles input.repuesto-cantidad[data-id="${chk.dataset.id}"]`
        );
        const cantidad = cantidadInput ? parseInt(cantidadInput.value) || 1 : 1;
        repuestos.push({
            id: chk.dataset.id,
            nombre: chk.dataset.nombre,
            cantidad: cantidad,
            precio_unitario: parseFloat(chk.dataset.precio) || 0
        });
    });
    
    console.log('🔧 Repuestos seleccionados:', repuestos);
    
    if (repuestos.length === 0) {
        alert('⚠️ No hay repuestos seleccionados para agregar');
        return;
    }
    
    try {
        // Crear formulario para enviar datos
        const formData = new FormData();
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        formData.append('repuestos_json', JSON.stringify(repuestos));
        formData.append('agregar_repuestos_multiples', 'true');
        
        const response = await fetch(window.location.href, {
            method: 'POST',
            body: formData
        });
        
        console.log('📡 Respuesta del servidor:', response);
        
        if (response.ok || response.status === 302) {
            console.log('✅ Repuestos agregados exitosamente');
            alert('✅ Repuestos agregados exitosamente');
            
            // Recargar la página manteniendo la pestaña de repuestos activa
            window.location.href = window.location.pathname + '?tab=repuestos';
        } else {
            console.error('❌ Error al agregar repuestos:', response.status);
            alert('❌ Error al agregar los repuestos');
        }
        
    } catch (error) {
        console.error('❌ Error en la petición:', error);
        alert('❌ Error al agregar los repuestos');
    }
};

// Configurar búsqueda en tiempo real para repuestos
function configurarBusquedaRepuestos() {
    console.log('🔧 Configurando búsqueda de repuestos...');
    const buscarRepuestoInput = document.getElementById('buscar-repuesto');
    
    if (buscarRepuestoInput) {
        console.log('✅ Input de búsqueda encontrado');
        
        // Remover event listeners existentes
        buscarRepuestoInput.removeEventListener('input', buscarRepuestosDebounced);
        
        // Event listener para búsqueda en tiempo real
        buscarRepuestoInput.addEventListener('input', function(e) {
            console.log('🔍 Input detectado:', e.target.value);
            buscarRepuestosDebounced();
        });
        
        // Cargar repuestos iniciales si estamos en la pestaña de repuestos
        if (window.location.search.includes('tab=repuestos')) {
            console.log('🔧 Cargando repuestos iniciales...');
            buscarRepuestoInput.value = 'filtro';
            buscarRepuestos();
        }
    } else {
        console.log('❌ Input de búsqueda no encontrado');
    }
}

// ========================================
// FUNCIONES PARA ACORDEÓN DE COMPONENTES
// ========================================

// Función para manejar la selección de componentes
function configurarAcordeonComponentes() {
    console.log('🔧 Configurando acordeón de componentes...');
    
    // Event listener para checkboxes de componentes
    document.querySelectorAll('.componente-check').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            if (this.checked) {
                // Desmarcar otros componentes
                document.querySelectorAll('.componente-check').forEach(other => {
                    if (other !== this) {
                        other.checked = false;
                    }
                });
                
                // Actualizar el campo de componente seleccionado
                const componenteNombre = this.dataset.nombre;
                const componenteId = this.value;
                const componentePadre = this.dataset.padre;
                
                document.getElementById('componente-seleccionado').value = `${componentePadre} - ${componenteNombre}`;
                document.getElementById('componente-id').value = componenteId;
                
                console.log(`✅ Componente seleccionado: ${componenteNombre} (ID: ${componenteId})`);
                
                // Cargar acciones para este componente
                cargarAccionesParaComponente(componenteId);
            } else {
                // Si se desmarca, limpiar la selección
                document.getElementById('componente-seleccionado').value = '';
                document.getElementById('componente-id').value = '';
                document.getElementById('acciones-disponibles').style.display = 'none';
                console.log('❌ Componente deseleccionado');
            }
        });
    });
    
    console.log('✅ Acordeón de componentes configurado');
}

// Función para cargar acciones de un componente
async function cargarAccionesParaComponente(componenteId) {
    console.log(`🔍 Cargando acciones para componente ID: ${componenteId}`);
    
    const contenedorAcciones = document.getElementById('acciones-disponibles');
    const listaAcciones = document.getElementById('lista-acciones-componente');
    
    // Mostrar contenedor de acciones
    contenedorAcciones.style.display = 'block';
    
    // Mostrar indicador de carga
    listaAcciones.innerHTML = '<div class="alert alert-info"><i class="fas fa-spinner fa-spin"></i> Cargando acciones...</div>';
    
    try {
        const url = `/car/acciones-lookup/${componenteId}/`;
        console.log('🌐 URL de acciones:', url);
        
        const response = await fetch(url);
        console.log('📡 Respuesta del servidor:', response.status);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('🛠️ Datos de acciones recibidos:', data);
        
        // Verificar si hay acciones disponibles
        if (data && data.ok && data.acciones && Array.isArray(data.acciones) && data.acciones.length > 0) {
            console.log(`✅ Encontradas ${data.acciones.length} acciones`);
            listaAcciones.innerHTML = '';
            
            data.acciones.forEach((accion, index) => {
                console.log(`🛠️ Procesando acción ${index + 1}:`, accion);
                
                // Validar datos de la acción
                const accionId = accion.id || '';
                const accionNombre = accion.accion_nombre || accion.nombre || 'Sin nombre';
                const accionPrecio = parseFloat(accion.precio_base || 0);
                
                console.log(`🛠️ Acción procesada - ID: ${accionId}, Nombre: ${accionNombre}, Precio: ${accionPrecio}`);
                
                const item = document.createElement('div');
                item.className = 'list-group-item d-flex justify-content-between align-items-center';
                item.innerHTML = `
                    <div class="form-check">
                        <input class="form-check-input accion-check" type="checkbox" 
                               data-id="${accionId}" 
                               data-nombre="${accionNombre.replace(/"/g, '&quot;')}"
                               data-precio="${accionPrecio}"
                               id="accion-${accionId}">
                        <label class="form-check-label" for="accion-${accionId}">
                            <strong>${accionNombre}</strong>
                            ${accionPrecio > 0 ? `<br><small class="text-muted">Precio base: $${accionPrecio.toLocaleString()}</small>` : ''}
                        </label>
                    </div>
                    <div class="text-end">
                        <span class="badge bg-primary">$${accionPrecio.toLocaleString()}</span>
                    </div>
                `;
                listaAcciones.appendChild(item);
            });
            
            // Configurar event listeners para las acciones
            configurarAccionesComponente();
            
        } else if (data && !data.ok && data.mensaje) {
            console.log('ℹ️ Mensaje del servidor:', data.mensaje);
            listaAcciones.innerHTML = `<div class="alert alert-warning">${data.mensaje}</div>`;
        } else {
            console.log('ℹ️ No se encontraron acciones para este componente');
            listaAcciones.innerHTML = '<div class="alert alert-info">No hay acciones disponibles para este componente.</div>';
        }
        
    } catch (error) {
        console.error('❌ Error cargando acciones:', error);
        listaAcciones.innerHTML = '<div class="alert alert-danger">❌ Error cargando acciones: ' + error.message + '</div>';
    }
}

// Función para configurar los event listeners de las acciones
function configurarAccionesComponente() {
    console.log('🔧 Configurando acciones del componente...');
    
    // Event listener para checkboxes de acciones
    document.querySelectorAll('.accion-check').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            calcularTotalManoObra();
            
            // Auto-rellenar el precio cuando se selecciona una acción
            if (this.checked) {
                const precio = parseFloat(this.dataset.precio) || 0;
                const precioInput = document.getElementById('precio_mano_obra');
                if (precioInput && precio > 0) {
                    precioInput.value = precio;
                    console.log(`💰 Precio auto-rellenado: $${precio}`);
                }
            }
        });
    });
    
    console.log('✅ Acciones del componente configuradas');
}

// Función para calcular el total de mano de obra
function calcularTotalManoObra() {
    let total = 0;
    
    document.querySelectorAll('.accion-check:checked').forEach(checkbox => {
        const precio = parseFloat(checkbox.dataset.precio) || 0;
        total += precio;
    });
    
    document.getElementById('total-mano-obra').textContent = `$${total.toLocaleString()}`;
    console.log(`💰 Total mano de obra: $${total.toLocaleString()}`);
}

// Función para agregar las acciones seleccionadas
async function agregarAccionesSeleccionadas() {
    console.log('🛠️ Agregando acciones seleccionadas...');
    
    const acciones = [];
    document.querySelectorAll('.accion-check:checked').forEach(checkbox => {
        const precio = parseFloat(checkbox.dataset.precio) || 0;
        acciones.push({
            id: checkbox.dataset.id,
            nombre: checkbox.dataset.nombre,
            precio: precio
        });
    });
    
    console.log('🛠️ Acciones seleccionadas:', acciones);
    
    if (acciones.length === 0) {
        alert('⚠️ No hay acciones seleccionadas para agregar');
        return;
    }
    
    try {
        // Obtener el componente seleccionado
        const componenteId = document.getElementById('componente-id').value;
        if (!componenteId) {
            alert('⚠️ Debe seleccionar un componente primero');
            return;
        }
        
        // Crear formulario para enviar datos
        const formData = new FormData();
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        formData.append('acciones_json', JSON.stringify(acciones));
        formData.append('componente', componenteId);
        formData.append('agregar_acciones_multiples', 'true');
        
        console.log('📤 Enviando datos:', {
            acciones: acciones,
            componente: componenteId,
            csrf: document.querySelector('[name=csrfmiddlewaretoken]').value
        });
        
        const response = await fetch(window.location.href, {
            method: 'POST',
            body: formData
        });
        
        console.log('📡 Respuesta del servidor:', response.status, response.statusText);
        
        if (response.ok || response.status === 302) {
            console.log('✅ Acciones agregadas exitosamente');
            alert('✅ Acciones agregadas exitosamente');
            
            // Recargar la página manteniendo la pestaña de acciones activa
            window.location.href = window.location.pathname + '?tab=acciones';
        } else {
            console.error('❌ Error al agregar acciones:', response.status);
            const errorText = await response.text();
            console.error('❌ Detalles del error:', errorText);
            alert('❌ Error al agregar las acciones: ' + response.status);
        }
        
    } catch (error) {
        console.error('❌ Error en la petición:', error);
        alert('❌ Error al agregar las acciones');
    }
}

// Función de debug para verificar el estado
function debugAcciones() {
    console.log('🔍 DEBUG - Estado actual:');
    console.log('📋 Componente seleccionado:', document.getElementById('componente-seleccionado').value);
    console.log('📋 Componente ID:', document.getElementById('componente-id').value);
    
    const accionesSeleccionadas = [];
    document.querySelectorAll('.accion-check:checked').forEach(checkbox => {
        accionesSeleccionadas.push({
            id: checkbox.dataset.id,
            nombre: checkbox.dataset.nombre,
            precio: checkbox.dataset.precio
        });
    });
    
    console.log('📋 Acciones seleccionadas:', accionesSeleccionadas);
    console.log('📋 Total acciones disponibles:', document.querySelectorAll('.accion-check').length);
    console.log('📋 URL actual:', window.location.href);
    
    alert(`Debug:\nComponente: ${document.getElementById('componente-seleccionado').value}\nAcciones seleccionadas: ${accionesSeleccionadas.length}`);
}

// Cargar cuando el DOM esté listo
document.addEventListener('DOMContentLoaded', function() {
    // Configurar acordeón de componentes
    configurarAcordeonComponentes();
    
    // Configurar búsqueda de insumos si estamos en la pestaña correspondiente
    if (window.location.search.includes('tab=insumos')) {
        setTimeout(configurarBusquedaInsumos, 100);
    }
    
    // Configurar búsqueda de repuestos si estamos en la pestaña correspondiente
    if (window.location.search.includes('tab=repuestos')) {
        setTimeout(configurarBusquedaRepuestos, 100);
    }
});
</script>
{% endblock %}
