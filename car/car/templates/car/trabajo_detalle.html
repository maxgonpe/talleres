{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container mt-4">
  <h2>🔧 Trabajo #{{ trabajo.id }} - {{ trabajo.vehiculo }}</h2>
  <p><strong>Estado actual:</strong> 
    <span class="badge 
      {% if trabajo.estado == 'iniciado' %}bg-warning
      {% elif trabajo.estado == 'trabajando' %}bg-primary
      {% elif trabajo.estado == 'completado' %}bg-success
      {% elif trabajo.estado == 'entregado' %}bg-dark
      {% else %}bg-info{% endif %}">
      {% if trabajo.estado == 'iniciado' %}🟡 Iniciado
      {% elif trabajo.estado == 'trabajando' %}🔵 Trabajando
      {% elif trabajo.estado == 'completado' %}🟢 Completado
      {% elif trabajo.estado == 'entregado' %}⚫ Entregado
      {% else %}{{ trabajo.get_estado_display }}{% endif %}
    </span>
  </p>
  <p><strong>Observaciones:</strong> {{ trabajo.observaciones|default:"-" }}</p>

  <hr>

  <!-- Mecánicos -->
  <h4>👷 Mecánicos asignados</h4>
  {% if trabajo.mecanicos.exists %}
    <ul>
      {% for mec in trabajo.mecanicos.all %}
        <li>{{ mec.user.get_full_name|default:mec.user.first_name }} ({{ mec.especialidad|default:"-" }})</li>
      {% endfor %}
    </ul>
  {% else %}
    <p>No hay mecánicos asignados.</p>
  {% endif %}

  <form method="post">
    {% csrf_token %}
    {{ asignar_form.as_p }}
    <button type="submit" name="asignar_mecanicos" class="btn btn-primary">Asignar Mecánicos</button>
  </form>

  <hr>

  <!-- Acciones -->
  <h4>🛠️ Acciones</h4>
  <form method="post">
    {% csrf_token %}
    <ul class="list-group">
      {% for acc in trabajo.acciones.all %}
        <li class="list-group-item d-flex justify-content-between align-items-center">
          {{ acc.accion.nombre }} - {{ acc.componente.nombre }}
          <div>
            {% if acc.completado %}
              <span class="badge bg-success">✔️ Completado</span>
              <small class="text-muted">{{ acc.fecha|date:"d/m/Y H:i" }}</small>
            {% endif %}
            <button type="submit" name="accion_toggle" value="{{ acc.id }}" 
                    class="btn btn-sm {% if acc.completado %}btn-outline-danger{% else %}btn-outline-success{% endif %}">
              {% if acc.completado %}Desmarcar{% else %}Marcar{% endif %}
            </button>
          </div>
        </li>
      {% empty %}
        <li class="list-group-item">No hay acciones registradas</li>
      {% endfor %}
    </ul>
  </form>

  <hr>

  <!-- Repuestos -->
  <h4>⚙️ Repuestos</h4>
  <form method="post">
    {% csrf_token %}
    <ul class="list-group">
      {% for rep in trabajo.repuestos.all %}
        <li class="list-group-item d-flex justify-content-between align-items-center">
          {{ rep.repuesto.nombre }} (x{{ rep.cantidad }}) - ${{ rep.subtotal }}
          <div>
            {% if rep.completado %}
              <span class="badge bg-success">✔️ Instalado</span>
              <small class="text-muted">{{ rep.fecha|date:"d/m/Y H:i" }}</small>
            {% endif %}
            <button type="submit" name="repuesto_toggle" value="{{ rep.id }}" 
                    class="btn btn-sm {% if rep.completado %}btn-outline-danger{% else %}btn-outline-primary{% endif %}">
              {% if rep.completado %}Desmarcar{% else %}Marcar Instalado{% endif %}
            </button>
          </div>
        </li>
      {% empty %}
        <li class="list-group-item">No hay repuestos registrados</li>
      {% endfor %}
    </ul>
  </form>

  <hr>

  <!-- Fotos -->
  <h4>📷 Fotos del proceso</h4>
  <div class="row">
    {% for foto in trabajo.fotos.all %}
      <div class="col-md-4 mb-3">
        <div class="card shadow-sm">
          <img src="{{ foto.imagen.url }}" class="card-img-top img-fluid rounded">
          <div class="card-body">
            <p class="card-text small">{{ foto.descripcion|default:"(Sin descripción)" }}</p>
            <p class="text-muted small">{{ foto.fecha|date:"d/m/Y H:i" }}</p>
          </div>
        </div>
      </div>
    {% empty %}
      <p>No hay fotos todavía.</p>
    {% endfor %}
  </div>

  <form method="post" enctype="multipart/form-data" class="mt-3">
    {% csrf_token %}
    {{ foto_form.as_p }}
    <button type="submit" name="subir_foto" class="btn btn-secondary">Subir Foto</button>
  </form>

  <hr>

  <!-- Totales -->
  <h4>📊 Totales</h4>
  <ul>
    <li>💵 Mano de obra: ${{ trabajo.total_mano_obra }}</li>
    <li>⚙️ Repuestos: ${{ trabajo.total_repuestos }}</li>
    <li><strong>Total general:</strong> ${{ trabajo.total_general }}</li>
  </ul>

  <hr>

  <!-- Botones de estado -->
  <h4>🔄 Cambiar Estado del Trabajo</h4>
  <p class="text-muted">Haz clic en el estado al que quieres cambiar este trabajo:</p>
  <form method="post">
    {% csrf_token %}
    <div class="row g-2">
      <div class="col-md-3">
        <button type="submit" name="cambiar_estado" value="iniciado" 
                class="btn w-100 {% if trabajo.estado == 'iniciado' %}btn-warning{% else %}btn-outline-warning{% endif %}">
          🟡 Iniciado
        </button>
      </div>
      <div class="col-md-3">
        <button type="submit" name="cambiar_estado" value="trabajando" 
                class="btn w-100 {% if trabajo.estado == 'trabajando' %}btn-primary{% else %}btn-outline-primary{% endif %}">
          🔵 Trabajando
        </button>
      </div>
      <div class="col-md-3">
        <button type="submit" name="cambiar_estado" value="completado" 
                class="btn w-100 {% if trabajo.estado == 'completado' %}btn-success{% else %}btn-outline-success{% endif %}">
          🟢 Completado
        </button>
      </div>
      <div class="col-md-3">
        <button type="submit" name="cambiar_estado" value="entregado" 
                class="btn w-100 {% if trabajo.estado == 'entregado' %}btn-dark{% else %}btn-outline-dark{% endif %}">
          ⚫ Entregado
        </button>
      </div>
    </div>
    <div class="mt-3">
      <a href="{% url 'panel_principal' %}" class="btn btn-secondary">🏠 Volver a la Pizarra</a>
      <a href="javascript:history.back()" class="btn btn-outline-secondary">← Regresar</a>
    </div>
  </form>
</div>
{% endblock %}
