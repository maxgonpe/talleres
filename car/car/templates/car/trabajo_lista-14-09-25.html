{% extends 'base.html' %}
{% load humanize %}
{% block content %}
<h2>Trabajosx</h2>

<input type="text" id="filterInput" class="form-control my-2" placeholder="Buscar por vehÃ­culo, cliente, telÃ©fono, trabajo, partes...">

{% for trabajo in trabajos %}
<div class="card mb-3">
  <div class="card-body">
    <strong>VehÃ­culo:</strong> {{ trabajo.vehiculo }}<br>
    <strong>VIN:</strong> <strong style="color: red;">{{ trabajo.vehiculo.vin }}</strong><br>
    <strong>Cliente:</strong> {{ trabajo.vehiculo.cliente.nombre }}<br>
    <strong>TelÃ©fono:</strong> {{ trabajo.vehiculo.cliente.telefono }}<br>

    <!-- Partes Afectadas -->
    <strong>Partes Afectadas:</strong> 
    {% with trabajo.acciones_componentes.all as acciones %}
      {% if acciones %}
        {% for tca in acciones %}
          {{ tca.componente.nombre }}{% if not forloop.last %}, {% endif %}
        {% endfor %}
      {% else %}
        Ninguno
      {% endif %}
    {% endwith %}
    <br>

    <!-- Acciones -->
    <strong>Acciones realizadas:</strong><br>
    {% if trabajo.acciones_componentes.all %}
      <ul class="list-group list-group-flush my-2">
        {% for tca in trabajo.acciones_componentes.all %}
          <li class="list-group-item d-flex justify-content-between align-items-center">
            <span>
              <strong>{{ tca.componente.nombre }}</strong> â€” {{ tca.accion.nombre }}
            </span>
            <span class="badge bg-primary rounded-pill">
              ${{ tca.precio_mano_obra|default:0|floatformat:0|intcomma }}
            </span>
          </li>
        {% endfor %}
      </ul>
      <div class="text-end fw-bold">
        Total mano de obra: ${{ trabajo.total_mano_obra|default:0|floatformat:0|intcomma }}
      </div>
    {% else %}
      <span class="text-muted">No se registraron acciones</span>
    {% endif %}

    <!-- Repuestos -->
    <strong>Repuestos utilizados:</strong><br>
    {% if trabajo.repuestos.all %}
      <ul class="list-group list-group-flush my-2">
        {% for tr in trabajo.repuestos.all %}
          <li class="list-group-item d-flex justify-content-between align-items-center">
            <span>
              <strong>{{ tr.repuesto.nombre }}</strong> (x{{ tr.cantidad }})
            </span>
            <span class="badge bg-primary rounded-pill">
              ${{ tr.subtotal|default:0|floatformat:0|intcomma }}
            </span>
          </li>
        {% endfor %}
      </ul>
      <div class="text-end fw-bold">
        Total repuestos: ${{ trabajo.total_repuestos|default:0|floatformat:0|intcomma }}
      </div>
    {% else %}
      <span class="text-muted">No se registraron repuestos</span>
    {% endif %}

    <!-- Total Presupuesto -->
    <div class="text-end fw-bold mt-2 text-success">
      ðŸ’° Total presupuesto:
      ${{ trabajo.total_presupuesto|default:0|floatformat:0|intcomma }}
    </div>

    <strong>Fecha Inicio:</strong> {{ trabajo.fecha_inicio }}<br>

    <!-- Botones -->
    <a href="" class="btn btn-success btn-sm mt-2">Excel</a>
    <a href="" class="btn btn-danger btn-sm mt-2">PDF</a>
    <a href="{% url 'trabajo_detalle' trabajo.pk %}" class="btn btn-secondary btn-sm mt-2">Editar</a>
    <a href="#" class="btn btn-danger btn-sm mt-2">Eliminar</a>
    <a href="{% url 'panel_principal' %}" class="btn btn-warning btn-sm mt-2">Regresar</a>
  </div>
</div>
{% empty %}
<p>No hay trabajos registrados.</p>
{% endfor %}

<script>
document.addEventListener('DOMContentLoaded', function () {
  const filterInput = document.getElementById('filterInput');
  const cards = document.querySelectorAll('.card');
  filterInput.addEventListener('keyup', function () {
    const filterValue = filterInput.value.toLowerCase();
    cards.forEach(function (card) {
      const text = card.textContent.toLowerCase();
      card.style.display = text.includes(filterValue) ? 'block' : 'none';
    });
  });
});
</script>
{% endblock %}
