{% extends "base.html" %}
{% load static %}

{% block title %}üìå Bookmarklet - Extractor de Repuestos{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- Header -->
            <div class="text-center mb-5">
                <h1 class="display-4">üîñ Extractor M√°gico de Repuestos</h1>
                <p class="lead text-muted">
                    Arrastra el bot√≥n a tus marcadores y extrae datos de productos con un solo click
                </p>
            </div>

            <!-- Instrucciones -->
            <div class="card shadow-lg mb-4">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0">üìã Instrucciones - Solo 2 pasos</h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="p-4 bg-light rounded mb-3">
                                <h4 class="text-primary">Paso 1Ô∏è‚É£ - Instalaci√≥n (Una sola vez)</h4>
                                <p>Arrastra este bot√≥n a tu <strong>barra de marcadores</strong>:</p>
                                
                                <div class="text-center p-4 bg-white border border-primary rounded">
                                    <a href="#" 
                                       id="bookmarkletLink"
                                       draggable="true"
                                       class="btn btn-lg btn-success px-5 py-3 d-inline-block"
                                       style="cursor: move; font-size: 1.2rem; font-weight: bold; user-select: none; -webkit-user-drag: element;"
                                       onmousedown="event.preventDefault(); return false;">
                                        üîñ Arr√°strame a Marcadores
                                    </a>
                                </div>
                                
                                <div class="alert alert-success mt-3" id="urlInfo">
                                    <strong>‚úÖ Este bookmarklet est√° configurado para:</strong><br>
                                    <code id="currentURL"></code>
                                </div>
                                
                                <!-- Instrucciones para m√≥vil -->
                                <div class="alert alert-warning mt-3 d-block d-md-none" id="instruccionesMovil">
                                    <strong>üì± Instrucciones para M√ìVIL:</strong>
                                    <ol class="mb-2 mt-2">
                                        <li>Click en el bot√≥n de abajo para copiar el c√≥digo</li>
                                        <li>Ve a Mundo Repuestos o AutoPlanet en tu navegador</li>
                                        <li>Guarda esa p√°gina en marcadores</li>
                                        <li>Edita el marcador y pega el c√≥digo copiado en la URL</li>
                                        <li>Guarda y usa el marcador desde cualquier producto</li>
                                    </ol>
                                    <button class="btn btn-lg btn-success w-100 mt-2" onclick="copiarBookmarklet()">
                                        üìã Copiar C√≥digo para M√≥vil
                                    </button>
                                    <small class="d-block mt-2 text-muted">
                                        <strong>Navegadores recomendados:</strong><br>
                                        ‚Ä¢ Safari (iOS) - ‚úÖ Funciona<br>
                                        ‚Ä¢ Firefox (Android) - ‚úÖ Funciona<br>
                                        ‚Ä¢ Chrome (Android) - ‚ö†Ô∏è Limitado
                                    </small>
                                </div>
                                
                                <!-- Instrucciones para desktop -->
                                <div class="alert alert-info mt-3 d-none d-md-block" id="copiarAlternativa">
                                    <strong>üí° Alternativa si no puedes arrastrar:</strong>
                                    <button class="btn btn-sm btn-primary mt-2" onclick="copiarBookmarklet()">
                                        üìã Copiar c√≥digo al portapapeles
                                    </button>
                                    <small class="d-block mt-2">Luego crea un marcador manualmente y pega el c√≥digo copiado en la URL del marcador</small>
                                </div>
                                
                                <div class="alert alert-info mt-3 d-none d-md-block">
                                    <strong>üí° Tip:</strong> Si no tienes visible la barra de marcadores:
                                    <ul class="mb-0 mt-2">
                                        <li><strong>Chrome:</strong> Ctrl+Shift+B</li>
                                        <li><strong>Firefox:</strong> Ctrl+Shift+B</li>
                                        <li><strong>Safari:</strong> Cmd+Shift+B</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="p-4 bg-light rounded">
                                <h4 class="text-success">Paso 2Ô∏è‚É£ - Uso diario</h4>
                                <ol class="mb-0">
                                    <li>Busca el repuesto en <strong>Mundo Repuestos</strong> o <strong>AutoPlanet</strong></li>
                                    <li>Entra a la p√°gina del producto espec√≠fico</li>
                                    <li><strong>Click en el marcador</strong> que arrastraste</li>
                                    <li>‚ú® ¬°Se abre autom√°ticamente el formulario con los datos!</li>
                                    <li>Verifica que todo est√© correcto</li>
                                    <li>Click en "Guardar"</li>
                                </ol>
                                
                                <div class="alert alert-success mt-3">
                                    <strong>‚úÖ Listo!</strong> La referencia queda guardada para siempre.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Video/GIF demo -->
            <div class="card shadow mb-4">
                <div class="card-header bg-info text-white">
                    <h3 class="mb-0">üé¨ Demo Visual</h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4 text-center mb-3">
                            <div class="p-3 border rounded">
                                <div class="display-1">1Ô∏è‚É£</div>
                                <h5>Arrastra el bot√≥n</h5>
                                <p class="text-muted small">A tu barra de marcadores</p>
                            </div>
                        </div>
                        <div class="col-md-4 text-center mb-3">
                            <div class="p-3 border rounded">
                                <div class="display-1">2Ô∏è‚É£</div>
                                <h5>Busca el producto</h5>
                                <p class="text-muted small">En Mundo Repuestos o AutoPlanet</p>
                            </div>
                        </div>
                        <div class="col-md-4 text-center mb-3">
                            <div class="p-3 border rounded">
                                <div class="display-1">‚ú®</div>
                                <h5>Click en marcador</h5>
                                <p class="text-muted small">¬°Datos extra√≠dos autom√°ticamente!</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- FAQ -->
            <div class="card shadow">
                <div class="card-header bg-warning">
                    <h3 class="mb-0">‚ùì Preguntas Frecuentes</h3>
                </div>
                <div class="card-body">
                    <div class="accordion" id="faqAccordion">
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#faq1">
                                    ¬øFunciona en el tel√©fono?
                                </button>
                            </h2>
                            <div id="faq1" class="accordion-collapse collapse show" data-bs-parent="#faqAccordion">
                                <div class="accordion-body">
                                    <strong>S√≠, pero es m√°s f√°cil en PC/laptop.</strong> En m√≥vil, los bookmarklets son m√°s dif√≠ciles de usar.
                                    Para m√≥vil, recomendamos copiar manualmente (solo 4 campos, toma 30 segundos).
                                </div>
                            </div>
                        </div>
                        
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq2">
                                    ¬øEs seguro?
                                </button>
                            </h2>
                            <div id="faq2" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                                <div class="accordion-body">
                                    <strong>100% seguro.</strong> El bookmarklet solo lee informaci√≥n de la p√°gina que est√°s viendo.
                                    No tiene acceso a contrase√±as ni datos sensibles. El c√≥digo es visible y open-source.
                                </div>
                            </div>
                        </div>
                        
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq3">
                                    ¬øQu√© pasa si no extrae todos los datos?
                                </button>
                            </h2>
                            <div id="faq3" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                                <div class="accordion-body">
                                    <strong>No hay problema.</strong> El bookmarklet extrae lo que puede. Si falta algo (marca, c√≥digo),
                                    simplemente lo completas manualmente en el formulario. El nombre y precio casi siempre se extraen correctamente.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Volver -->
            <div class="text-center mt-4">
                <a href="{% url 'panel_principal' %}" class="btn btn-secondary">
                    ‚Üê Volver al Panel Principal
                </a>
            </div>
        </div>
    </div>
</div>

<style>
.card {
    border: none;
    border-radius: 15px;
}

.card-header {
    border-radius: 15px 15px 0 0 !important;
}

@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
}

.btn-success:hover {
    animation: pulse 1s infinite;
}

#bookmarkletLink {
    text-decoration: none;
}

#bookmarkletLink:active {
    opacity: 0.8;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Funci√≥n para detectar el dominio base
    function obtenerDominioBase() {
        const hostname = window.location.hostname;
        const protocol = window.location.protocol;
        
        // Detectar si es un subdominio de .netgogo.cl
        if (hostname.endsWith('.netgogo.cl') || hostname === 'netgogo.cl') {
            // Si es subdominio, mantener el subdominio completo
            return `${protocol}//${hostname}`;
        }
        
        // Fallback: usar el dominio actual
        return `${protocol}//${hostname}`;
    }
    
    // Obtener dominio base
    const dominioBase = obtenerDominioBase();
    
    // Mostrar URL configurada
    document.getElementById('currentURL').textContent = dominioBase;
    
    // Generar c√≥digo del bookmarklet
    const bookmarkletCode = `javascript:(function(){const url=window.location.href;let datos={nombre:'',precio:0,marca:'',codigo:'',url:url};const title=document.querySelector('meta[property="og:title"]')?.content||document.querySelector('title')?.innerText||'';datos.nombre=title.substring(0,200);const jsonLD=document.querySelector('script[type="application/ld+json"]');if(jsonLD){try{const ld=JSON.parse(jsonLD.textContent);datos.nombre=ld.name||datos.nombre;if(ld.offers?.price){datos.precio=parseInt(ld.offers.price.toString().replace(/[^\\d]/g,''))||0;}if(ld.brand){datos.marca=typeof ld.brand==='object'?ld.brand.name:ld.brand;}datos.codigo=ld.sku||ld.mpn||'';}catch(e){}}const priceElems=document.querySelectorAll('[class*="price"],[class*="precio"],[itemprop="price"]');for(const elem of priceElems){const txt=elem.textContent;const nums=txt.match(/\\d+/g);if(nums&&nums.length>0){datos.precio=parseInt(nums.join(''));break;}}const brandElems=document.querySelectorAll('[class*="brand"],[class*="marca"],[itemprop="brand"]');for(const elem of brandElems){const txt=elem.textContent.trim();if(txt&&txt.length<50){datos.marca=txt;break;}}const skuElems=document.querySelectorAll('[class*="sku"],[class*="codigo"],[itemprop="sku"]');for(const elem of skuElems){const txt=elem.textContent.trim();if(txt&&txt.length<50){datos.codigo=txt;break;}}const proveedor=url.includes('mundorepuestos')?'mundo_repuestos':url.includes('autoplanet')?'autoplanet':'otro';const params=new URLSearchParams({nombre:datos.nombre,precio:datos.precio,marca:datos.marca,codigo:datos.codigo,proveedor:proveedor,url_producto:url});window.open('${dominioBase}/car/api/repuestos-externos/agregar-rapido/?'+params.toString(),'_blank');})();`;
    
    // Configurar el enlace del bookmarklet
    const bookmarkletLink = document.getElementById('bookmarkletLink');
    bookmarkletLink.href = bookmarkletCode;
    
    // Hacer el bot√≥n arrastrable
    bookmarkletLink.addEventListener('dragstart', function(e) {
        // Guardar el c√≥digo del bookmarklet en el evento drag
        e.dataTransfer.setData('text/plain', bookmarkletCode);
        e.dataTransfer.setData('text/uri-list', bookmarkletCode);
        
        // Mostrar informaci√≥n durante el arrastre
        this.style.opacity = '0.5';
    });
    
    bookmarkletLink.addEventListener('dragend', function(e) {
        this.style.opacity = '1';
    });
    
    // Detectar si el navegador soporta drag and drop de bookmarklets
    setTimeout(function() {
        // Si despu√©s de 2 segundos el usuario no ha arrastrado, mostrar fallback
        const hasDragged = false;
        // No forzamos el fallback, solo lo dejamos disponible
    }, 2000);
    
    // Guardar c√≥digo globalmente para la funci√≥n de copiar
    window.bookmarkletCode = bookmarkletCode;
});

// Detectar si es m√≥vil
function esMovil() {
    return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
}

// Funci√≥n para copiar el bookmarklet al portapapeles
function copiarBookmarklet() {
    if (!window.bookmarkletCode) {
        alert('‚ùå Error: El c√≥digo del bookmarklet no est√° disponible');
        return;
    }
    
    // Instrucciones espec√≠ficas para m√≥vil
    const instruccionesMovil = esMovil() ? 
        '‚úÖ ¬°C√≥digo copiado!\n\nüì± PASOS PARA M√ìVIL:\n\n1. Ve a Mundo Repuestos o AutoPlanet\n2. Guarda esa p√°gina como marcador\n3. Edita el marcador guardado\n4. Reemplaza la URL con el c√≥digo copiado\n5. Guarda y √∫salo desde cualquier producto\n\nüí° Safari (iOS) y Firefox (Android) funcionan mejor.' :
        '‚úÖ ¬°C√≥digo copiado al portapapeles!\n\nAhora:\n1. Crea un nuevo marcador\n2. Pega este c√≥digo en la URL del marcador\n3. ¬°Listo!';
    
    // Intentar usar la API moderna del portapapeles
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(window.bookmarkletCode).then(function() {
            actualizarEstadoCopiado();
            alert(instruccionesMovil);
        }).catch(function(err) {
            // Fallback: usar m√©todo antiguo
            copiarFallback(instruccionesMovil);
        });
    } else {
        copiarFallback(instruccionesMovil);
    }
}

// M√©todo alternativo para copiar (fallback)
function copiarFallback(instrucciones) {
    const textarea = document.createElement('textarea');
    textarea.value = window.bookmarkletCode;
    textarea.style.position = 'fixed';
    textarea.style.opacity = '0';
    document.body.appendChild(textarea);
    textarea.select();
    
    try {
        const successful = document.execCommand('copy');
        if (successful) {
            actualizarEstadoCopiado();
            alert(instrucciones || '‚úÖ ¬°C√≥digo copiado al portapapeles!');
        } else {
            alert('‚ö†Ô∏è No se pudo copiar autom√°ticamente. Selecciona y copia manualmente el c√≥digo de abajo.');
            mostrarCodigoCompleto();
        }
    } catch (err) {
        alert('‚ö†Ô∏è No se pudo copiar autom√°ticamente. Selecciona y copia manualmente el c√≥digo de abajo.');
        mostrarCodigoCompleto();
    }
    
    document.body.removeChild(textarea);
}

// Actualizar estado visual despu√©s de copiar
function actualizarEstadoCopiado() {
    // Actualizar bot√≥n desktop
    const fallbackDiv = document.getElementById('copiarAlternativa');
    if (fallbackDiv) {
        fallbackDiv.classList.remove('alert-info');
        fallbackDiv.classList.add('alert-success');
        const btn = fallbackDiv.querySelector('button');
        if (btn) {
            btn.classList.remove('btn-primary');
            btn.classList.add('btn-success');
            btn.innerHTML = '‚úÖ ¬°Copiado!';
        }
    }
    
    // Actualizar bot√≥n m√≥vil
    const movilDiv = document.getElementById('instruccionesMovil');
    if (movilDiv) {
        const btn = movilDiv.querySelector('button');
        if (btn) {
            btn.classList.remove('btn-success');
            btn.classList.add('btn-success');
            btn.innerHTML = '‚úÖ ¬°C√≥digo Copiado!';
        }
    }
}

// Mostrar c√≥digo completo para copia manual
function mostrarCodigoCompleto() {
    // Intentar en desktop primero
    let container = document.getElementById('copiarAlternativa');
    if (!container) {
        // Si no existe, usar el de m√≥vil
        container = document.getElementById('instruccionesMovil');
    }
    
    if (container && !container.querySelector('textarea')) {
        const codigoDiv = document.createElement('div');
        codigoDiv.className = 'mt-3 p-3 bg-light rounded';
        codigoDiv.innerHTML = '<strong>üìã C√≥digo completo (selecciona y copia):</strong><br><textarea class="form-control mt-2" rows="4" readonly style="font-size: 0.85rem; word-break: break-all;">' + window.bookmarkletCode + '</textarea>';
        container.appendChild(codigoDiv);
    }
}
</script>

{% endblock %}


