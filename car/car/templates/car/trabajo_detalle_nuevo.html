{% extends "base.html" %}
{% load static %}
{% load humanize %}

{% block title %}Trabajo #{{ trabajo.id }} - {{ trabajo.vehiculo }}{% endblock %}

{% block extra_head %}
<style>
    .trabajo-container {
        max-width: 100%;
        margin: 0;
        padding: 0.5rem;
    }
    
    .trabajo-header {
        background: linear-gradient(135deg, var(--btn-bg) 0%, var(--muted) 100%);
        color: var(--btn-fg);
        padding: 1rem;
        border-radius: 10px;
        margin-bottom: 1rem;
        text-align: center;
    }
    
    .estado-badge {
        font-size: 1.1rem;
        padding: 0.5rem 1rem;
        border-radius: 25px;
        font-weight: 600;
        margin: 0.5rem;
        display: inline-block;
        min-width: 120px;
    }
    
    .estado-iniciado { background: #ffc107; color: #000; }
    .estado-trabajando { background: #0d6efd; color: #fff; }
    .estado-completado { background: #198754; color: #fff; }
    .estado-entregado { background: #6c757d; color: #fff; }
    
    .tab-container {
        background: var(--card-bg);
        border-radius: 10px;
        margin-bottom: 1rem;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    /* Esquemas claros - Tab-container con tonos m√°s oscuros para mejor contraste */
    .theme-cyan .tab-container {
        background-color: #b2dfdb !important; /* Tono m√°s oscuro del cyan */
    }
    
    .theme-sand .tab-container {
        background-color: #d7ccc8 !important; /* Tono m√°s oscuro del sand */
    }
    
    .theme-sage .tab-container {
        background-color: #c8e6c9 !important; /* Tono m√°s oscuro del sage */
    }
    
    .theme-sky .tab-container {
        background-color: #bbdefb !important; /* Tono m√°s oscuro del sky */
    }
    
    .tab-nav {
        display: flex;
        background: var(--muted);
        border-radius: 10px 10px 0 0;
        overflow-x: auto;
    }
    
    .tab-btn {
        flex: 1;
        padding: 0.75rem;
        border: none;
        background: transparent;
        color: var(--fg);
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        white-space: nowrap;
        min-width: 80px;
    }
    
    .tab-btn.active {
        background: var(--btn-bg);
        color: var(--btn-fg);
    }
    
    .tab-content {
        padding: 1rem;
        display: none;
    }
    
    .tab-content.active {
        display: block;
    }
    
    .info-card {
        background: var(--card-bg);
        border-radius: 10px;
        padding: 1rem;
        margin-bottom: 1rem;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    /* Esquemas claros - Cards con tonos m√°s oscuros para mejor contraste */
    .theme-cyan .info-card {
        background-color: #b2dfdb !important; /* Tono m√°s oscuro del cyan */
    }
    
    .theme-sand .info-card {
        background-color: #d7ccc8 !important; /* Tono m√°s oscuro del sand */
    }
    
    .theme-sage .info-card {
        background-color: #c8e6c9 !important; /* Tono m√°s oscuro del sage */
    }
    
    .theme-sky .info-card {
        background-color: #bbdefb !important; /* Tono m√°s oscuro del sky */
    }
    
    .info-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 0;
        border-bottom: 1px solid var(--muted);
    }
    
    .info-row:last-child {
        border-bottom: none;
    }
    
    .info-label {
        font-weight: 600;
        color: var(--btn-bg);
    }
    
    .info-value {
        color: var(--fg);
        text-align: right;
    }
    
    .btn-action {
        border-radius: 25px;
        padding: 0.5rem 1rem;
        font-weight: 600;
        margin: 0.25rem;
        min-width: 100px;
        font-size: 0.9rem;
    }
    
    .btn-mobile {
        width: 100%;
        padding: 1rem;
        font-size: 1.1rem;
        margin-bottom: 0.5rem;
    }
    
    .form-group {
        margin-bottom: 1rem;
    }
    
    .form-control {
        background: var(--card-bg);
        border: 2px solid var(--muted);
        color: var(--fg);
        border-radius: 8px;
        padding: 0.75rem;
    }
    
    .form-control:focus {
        border-color: var(--btn-bg);
        box-shadow: 0 0 0 0.2rem rgba(var(--btn-bg), 0.25);
    }
    
    /* Esquemas claros - Selector de mec√°nicos con color de bot√≥n */
    .theme-cyan input[type="checkbox"]:checked,
    .theme-cyan input[type="checkbox"]:checked + label,
    .theme-cyan ul li input[type="checkbox"]:checked,
    .theme-cyan ul li input[type="checkbox"]:checked + label {
        background-color: #004d40 !important; /* Color de bot√≥n cyan */
        border-color: #004d40 !important;
        color: #ffffff !important;
    }
    
    .theme-sand input[type="checkbox"]:checked,
    .theme-sand input[type="checkbox"]:checked + label,
    .theme-sand ul li input[type="checkbox"]:checked,
    .theme-sand ul li input[type="checkbox"]:checked + label {
        background-color: #3e2723 !important; /* Color de bot√≥n sand */
        border-color: #3e2723 !important;
        color: #ffffff !important;
    }
    
    .theme-sage input[type="checkbox"]:checked,
    .theme-sage input[type="checkbox"]:checked + label,
    .theme-sage ul li input[type="checkbox"]:checked,
    .theme-sage ul li input[type="checkbox"]:checked + label {
        background-color: #1b5e20 !important; /* Color de bot√≥n sage */
        border-color: #1b5e20 !important;
        color: #ffffff !important;
    }
    
    .theme-sky input[type="checkbox"]:checked,
    .theme-sky input[type="checkbox"]:checked + label,
    .theme-sky ul li input[type="checkbox"]:checked,
    .theme-sky ul li input[type="checkbox"]:checked + label {
        background-color: #0d47a1 !important; /* Color de bot√≥n sky */
        border-color: #0d47a1 !important;
        color: #ffffff !important;
    }
    
    .item-list {
        background: var(--card-bg);
        border-radius: 10px;
        padding: 1rem;
        margin-bottom: 1rem;
    }
    
    .item-card {
        background: var(--muted);
        border-radius: 8px;
        padding: 0.75rem;
        margin-bottom: 0.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        color: #2c3e50 !important; /* Texto oscuro para mejor contraste */
    }
    
    .item-card strong {
        color: #1a252f !important; /* Texto m√°s oscuro para t√≠tulos */
    }
    
    .item-card small {
        color: #34495e !important; /* Texto oscuro para subt√≠tulos */
    }
    
    /* Esquemas claros - Item-cards con tonos m√°s oscuros para mejor contraste */
    .theme-cyan .item-card {
        background-color: #b2dfdb !important; /* Tono m√°s oscuro del cyan */
        color: #004d40 !important; /* Texto verde oscuro para cyan */
    }
    
    .theme-cyan .item-card strong {
        color: #00251a !important; /* T√≠tulo m√°s oscuro para cyan */
    }
    
    .theme-cyan .item-card small {
        color: #00695c !important; /* Subt√≠tulo oscuro para cyan */
    }
    
    .theme-sand .item-card {
        background-color: #d7ccc8 !important; /* Tono m√°s oscuro del sand */
        color: #3e2723 !important; /* Texto marr√≥n oscuro para sand */
    }
    
    .theme-sand .item-card strong {
        color: #1c0e0a !important; /* T√≠tulo m√°s oscuro para sand */
    }
    
    .theme-sand .item-card small {
        color: #5d4037 !important; /* Subt√≠tulo oscuro para sand */
    }
    
    .theme-sage .item-card {
        background-color: #c8e6c9 !important; /* Tono m√°s oscuro del sage */
        color: #1b5e20 !important; /* Texto verde oscuro para sage */
    }
    
    .theme-sage .item-card strong {
        color: #0d3a0f !important; /* T√≠tulo m√°s oscuro para sage */
    }
    
    .theme-sage .item-card small {
        color: #2e7d32 !important; /* Subt√≠tulo oscuro para sage */
    }
    
    .theme-sky .item-card {
        background-color: #bbdefb !important; /* Tono m√°s oscuro del sky */
        color: #0d47a1 !important; /* Texto azul oscuro para sky */
    }
    
    .theme-sky .item-card strong {
        color: #051f4a !important; /* T√≠tulo m√°s oscuro para sky */
    }
    
    .theme-sky .item-card small {
        color: #1565c0 !important; /* Subt√≠tulo oscuro para sky */
    }
    
    .item-card.completado {
        background: #d4edda;
        border-left: 4px solid #198754;
        color: #155724 !important; /* Texto verde oscuro para completado */
    }
    
    .item-card.completado strong {
        color: #0d4a1a !important; /* T√≠tulo m√°s oscuro para completado */
    }
    
    .item-card.completado small {
        color: #1e7e34 !important; /* Subt√≠tulo oscuro para completado */
    }
    
    .item-card.pendiente {
        background: #fff3cd;
        border-left: 4px solid #ffc107;
        color: #856404 !important; /* Texto amarillo oscuro para pendiente */
    }
    
    .item-card.pendiente strong {
        color: #533f03 !important; /* T√≠tulo m√°s oscuro para pendiente */
    }
    
    .item-card.pendiente small {
        color: #6c5a04 !important; /* Subt√≠tulo oscuro para pendiente */
    }
    
    /* Estilos espec√≠ficos para completado y pendiente en cada tema */
    .theme-cyan .item-card.completado {
        background: #a5d6a7 !important; /* Verde m√°s oscuro para cyan */
        color: #1b5e20 !important;
    }
    
    .theme-cyan .item-card.pendiente {
        background: #fff9c4 !important; /* Amarillo m√°s oscuro para cyan */
        color: #f57f17 !important;
    }
    
    .theme-sand .item-card.completado {
        background: #a5d6a7 !important; /* Verde m√°s oscuro para sand */
        color: #1b5e20 !important;
    }
    
    .theme-sand .item-card.pendiente {
        background: #fff9c4 !important; /* Amarillo m√°s oscuro para sand */
        color: #f57f17 !important;
    }
    
    .theme-sage .item-card.completado {
        background: #a5d6a7 !important; /* Verde m√°s oscuro para sage */
        color: #1b5e20 !important;
    }
    
    .theme-sage .item-card.pendiente {
        background: #fff9c4 !important; /* Amarillo m√°s oscuro para sage */
        color: #f57f17 !important;
    }
    
    .theme-sky .item-card.completado {
        background: #a5d6a7 !important; /* Verde m√°s oscuro para sky */
        color: #1b5e20 !important;
    }
    
    .theme-sky .item-card.pendiente {
        background: #fff9c4 !important; /* Amarillo m√°s oscuro para sky */
        color: #f57f17 !important;
    }
    
    .toggle-btn {
        border: none;
        border-radius: 20px;
        padding: 0.25rem 0.75rem;
        font-size: 0.8rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .toggle-btn.completado {
        background: #198754;
        color: white;
    }
    
    .toggle-btn.pendiente {
        background: #ffc107;
        color: #000;
    }
    
    .progress-container {
        background: var(--card-bg);
        border-radius: 10px;
        padding: 1rem;
        margin-bottom: 1rem;
    }
    
    .progress-bar-custom {
        height: 25px;
        background: var(--muted);
        border-radius: 15px;
        overflow: hidden;
        position: relative;
    }
    
    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #ffc107 0%, #198754 100%);
        border-radius: 15px;
        transition: width 0.5s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
    }
    
    .foto-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        gap: 0.5rem;
        margin-top: 1rem;
    }
    
    .foto-item {
        aspect-ratio: 1;
        border-radius: 8px;
        overflow: hidden;
        position: relative;
    }
    
    .foto-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    .foto-item .delete-btn {
        position: absolute;
        top: 2px;
        right: 2px;
        background: rgba(220, 53, 69, 0.8);
        color: white;
        border: none;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        font-size: 0.7rem;
        cursor: pointer;
    }
    
    .add-form {
        background: var(--muted);
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
        display: none;
    }
    
    .add-form.active {
        display: block;
    }
    
    .btn-toggle-form {
        width: 100%;
        margin-bottom: 1rem;
    }
    
    @media (max-width: 768px) {
        .trabajo-container {
            padding: 0.25rem;
        }
        
        .tab-nav {
            flex-direction: column;
        }
        
        .tab-btn {
            border-bottom: 1px solid var(--muted);
        }
        
        .tab-btn:last-child {
            border-bottom: none;
        }
        
        .info-row {
            flex-direction: column;
            align-items: flex-start;
        }
        
        .info-value {
            text-align: left;
            margin-top: 0.25rem;
        }
        
        .btn-action {
            width: 100%;
            margin: 0.25rem 0;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="trabajo-container">
    <!-- Header del Trabajo -->
    <div class="trabajo-header">
        <h2>üîß Trabajo #{{ trabajo.id }}</h2>
        <h4>{{ trabajo.vehiculo }}</h4>
        <p class="mb-0">{{ trabajo.vehiculo.cliente.nombre }} - {{ trabajo.vehiculo.cliente.telefono }}</p>
    </div>

    <!-- Estado Actual -->
    <div class="info-card text-center">
        <h5>Estado Actual</h5>
        <div class="estado-badge estado-{{ trabajo.estado }}">
            {% if trabajo.estado == 'iniciado' %}üü° Iniciado
            {% elif trabajo.estado == 'trabajando' %}üîµ Trabajando
            {% elif trabajo.estado == 'completado' %}üü¢ Completado
            {% elif trabajo.estado == 'entregado' %}‚ö´ Entregado
            {% endif %}
        </div>
        
        <!-- Barra de Progreso -->
        <div class="progress-container">
            <div class="progress-bar-custom">
                <div class="progress-fill" style="width: {{ trabajo.porcentaje_avance }}%;">
                    {{ trabajo.porcentaje_avance }}%
                </div>
            </div>
        </div>
    </div>

    <!-- Navegaci√≥n por Pesta√±as -->
    <div class="tab-container">
        <div class="tab-nav">
            <button class="tab-btn {% if active_tab == 'info' %}active{% endif %}" onclick="showTab('info')">üìã Info</button>
            <button class="tab-btn {% if active_tab == 'acciones' %}active{% endif %}" onclick="showTab('acciones')">üõ†Ô∏è Acciones</button>
            <button class="tab-btn {% if active_tab == 'repuestos' %}active{% endif %}" onclick="showTab('repuestos')">üîß Repuestos</button>
            <button class="tab-btn {% if active_tab == 'fotos' %}active{% endif %}" onclick="showTab('fotos')">üì∑ Fotos</button>
            <button class="tab-btn {% if active_tab == 'estado' %}active{% endif %}" onclick="showTab('estado')">‚ö° Estado</button>
        </div>

        <!-- Pesta√±a: Informaci√≥n -->
        <div id="tab-info" class="tab-content {% if active_tab == 'info' %}active{% endif %}">
            <div class="info-card">
                <h5>üìã Informaci√≥n del Trabajo</h5>
                
                <div class="info-row">
                    <span class="info-label">Cliente:</span>
                    <span class="info-value">{{ trabajo.vehiculo.cliente.nombre }}</span>
                </div>
                
                <div class="info-row">
                    <span class="info-label">Tel√©fono:</span>
                    <span class="info-value">{{ trabajo.vehiculo.cliente.telefono }}</span>
                </div>
                
                <div class="info-row">
                    <span class="info-label">Veh√≠culo:</span>
                    <span class="info-value">{{ trabajo.vehiculo.marca }} {{ trabajo.vehiculo.modelo }} {{ trabajo.vehiculo.anio }}</span>
                </div>
                
                <div class="info-row">
                    <span class="info-label">Placa:</span>
                    <span class="info-value">{{ trabajo.vehiculo.placa }}</span>
                </div>
                
                <div class="info-row">
                    <span class="info-label">Fecha Inicio:</span>
                    <span class="info-value">{{ trabajo.fecha_inicio|date:"d/m/Y H:i"|default:"No iniciado" }}</span>
                </div>
                
                <div class="info-row">
                    <span class="info-label">Fecha Fin:</span>
                    <span class="info-value">{{ trabajo.fecha_fin|date:"d/m/Y H:i"|default:"En progreso" }}</span>
                </div>
                
                <div class="info-row">
                    <span class="info-label">Total:</span>
                    <span class="info-value">${{ trabajo.total_general|default:0|floatformat:0|intcomma }}</span>
                </div>
            </div>

            <!-- Campo Observaciones -->
            <div class="info-card">
                <h5>üìù Observaciones</h5>
                <form method="post" id="observaciones-form">
                    {% csrf_token %}
                    <textarea name="observaciones" class="form-control" rows="4" 
                              placeholder="Agregar observaciones sobre el trabajo...">{{ trabajo.observaciones|default:"" }}</textarea>
                    <button type="submit" name="guardar_observaciones" class="btn btn-primary btn-action mt-2">
                        üíæ Guardar Observaciones
                    </button>
                </form>
            </div>

            <!-- Mec√°nicos Asignados -->
            <div class="info-card">
                <h5>üë∑ Mec√°nicos Asignados</h5>
                {% if trabajo.mecanicos.exists %}
                    {% for mec in trabajo.mecanicos.all %}
                        <div class="item-card">
                            <div>
                                <strong>{{ mec.user.get_full_name|default:mec.user.first_name }}</strong>
                                {% if mec.especialidad %}
                                    <br><small>{{ mec.especialidad }}</small>
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <p class="text-muted">No hay mec√°nicos asignados</p>
                {% endif %}
                
                <form method="post">
                    {% csrf_token %}
                    {{ asignar_form.as_p }}
                    <button type="submit" name="asignar_mecanicos" class="btn btn-primary btn-action">
                        üë∑ Asignar Mec√°nicos
                    </button>
                </form>
            </div>
        </div>

        <!-- Pesta√±a: Acciones -->
        <div id="tab-acciones" class="tab-content {% if active_tab == 'acciones' %}active{% endif %}">
            <div class="info-card">
                <h5>üõ†Ô∏è Acciones del Trabajo</h5>
                
                <!-- Acorde√≥n de Componentes (como en ingreso.html) -->
                <h6 class="mt-3 mb-2">üìã Seleccionar Componentes</h6>
                <div class="accordion" id="componentesAccordion">
                    {% for padre in componentes %}
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="heading-{{ padre.id }}">
                                <button class="accordion-button collapsed" type="button"
                                        data-bs-toggle="collapse" data-bs-target="#collapse-{{ padre.id }}"
                                        aria-expanded="false" aria-controls="collapse-{{ padre.id }}">
                                    {{ padre.nombre }}
                                </button>
                            </h2>
                            <div id="collapse-{{ padre.id }}" class="accordion-collapse collapse"
                                 aria-labelledby="heading-{{ padre.id }}" data-bs-parent="#componentesAccordion">
                                <div class="accordion-body">
                                    {% for hijo in padre.hijos.all %}
                                        <div class="form-check">
                                            <input class="form-check-input componente-checkbox"
                                                   type="checkbox"
                                                   name="componentes_seleccionados"
                                                   value="{{ hijo.id }}"
                                                   id="comp-{{ hijo.id }}"
                                                   data-componente-id="{{ hijo.id }}"
                                                   data-componente-nombre="{{ hijo.nombre }}"
                                                   onclick="console.log('üéØ CLICK EN CHECKBOX:', this.id, this.dataset.componenteId, this.dataset.componenteNombre, 'Checked:', this.checked); if(this.checked) { agregarComponenteSeleccionado(this.dataset.componenteId, this.dataset.componenteNombre); } else { removerComponenteSeleccionado(this.dataset.componenteId); }">
                                            <label class="form-check-label" for="comp-{{ hijo.id }}">
                                                {{ hijo.nombre }}
                                            </label>
                                        </div>
                                    {% empty %}
                                        <p class="text-muted small">No hay subcomponentes registrados.</p>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    {% empty %}
                        <div class="alert alert-warning">
                            <strong>‚ö†Ô∏è Sin componentes disponibles</strong><br>
                            No hay componentes activos en el sistema.
                        </div>
                    {% endfor %}
                </div>
                
                <!-- üîΩ Lista de componentes elegidos (como en ingreso.html) -->
                <div id="componentes-seleccionados" class="mt-3">
                    <h6>üìã Componentes seleccionados:</h6>
                    <ul id="lista-seleccionados" class="list-group small"></ul>
                    
                    <!-- ====== BLOQUE ACCIONES ====== -->
                    <div class="card mt-2">
                        <div class="card-body p-2">
                            <h3 class="h6">üõ†Ô∏è Acciones para componentes seleccionados</h3>
                            <ul id="acciones-para-componentes" class="list-group list-group-flush small"></ul>
                            <input type="hidden" id="acciones_componentes_json" name="acciones_componentes_json" value="[]">
                            <div class="d-flex justify-content-between align-items-center mt-2">
                                <div>
                                    <button type="button" class="btn btn-success btn-sm" id="guardar-acciones-btn" onclick="guardarAccionesSeleccionadas()">
                                        üíæ Guardar Acciones Seleccionadas
                                    </button>
                                    <button type="button" class="btn btn-secondary btn-sm ms-2" onclick="limpiarSeleccion()">
                                        üóëÔ∏è Limpiar Selecci√≥n
                                    </button>
                                </div>
                                <div class="text-end">
                                    <div class="small text-muted">Total mano de obra</div>
                                    <div class="fw-bold" id="total_mano_obra">$0</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- ====== FIN BLOQUE ACCIONES ====== -->
                </div>
                
                <hr class="my-4">
                
                <!-- Lista de acciones existentes -->
                <h6>üõ†Ô∏è Acciones Registradas</h6>
                {% for accion in trabajo.acciones.all %}
                    <div class="item-card {% if accion.completado %}completado{% else %}pendiente{% endif %}">
                        <div>
                            <strong>{{ accion.componente.nombre }}</strong><br>
                            <small>{{ accion.accion.nombre }}</small>
                            {% if accion.precio_mano_obra %}
                                <br><small class="text-success">${{ accion.precio_mano_obra|floatformat:0|intcomma }}</small>
                            {% endif %}
                        </div>
                        <div>
                            <form method="post" style="display: inline;">
                                {% csrf_token %}
                                <input type="hidden" name="accion_id" value="{{ accion.id }}">
                                <button type="submit" name="toggle_accion" 
                                        class="toggle-btn {% if accion.completado %}completado{% else %}pendiente{% endif %}">
                                    {% if accion.completado %}‚úÖ Completado{% else %}‚è≥ Pendiente{% endif %}
                                </button>
                            </form>
                            <form method="post" style="display: inline;">
                                {% csrf_token %}
                                <input type="hidden" name="accion_id" value="{{ accion.id }}">
                                <button type="submit" name="eliminar_accion" class="btn btn-danger btn-sm" 
                                        onclick="return confirm('¬øEliminar esta acci√≥n?')">
                                    üóëÔ∏è
                                </button>
                            </form>
                        </div>
                    </div>
                {% empty %}
                    <p class="text-muted">No hay acciones registradas</p>
                {% endfor %}
            </div>
        </div>

        <!-- Pesta√±a: Repuestos -->
        <div id="tab-repuestos" class="tab-content {% if active_tab == 'repuestos' %}active{% endif %}">
            <div class="info-card">
                <h5>üîß Repuestos del Trabajo</h5>
                
                <!-- Informaci√≥n del filtro inteligente -->
                <div class="alert alert-info mb-3">
                    <small>
                        <strong>üß† Filtro Inteligente Activo:</strong> 
                        Los repuestos mostrados est√°n filtrados autom√°ticamente por las caracter√≠sticas del veh√≠culo 
                        (marca: <strong>{{ trabajo.vehiculo.marca|default:"No especificada" }}</strong>, 
                        motor: <strong>{{ trabajo.vehiculo.descripcion_motor|default:"No especificado" }}</strong>).
                        Solo se muestran repuestos compatibles o de uso general.
                    </small>
                </div>
                
                <!-- Bot√≥n para agregar repuesto -->
                <button class="btn btn-success btn-toggle-form" onclick="toggleAddForm('repuesto')">
                    ‚ûï Agregar Repuesto
                </button>
                
                <!-- Formulario para agregar repuesto -->
                <div id="add-repuesto-form" class="add-form">
                    <form method="post">
                        {% csrf_token %}
                        <div class="form-group">
                            <label>Repuesto:</label>
                            <select name="repuesto" class="form-control" required>
                                <option value="">Seleccionar repuesto...</option>
                                {% for repuesto in repuestos_disponibles %}
                                    <option value="{{ repuesto.id }}" 
                                            data-marca="{{ repuesto.marca_veh|default:'General' }}"
                                            data-motor="{{ repuesto.tipo_de_motor|default:'General' }}"
                                            data-stock="{{ repuesto.stock|default:0 }}">
                                        {{ repuesto.nombre }} - ${{ repuesto.precio_venta|default:0|floatformat:0|intcomma }}
                                        {% if repuesto.marca_veh %} ({{ repuesto.marca_veh }}){% endif %}
                                        {% if repuesto.stock > 0 %} - Stock: {{ repuesto.stock }}{% endif %}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Cantidad:</label>
                            <input type="number" name="cantidad" class="form-control" min="1" value="1" required>
                        </div>
                        <div class="form-group">
                            <label>Precio Unitario:</label>
                            <input type="number" name="precio_unitario" id="precio-unitario" class="form-control" step="0.01" min="0" placeholder="Se llena autom√°ticamente">
                        </div>
                        <button type="submit" name="agregar_repuesto" class="btn btn-primary btn-action">
                            ‚ûï Agregar
                        </button>
                        <button type="button" class="btn btn-secondary btn-action" onclick="toggleAddForm('repuesto')">
                            ‚ùå Cancelar
                        </button>
                    </form>
                </div>
                
                <!-- Lista de repuestos -->
                {% for repuesto in trabajo.repuestos.all %}
                    <div class="item-card {% if repuesto.completado %}completado{% else %}pendiente{% endif %}">
                        <div>
                            <strong>{{ repuesto.repuesto.nombre }}</strong><br>
                            <small>Cantidad: {{ repuesto.cantidad }}</small>
                            {% if repuesto.precio_unitario %}
                                <br><small class="text-success">${{ repuesto.precio_unitario|floatformat:0|intcomma }} c/u</small>
                            {% endif %}
                        </div>
                        <div>
                            <form method="post" style="display: inline;">
                                {% csrf_token %}
                                <input type="hidden" name="repuesto_id" value="{{ repuesto.id }}">
                                <button type="submit" name="toggle_repuesto" 
                                        class="toggle-btn {% if repuesto.completado %}completado{% else %}pendiente{% endif %}">
                                    {% if repuesto.completado %}‚úÖ Completado{% else %}‚è≥ Pendiente{% endif %}
                                </button>
                            </form>
                            <form method="post" style="display: inline;">
                                {% csrf_token %}
                                <input type="hidden" name="repuesto_id" value="{{ repuesto.id }}">
                                <button type="submit" name="eliminar_repuesto" class="btn btn-danger btn-sm" 
                                        onclick="return confirm('¬øEliminar este repuesto?')">
                                    üóëÔ∏è
                                </button>
                            </form>
                        </div>
                    </div>
                {% empty %}
                    <p class="text-muted">No hay repuestos registrados</p>
                {% endfor %}
            </div>
        </div>

        <!-- Pesta√±a: Fotos -->
        <div id="tab-fotos" class="tab-content {% if active_tab == 'fotos' %}active{% endif %}">
            <div class="info-card">
                <h5>üì∑ Fotos del Progreso</h5>
                
                <!-- Formulario para subir foto -->
                <form method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="form-group">
                        <input type="file" name="imagen" class="form-control" accept="image/*" required>
                    </div>
                    <div class="form-group">
                        <input type="text" name="descripcion" class="form-control" placeholder="Descripci√≥n de la foto (opcional)">
                    </div>
                    <button type="submit" name="subir_foto" class="btn btn-primary btn-action">
                        üì∑ Subir Foto
                    </button>
                </form>
                
                <!-- Grid de fotos -->
                <div class="foto-grid">
                    {% for foto in trabajo.fotos.all %}
                        <div class="foto-item">
                            <img src="{{ foto.imagen.url }}" alt="{{ foto.descripcion|default:'Foto del trabajo' }}">
                            <button class="delete-btn" onclick="eliminarFoto({{ foto.id }})" title="Eliminar foto">√ó</button>
                        </div>
                    {% empty %}
                        <p class="text-muted">No hay fotos subidas</p>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Pesta√±a: Estado -->
        <div id="tab-estado" class="tab-content {% if active_tab == 'estado' %}active{% endif %}">
            <div class="info-card">
                <h5>‚ö° Cambiar Estado del Trabajo</h5>
                <p class="text-muted">Selecciona el nuevo estado para este trabajo:</p>
                
                <form method="post">
                    {% csrf_token %}
                    <div class="row g-2">
                        <div class="col-6">
                            <button type="submit" name="cambiar_estado" value="iniciado" 
                                    class="btn btn-mobile {% if trabajo.estado == 'iniciado' %}btn-warning{% else %}btn-outline-warning{% endif %}">
                                üü° Iniciado
                            </button>
                        </div>
                        <div class="col-6">
                            <button type="submit" name="cambiar_estado" value="trabajando" 
                                    class="btn btn-mobile {% if trabajo.estado == 'trabajando' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                                üîµ Trabajando
                            </button>
                        </div>
                        <div class="col-6">
                            <button type="submit" name="cambiar_estado" value="completado" 
                                    class="btn btn-mobile {% if trabajo.estado == 'completado' %}btn-success{% else %}btn-outline-success{% endif %}">
                                üü¢ Completado
                            </button>
                        </div>
                        <div class="col-6">
                            <button type="submit" name="cambiar_estado" value="entregado" 
                                    class="btn btn-mobile {% if trabajo.estado == 'entregado' %}btn-dark{% else %}btn-outline-dark{% endif %}">
                                ‚ö´ Entregado
                            </button>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Botones de Acci√≥n -->
            <div class="info-card">
                <h5>üìÑ Acciones Adicionales</h5>
                
                <a href="{% url 'trabajo_pdf' trabajo.pk %}" class="btn btn-info btn-mobile" target="_blank">
                    üìÑ Generar PDF de Estado
                </a>
                
                <a href="{% url 'panel_principal' %}" class="btn btn-secondary btn-mobile">
                    üè† Volver a la Pizarra
                </a>
                
                <a href="javascript:history.back()" class="btn btn-outline-secondary btn-mobile">
                    ‚Üê Regresar
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Funciones para las pesta√±as
function showTab(tabName) {
    // Ocultar todas las pesta√±as
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Remover clase active de todos los botones
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Mostrar la pesta√±a seleccionada
    document.getElementById('tab-' + tabName).classList.add('active');
    
    // Activar el bot√≥n correspondiente
    if (event && event.target) {
        event.target.classList.add('active');
    } else {
        // Si no hay event (llamada program√°tica), buscar el bot√≥n correcto
        document.querySelector(`[onclick="showTab('${tabName}')"]`).classList.add('active');
    }
}

// üîπ Inicializar pesta√±a activa al cargar la p√°gina
document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const activeTab = urlParams.get('tab');
    if (activeTab) {
        showTab(activeTab);
    }
});

// Funciones para formularios de agregar
function toggleAddForm(type) {
    const form = document.getElementById('add-' + type + '-form');
    form.classList.toggle('active');
}

// Funci√≥n para eliminar foto
function eliminarFoto(fotoId) {
    if (confirm('¬øEliminar esta foto?')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.innerHTML = `
            {% csrf_token %}
            <input type="hidden" name="eliminar_foto" value="${fotoId}">
        `;
        document.body.appendChild(form);
        form.submit();
    }
}

// Funci√≥n para generar PDF
function generarPDF() {
    // Aqu√≠ implementaremos la generaci√≥n de PDF
    alert('Funci√≥n de PDF en desarrollo...');
}

// Auto-guardar observaciones
document.addEventListener('DOMContentLoaded', function() {
    const observacionesTextarea = document.querySelector('textarea[name="observaciones"]');
    if (observacionesTextarea) {
        let timeout;
        observacionesTextarea.addEventListener('input', function() {
            clearTimeout(timeout);
            timeout = setTimeout(() => {
                // Auto-guardar despu√©s de 2 segundos de inactividad
                const form = document.getElementById('observaciones-form');
                if (form) {
                    form.submit();
                }
            }, 2000);
        });
    }
    
    // üîπ FILTRO INTELIGENTE: Mostrar informaci√≥n de compatibilidad al seleccionar repuesto
    const repuestoSelect = document.querySelector('select[name="repuesto"]');
    if (repuestoSelect) {
        // Crear elemento para mostrar informaci√≥n de compatibilidad
        const infoDiv = document.createElement('div');
        infoDiv.id = 'repuesto-compatibilidad-info';
        infoDiv.className = 'mt-2 p-2 bg-light rounded';
        infoDiv.style.display = 'none';
        repuestoSelect.parentNode.appendChild(infoDiv);
        
        repuestoSelect.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            if (selectedOption.value) {
                const marca = selectedOption.dataset.marca;
                const motor = selectedOption.dataset.motor;
                const stock = selectedOption.dataset.stock;
                
                // üîπ Llenar autom√°ticamente el precio unitario
                const precioInput = document.getElementById('precio-unitario');
                if (precioInput) {
                    // Extraer precio del texto de la opci√≥n (formato: "Nombre - $precio")
                    const optionText = selectedOption.textContent;
                    const precioMatch = optionText.match(/\$([0-9,]+)/);
                    if (precioMatch) {
                        const precio = precioMatch[1].replace(/,/g, '');
                        precioInput.value = precio;
                    }
                }
                
                let compatibilidadText = '';
                let compatibilidadClass = 'bg-secondary';
                
                // Calcular compatibilidad b√°sica
                if (marca && marca !== 'General') {
                    compatibilidadText += `‚úÖ Marca espec√≠fica: ${marca}<br>`;
                    compatibilidadClass = 'bg-success';
                } else {
                    compatibilidadText += `‚ö†Ô∏è Marca general<br>`;
                }
                
                if (motor && motor !== 'General') {
                    compatibilidadText += `‚úÖ Motor espec√≠fico: ${motor}<br>`;
                    if (compatibilidadClass === 'bg-secondary') compatibilidadClass = 'bg-warning';
                } else {
                    compatibilidadText += `‚ö†Ô∏è Motor general<br>`;
                }
                
                if (parseInt(stock) > 0) {
                    compatibilidadText += `‚úÖ Stock disponible: ${stock} unidades`;
                } else {
                    compatibilidadText += `‚ùå Sin stock disponible`;
                    compatibilidadClass = 'bg-danger';
                }
                
                infoDiv.innerHTML = `
                    <small class="text-muted">
                        <strong>Compatibilidad:</strong><br>
                        ${compatibilidadText}
                    </small>
                `;
                infoDiv.className = `mt-2 p-2 rounded ${compatibilidadClass} text-white`;
                infoDiv.style.display = 'block';
            } else {
                infoDiv.style.display = 'none';
            }
        });
    }
    
    // üîπ Calcular subtotal autom√°ticamente
    const cantidadInput = document.querySelector('input[name="cantidad"]');
    const precioInput = document.getElementById('precio-unitario');
    
    function calcularSubtotal() {
        if (cantidadInput && precioInput) {
            const cantidad = parseInt(cantidadInput.value) || 0;
            const precio = parseFloat(precioInput.value) || 0;
            const subtotal = cantidad * precio;
            
            // Mostrar subtotal en alg√∫n lugar (opcional)
            let subtotalDiv = document.getElementById('subtotal-preview');
            if (!subtotalDiv) {
                subtotalDiv = document.createElement('div');
                subtotalDiv.id = 'subtotal-preview';
                subtotalDiv.className = 'mt-2 p-2 bg-info text-white rounded';
                precioInput.parentNode.appendChild(subtotalDiv);
            }
            
            if (subtotal > 0) {
                subtotalDiv.innerHTML = `<small><strong>Subtotal: $${subtotal.toLocaleString()}</strong></small>`;
                subtotalDiv.style.display = 'block';
            } else {
                subtotalDiv.style.display = 'none';
            }
        }
    }
    
    if (cantidadInput) {
        cantidadInput.addEventListener('input', calcularSubtotal);
    }
    if (precioInput) {
        precioInput.addEventListener('input', calcularSubtotal);
    }
    
    // üîπ FUNCI√ìN PARA CAMBIAR DE PESTA√ëA
    window.showTab = function(tabName) {
        // Ocultar todas las pesta√±as
        const allTabs = document.querySelectorAll('.tab-content');
        allTabs.forEach(tab => {
            tab.classList.remove('active');
        });
        
        // Desactivar todos los botones
        const allButtons = document.querySelectorAll('.tab-btn');
        allButtons.forEach(btn => {
            btn.classList.remove('active');
        });
        
        // Mostrar la pesta√±a seleccionada
        const selectedTab = document.getElementById('tab-' + tabName);
        if (selectedTab) {
            selectedTab.classList.add('active');
        }
        
        // Activar el bot√≥n correspondiente
        const buttons = document.querySelectorAll('.tab-btn');
        buttons.forEach(btn => {
            if (btn.getAttribute('onclick').includes(tabName)) {
                btn.classList.add('active');
            }
        });
    };
    
    // üîπ FUNCIONALIDAD PARA COMPONENTES SELECCIONADOS (como en ingreso.html)
    console.log('üöÄ SCRIPT INICIADO - Variables globales definidas');
    let componentesSeleccionados = new Set();
    const ACC = {}; // Objeto para almacenar acciones
    const CLP = new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP', maximumFractionDigits: 0 });
    console.log('‚úÖ Variables globales inicializadas:', { componentesSeleccionados, ACC, CLP });
    
    // Funci√≥n para cargar acciones de un componente
    async function cargarAccionesComponente(componenteId, componenteNombre) {
        console.log(`üîÑ cargarAccionesComponente llamado: ${componenteId} - ${componenteNombre}`);
        
        try {
            const url = `/car/acciones-lookup/${componenteId}/`;
            console.log(`üì° Haciendo fetch a: ${url}`);
            
            const response = await fetch(url);
            console.log(`üì° Respuesta recibida:`, response);
            console.log(`üì° Status: ${response.status}`);
            
            const data = await response.json();
            console.log(`üì° Datos recibidos:`, data);
            
            if (!data.ok || !data.acciones || data.acciones.length === 0) {
                console.log(`‚ö†Ô∏è No hay acciones disponibles para componente ${componenteId}`);
                console.log(`   - data.ok: ${data.ok}`);
                console.log(`   - data.acciones:`, data.acciones);
                return;
            }
            
            console.log(`‚úÖ Se encontraron ${data.acciones.length} acciones para el componente ${componenteId}`);
            
            const ulAcciones = document.getElementById('acciones-para-componentes');
            console.log(`üîç Buscando elemento 'acciones-para-componentes':`, ulAcciones);
            
            if (!ulAcciones) {
                console.error(`‚ùå No se encontr√≥ el elemento 'acciones-para-componentes'`);
                return;
            }
            
            console.log(`‚úÖ Elemento 'acciones-para-componentes' encontrado, agregando acciones...`);
            
            // Crear un elemento por cada acci√≥n disponible
            data.acciones.forEach(accion => {
                const accionKey = `${componenteId}-${accion.accion_id}`;
                ACC[accionKey] = ACC[accionKey] || { 
                    componente_id: componenteId,
                    nombre: componenteNombre, 
                    accion_id: accion.accion_id, 
                    accion_nombre: accion.accion_nombre,
                    precio: accion.precio_base || '',
                    seleccionado: false
                };
                
                const li = document.createElement('li');
                li.className = 'list-group-item';
                li.setAttribute('data-componente-id', componenteId);
                li.setAttribute('data-accion-id', accion.accion_id);
                li.setAttribute('data-accion-key', accionKey);
                
                const precioBase = parseFloat(accion.precio_base || 0);
                const precioFormateado = precioBase > 0 ? CLP.format(precioBase) : 'Sin precio base';
                
                li.innerHTML = `
                    <div class="row g-2 align-items-center">
                        <div class="col-1">
                            <input type="checkbox" class="form-check-input accion-checkbox" 
                                   data-accion-key="${accionKey}" 
                                   ${ACC[accionKey].seleccionado ? 'checked' : ''}>
                        </div>
                        <div class="col-12 col-md-5">
                            <div class="fw-semibold">${componenteNombre}</div>
                            <div class="text-primary small">${accion.accion_nombre}</div>
                            <div class="text-muted small">ID: ${componenteId} ‚Ä¢ Acci√≥n: ${accion.accion_id}</div>
                        </div>
                        <div class="col-8 col-md-4">
                            <label class="form-label mb-0 small">Precio personalizado</label>
                            <input type="number" step="0.01" class="form-control form-control-sm accion-precio" 
                                   placeholder="${precioBase > 0 ? precioBase : '0.00'}" 
                                   value="${ACC[accionKey].precio || ''}"
                                   data-accion-key="${accionKey}">
                            <small class="text-muted">Base: ${precioFormateado}</small>
                        </div>
                        <div class="col-4 col-md-2 text-end">
                            <div class="fw-bold text-success" data-precio-display="${accionKey}">
                                ${ACC[accionKey].seleccionado ? (ACC[accionKey].precio ? CLP.format(parseFloat(ACC[accionKey].precio)) : precioFormateado) : '$0'}
                            </div>
                        </div>
                    </div>
                `;
                
                ulAcciones.appendChild(li);
                
                // Event listeners
                const checkbox = li.querySelector('.accion-checkbox');
                const precioInput = li.querySelector('.accion-precio');
                const precioDisplay = li.querySelector('[data-precio-display]');
                
                checkbox.addEventListener('change', () => {
                    ACC[accionKey].seleccionado = checkbox.checked;
                    if (checkbox.checked && !ACC[accionKey].precio && precioBase > 0) {
                        ACC[accionKey].precio = precioBase.toString();
                        precioInput.value = precioBase;
                    }
                    actualizarPrecioDisplay(accionKey, precioDisplay, checkbox.checked);
                    actualizarTotalManoObra();
                });
                
                precioInput.addEventListener('input', () => {
                    ACC[accionKey].precio = precioInput.value;
                    actualizarPrecioDisplay(accionKey, precioDisplay, ACC[accionKey].seleccionado);
                    actualizarTotalManoObra();
                });
                
                // Inicializar display de precio
                actualizarPrecioDisplay(accionKey, precioDisplay, checkbox.checked);
            });
            
            console.log(`‚úÖ Se agregaron ${data.acciones.length} acciones al DOM`);
            
        } catch (error) {
            console.error('‚ùå Error cargando acciones:', error);
            console.error('‚ùå Stack trace:', error.stack);
        }
    }
    
    // Funci√≥n para actualizar el display del precio
    function actualizarPrecioDisplay(accionKey, precioDisplay, isSelected) {
        if (!precioDisplay) return;
        
        if (!isSelected) {
            precioDisplay.textContent = '$0';
            precioDisplay.className = 'fw-bold text-muted';
            return;
        }
        
        const accion = ACC[accionKey];
        if (accion && accion.precio) {
            precioDisplay.textContent = CLP.format(parseFloat(accion.precio));
            precioDisplay.className = 'fw-bold text-success';
        }
    }
    
    // Funci√≥n para actualizar el total de mano de obra
    function actualizarTotalManoObra() {
        const totalDiv = document.getElementById('total_mano_obra');
        if (!totalDiv) return;
        
        const total = Object.values(ACC)
            .filter(a => a.seleccionado && a.precio)
            .reduce((sum, a) => sum + parseFloat(a.precio || 0), 0);
        
        totalDiv.textContent = CLP.format(total);
    }
    
    // Funci√≥n para agregar componente a la lista de seleccionados
    window.agregarComponenteSeleccionado = async function(componenteId, componenteNombre) {
        console.log(`üîß agregarComponenteSeleccionado llamado: ${componenteId} - ${componenteNombre}`);
        
        if (componentesSeleccionados.has(componenteId)) {
            console.log(`‚ö†Ô∏è Componente ${componenteId} ya est√° seleccionado`);
            return; // Ya est√° seleccionado
        }
        
        componentesSeleccionados.add(componenteId);
        console.log(`‚úÖ Componente ${componenteId} agregado a componentesSeleccionados`);
        
        // Agregar a la lista visual
        const lista = document.getElementById('lista-seleccionados');
        console.log(`üîç Buscando elemento 'lista-seleccionados':`, lista);
        
        if (lista) {
            console.log(`‚úÖ Elemento encontrado, agregando componente...`);
            const li = document.createElement('li');
            li.className = 'list-group-item d-flex justify-content-between align-items-center';
            li.id = `comp-seleccionado-${componenteId}`;
            li.innerHTML = `
                <span>${componenteNombre}</span>
                <button type="button" class="btn btn-sm btn-danger" onclick="removerComponenteSeleccionado(${componenteId})">
                    ‚ùå
                </button>
            `;
            lista.appendChild(li);
            console.log(`‚úÖ Componente ${componenteId} agregado visualmente a la lista`);
        } else {
            console.error(`‚ùå No se encontr√≥ el elemento 'lista-seleccionados'`);
        }
        
        // Cargar acciones para este componente
        console.log(`üîÑ Llamando a cargarAccionesComponente para ${componenteId}...`);
        await cargarAccionesComponente(componenteId, componenteNombre);
    }
    
    // Funci√≥n para remover componente de la lista de seleccionados
    window.removerComponenteSeleccionado = function(componenteId) {
        console.log(`üóëÔ∏è removerComponenteSeleccionado llamado: ${componenteId}`);
        componentesSeleccionados.delete(componenteId);
        
        // Remover de la lista visual
        const li = document.getElementById(`comp-seleccionado-${componenteId}`);
        if (li) {
            li.remove();
        }
        
        // Remover todas las acciones de este componente
        const ulAcciones = document.getElementById('acciones-para-componentes');
        if (ulAcciones) {
            const accionesDelComponente = ulAcciones.querySelectorAll(`li[data-componente-id="${componenteId}"]`);
            accionesDelComponente.forEach(accionLi => accionLi.remove());
        }
        
        // Limpiar del objeto ACC
        Object.keys(ACC).forEach(key => {
            if (key.startsWith(`${componenteId}-`)) {
                delete ACC[key];
            }
        });
        
        // Actualizar total
        actualizarTotalManoObra();
        
        // Desmarcar checkbox
        const checkbox = document.getElementById(`comp-${componenteId}`);
        if (checkbox) {
            checkbox.checked = false;
        }
    };
    
    // üîπ INICIALIZAR EVENTOS DE CHECKBOXES
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üîç DOMContentLoaded ejecutado - Inicializando eventos de checkboxes...');
        
        // Agregar event listeners a todos los checkboxes de componentes
        const checkboxes = document.querySelectorAll('.componente-checkbox');
        console.log(`üîç Encontrados ${checkboxes.length} checkboxes de componentes`);
        
        checkboxes.forEach((checkbox, index) => {
            console.log(`üîß Configurando checkbox ${index + 1}:`, checkbox);
            console.log(`   - ID: ${checkbox.id}`);
            console.log(`   - Value: ${checkbox.value}`);
            console.log(`   - data-componente-id: ${checkbox.dataset.componenteId}`);
            console.log(`   - data-componente-nombre: ${checkbox.dataset.componenteNombre}`);
            
            checkbox.addEventListener('change', function() {
                console.log('üéØ CHECKBOX CAMBIADO:', this);
                console.log('   - Checked:', this.checked);
                console.log('   - Componente ID:', this.dataset.componenteId);
                console.log('   - Componente Nombre:', this.dataset.componenteNombre);
                
                const componenteId = this.dataset.componenteId;
                const componenteNombre = this.dataset.componenteNombre;
                
                if (this.checked) {
                    console.log(`‚úÖ Agregando componente: ${componenteId} - ${componenteNombre}`);
                    agregarComponenteSeleccionado(componenteId, componenteNombre);
                } else {
                    console.log(`‚ùå Removiendo componente: ${componenteId}`);
                    removerComponenteSeleccionado(componenteId);
                }
            });
            
            console.log(`‚úÖ Event listener agregado al checkbox ${checkbox.id}`);
        });
        
        console.log('üéâ Inicializaci√≥n de checkboxes completada');
    });
    
    // üîπ FUNCI√ìN PARA GUARDAR ACCIONES SELECCIONADAS
    window.guardarAccionesSeleccionadas = async function() {
        console.log('üíæ guardarAccionesSeleccionadas llamado');
        
        // Obtener todas las acciones seleccionadas
        const accionesSeleccionadas = Object.values(ACC).filter(a => a.seleccionado && a.precio);
        console.log('üìã Acciones seleccionadas:', accionesSeleccionadas);
        
        if (accionesSeleccionadas.length === 0) {
            alert('‚ö†Ô∏è No hay acciones seleccionadas para guardar');
            return;
        }
        
        // Preparar datos para enviar
        const datosAcciones = accionesSeleccionadas.map(accion => ({
            componente_id: parseInt(accion.componente_id),
            accion_id: parseInt(accion.accion_id),
            precio_mano_obra: parseFloat(accion.precio) || 0
        }));
        
        console.log('üì§ Datos a enviar:', datosAcciones);
        
        try {
            // Crear formulario para enviar datos
            const formData = new FormData();
            formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
            formData.append('acciones_json', JSON.stringify(datosAcciones));
            formData.append('agregar_acciones_multiples', 'true');
            
            const response = await fetch(window.location.href, {
                method: 'POST',
                body: formData
            });
            
            console.log('üì° Respuesta del servidor:', response);
            
            if (response.ok || response.status === 302) {
                console.log('‚úÖ Acciones guardadas exitosamente');
                alert('‚úÖ Acciones guardadas exitosamente');
                
                // Recargar la p√°gina manteniendo la pesta√±a de acciones activa
                window.location.href = window.location.pathname + '?tab=acciones';
            } else {
                console.error('‚ùå Error al guardar acciones:', response.status);
                alert('‚ùå Error al guardar las acciones');
            }
            
        } catch (error) {
            console.error('‚ùå Error en la petici√≥n:', error);
            alert('‚ùå Error al guardar las acciones');
        }
    };
    
    // üîπ FUNCI√ìN PARA LIMPIAR SELECCI√ìN
    window.limpiarSeleccion = function() {
        console.log('üóëÔ∏è limpiarSeleccion llamado');
        
        // Limpiar todas las acciones del DOM
        const ulAcciones = document.getElementById('acciones-para-componentes');
        if (ulAcciones) {
            ulAcciones.innerHTML = '';
        }
        
        // Limpiar lista de componentes seleccionados
        const listaSeleccionados = document.getElementById('lista-seleccionados');
        if (listaSeleccionados) {
            listaSeleccionados.innerHTML = '';
        }
        
        // Limpiar objetos JavaScript
        componentesSeleccionados.clear();
        Object.keys(ACC).forEach(key => delete ACC[key]);
        
        // Desmarcar todos los checkboxes
        const checkboxes = document.querySelectorAll('.componente-checkbox');
        checkboxes.forEach(checkbox => {
            checkbox.checked = false;
        });
        
        // Actualizar total
        actualizarTotalManoObra();
        
        console.log('‚úÖ Selecci√≥n limpiada completamente');
    };
});
</script>
{% endblock %}
