{% extends 'base.html' %}
{% load humanize %}
{% block content %}
<h3>Diagn√≥sticos ‚û°Ô∏è Presupuestos</h3>

<input type="text" id="filterInput" class="form-control my-2" placeholder="Buscar por veh√≠culo, cliente, tel√©fono, diagn√≥stico, partes...">

{% for diagnostico in diagnosticos %}
<div class="card mb-3">
  <div class="card-body">
    <strong>Veh√≠culo:</strong> {{ diagnostico.vehiculo }}<br>
    
    <strong>VIN:</strong> <strong style="color: red;"> {{ diagnostico.vehiculo.vin }}</strong> <br>
    <strong>Cliente:</strong> {{ diagnostico.vehiculo.cliente.nombre }}<br>
    <strong>Tel√©fono:</strong> {{ diagnostico.vehiculo.cliente.telefono }}<br>

    <strong>Diagn√≥stico:</strong> {{ diagnostico.descripcion_problema }}<br>
    <strong>Partes Afectadas:</strong> 
    {% for comp in diagnostico.componentes.all %}
      {{ comp.nombre }}{% if not forloop.last %}, {% endif %}
    {% empty %}
      Ninguno
    {% endfor %}
    <br>

    <!-- ==== Acciones y Mano de Obra ==== -->
    <strong>Acciones realizadas:</strong><br>
    {% with diagnostico.acciones_componentes.all as acciones %}
      {% if acciones %}
        <ul class="list-group list-group-flush my-2">
          {% for dca in acciones %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <span>
                <strong>{{ dca.componente.nombre }}</strong> ‚Äî {{ dca.accion.nombre }}
              </span>
              <span class="badge bg-primary rounded-pill">
                ${{ dca.precio_mano_obra|default:0|floatformat:0|intcomma }}
              </span>
            </li>
          {% endfor %}
        </ul>
        <div class="text-end fw-bold">
          Total mano de obra: 
          ${{ diagnostico.total_mano_obra|default:0|floatformat:0|intcomma }}
        </div>
      {% else %}
        <span class="text-muted">No se registraron acciones</span>
      {% endif %}
    {% endwith %}

    <!-- ==== Repuestos ==== -->
    <strong>Repuestos utilizados:</strong><br>
    {% with diagnostico.repuestos.all as repuestos %}
      {% if repuestos %}
        <ul class="list-group list-group-flush my-2">
          {% for dr in repuestos %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <span>
                <strong>{{ dr.repuesto.nombre }}</strong> (x{{ dr.cantidad }})
              </span>
              <span class="badge bg-primary rounded-pill">
                ${{ dr.subtotal|default:0|floatformat:0|intcomma }}
              </span>
            </li>
          {% endfor %}
        </ul>
        <div class="text-end fw-bold">
          Total repuestos: 
          ${{ diagnostico.total_repuestos|default:0|floatformat:0|intcomma }}
        </div>
      {% else %}
        <span class="text-muted">No se registraron repuestos</span>
      {% endif %}
    {% endwith %}

    <!-- == TOTAL PRESUPUESTO == -->
    <div class="text-end fw-bold mt-2 text-success">
      üí∞ Total presupuesto: 
      {{ diagnostico.total_mano_obra|default:0|add:diagnostico.total_repuestos|default:0|floatformat:0|intcomma }}
    </div>

    <strong>√öltima Visita:</strong> {{ diagnostico.fecha }}<br>

    <!-- ==== Botones ==== -->
    <a href="{% url 'diagnostico_excel' diagnostico.pk %}" class="btn btn-success btn-sm mt-2">Excel</a>
    <a href="{% url 'diagnostico_pdf' diagnostico.pk %}" class="btn btn-danger btn-sm mt-2">PDF</a>
    <a href="" class="btn btn-sm btn-secondary mt-2">Editar</a>
    <a href="{% url 'eliminar_diagnostico' diagnostico.pk %}" class="btn btn-sm btn-danger mt-2">Eliminar</a>
    <a href="{% url 'panel_principal' %}" class="btn btn-sm btn-warning mt-2">Regresar</a>

    <!-- ==== Bot√≥n Aceptar / Estado ==== -->
    {% if diagnostico.estado == "pendiente" %}
      <a href="{% url 'aprobar_diagnostico' diagnostico.pk %}" class="btn btn-sm btn-primary mt-2">
        ‚úÖ Aceptar
      </a>
    {% elif diagnostico.estado == "aprobado" %}
      <span class="badge bg-success mt-2">Aprobado</span>
    {% endif %}

  </div>
</div>
{% empty %}
<p>No hay diagn√≥sticos registrados.</p>
{% endfor %}

<a href="javascript:history.back()" class="btn btn-sm btn-warning mt-2">Regresar</a>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const filterInput = document.getElementById('filterInput');
  const cards = document.querySelectorAll('.card');

  filterInput.addEventListener('keyup', function () {
    const filterValue = filterInput.value.toLowerCase();
    cards.forEach(function (card) {
      const text = card.textContent.toLowerCase();
      card.style.display = text.includes(filterValue) ? 'block' : 'none';
    });
  });
});
</script>
{% endblock %}
