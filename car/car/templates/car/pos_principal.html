{% extends "base.html" %}
{% load static %}
{% load humanize %}

{% block title %}Punto de Venta - POS{% endblock %}

{% block extra_head %}
<script>
    // Aplicar tema autom√°ticamente al cargar
    document.addEventListener('DOMContentLoaded', function() {
        const saved = localStorage.getItem("theme") || "piedra";
        document.body.className = `theme-${saved}`;
    });
</script>
<style>
    .pos-container {
        max-width: 100%;
        margin: 0;
        padding: 0;
    }
    
    .pos-header {
        background: linear-gradient(135deg, var(--btn-bg) 0%, var(--muted) 100%);
        color: var(--btn-fg);
        padding: 1rem;
        position: sticky;
        top: 0;
        z-index: 1000;
    }
    
    .search-container {
        background: var(--card-bg);
        border-radius: 10px;
        padding: 1rem;
        margin: 1rem;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .search-results {
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid var(--muted);
        border-radius: 5px;
        background: var(--card-bg);
        position: absolute;
        width: 100%;
        z-index: 1000;
        display: none;
    }
    
    .search-item {
        padding: 0.75rem;
        border-bottom: 1px solid var(--muted);
        cursor: pointer;
        transition: background-color 0.2s;
        color: var(--fg);
    }
    
    .search-item .text-muted {
        color: var(--muted) !important;
    }
    
    .search-item small {
        color: var(--muted) !important;
    }
    
    .search-item:hover {
        background-color: var(--hover-bg);
    }
    
    .search-item:last-child {
        border-bottom: none;
    }
    
    .carrito-container {
        background: var(--card-bg);
        border-radius: 10px;
        margin: 1rem;
        padding: 1rem;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        max-height: 400px;
        overflow-y: auto;
    }
    
    .carrito-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem;
        border-bottom: 1px solid #eee;
        background: #f8f9fa;
        margin-bottom: 0.5rem;
        border-radius: 5px;
    }
    
    .carrito-item:last-child {
        border-bottom: none;
        margin-bottom: 0;
    }
    
    .item-info {
        flex: 1;
    }
    
    .item-controls {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .quantity-input {
        width: 60px;
        text-align: center;
    }
    
    .price-input {
        width: 80px;
    }
    
    .total-container {
        background: #28a745;
        color: white;
        padding: 1rem;
        margin: 1rem;
        border-radius: 10px;
        text-align: center;
    }
    
    .btn-pos {
        border-radius: 25px;
        padding: 0.75rem 1.5rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .btn-primary-pos {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
    }
    
    .btn-success-pos {
        background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
        border: none;
    }
    
    .btn-danger-pos {
        background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
        border: none;
    }
    
    .stats-row {
        display: flex;
        justify-content: space-around;
        margin: 1rem;
        gap: 0.5rem;
    }
    
    .stat-card {
        background: var(--card-bg);
        border-radius: 10px;
        padding: 1rem;
        text-align: center;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        flex: 1;
    }
    
    .stat-number {
        font-size: 1.5rem;
        font-weight: bold;
        color: var(--btn-bg);
    }
    
    .stat-label {
        font-size: 0.8rem;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    @media (max-width: 768px) {
        .pos-container {
            padding: 0;
        }
        
        .search-container,
        .carrito-container,
        .total-container {
            margin: 0.5rem;
        }
        
        .stats-row {
            margin: 0.5rem;
        }
        
        .carrito-item {
            flex-direction: column;
            align-items: stretch;
            gap: 0.5rem;
        }
        
        .item-controls {
            justify-content: space-between;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="pos-container">
    <!-- Header -->
    <div class="pos-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h4 class="mb-0">
                    <span id="modo-titulo">üõí Punto de Venta</span>
                </h4>
                <small>Sesi√≥n: {{ sesion.id }} - {{ sesion.fecha_inicio|date:"d/m/Y H:i" }}</small>
            </div>
            <div>
                <button type="button" class="btn btn-light btn-sm me-2" onclick="cambiarModo()">
                    <span id="modo-boton">üìã Modo Cotizaci√≥n</span>
                </button>
                <a href="{% url 'pos_dashboard' %}" class="btn btn-light btn-sm me-2">
                    üìä Dashboard
                </a>
                <a href="{% url 'pos_cerrar_sesion' %}" class="btn btn-outline-light btn-sm">
                    üîí Cerrar Sesi√≥n
                </a>
            </div>
        </div>
    </div>

    <!-- Estad√≠sticas r√°pidas -->
    <div class="stats-row">
        <div class="stat-card">
            <div class="stat-number">{{ sesion.numero_ventas }}</div>
            <div class="stat-label">Ventas</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">${{ sesion.total_ventas|floatformat:0|intcomma }}</div>
            <div class="stat-label">Total</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ carrito_items|length }}</div>
            <div class="stat-label">Items</div>
        </div>
    </div>

    <!-- B√∫squeda de repuestos -->
    <div class="search-container">
        <form id="search-form">
            {% csrf_token %}
            <div class="position-relative">
                <input type="text" 
                       id="busqueda-repuesto" 
                       class="form-control form-control-lg" 
                       placeholder="üîç Buscar por nombre, SKU, c√≥digo de barras, OEM, origen, marca veh√≠culo, tipo motor..."
                       autocomplete="off">
                <div id="search-results" class="search-results"></div>
            </div>
        </form>
    </div>

    <!-- Carrito de compras -->
    <div class="carrito-container">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">üõí Carrito de Compras</h5>
            {% if carrito_items %}
                <button type="button" class="btn btn-outline-danger btn-sm" onclick="limpiarCarrito()">
                    üóëÔ∏è Limpiar
                </button>
            {% endif %}
        </div>

        <div id="carrito-items">
            {% for item in carrito_items %}
                <div class="carrito-item" data-item-id="{{ item.id }}">
                    <div class="item-info">
                        <div class="fw-bold">{{ item.repuesto.nombre }}</div>
                        <small class="text-muted">
                            SKU: {{ item.repuesto.sku|default:"N/A" }} | 
                            Stock: {{ item.repuesto.stock|default:0 }}
                        </small>
                    </div>
                    <div class="item-controls">
                        <input type="number" 
                               class="form-control quantity-input" 
                               value="{{ item.cantidad }}" 
                               min="1"
                               onchange="actualizarCantidad({{ item.id }}, this.value)">
                        <span class="text-muted">x</span>
                        <input type="number" 
                               class="form-control price-input" 
                               value="{{ item.precio_unitario }}" 
                               step="0.01"
                               onchange="actualizarPrecio({{ item.id }}, this.value)">
                        <span class="fw-bold text-success">${{ item.subtotal|floatformat:0|intcomma }}</span>
                        <button type="button" 
                                class="btn btn-outline-info btn-sm me-1" 
                                onclick="mostrarCompatibilidad({{ item.repuesto.id }}, '{{ item.repuesto.nombre }}')"
                                title="Ver veh√≠culos compatibles"
                                style="min-width: 35px; font-size: 14px;">
                            üîó
                        </button>
                        <button type="button" 
                                class="btn btn-outline-danger btn-sm" 
                                onclick="eliminarItem({{ item.id }})">
                            ‚ùå
                        </button>
                    </div>
                </div>
            {% empty %}
                <div class="text-center text-muted py-4">
                    <i class="fas fa-shopping-cart fa-3x mb-3"></i>
                    <p>El carrito est√° vac√≠o</p>
                    <small>Busca repuestos para agregar al carrito</small>
                </div>
            {% endfor %}
        </div>
    </div>

    <!-- Total y botones de acci√≥n -->
    {% if carrito_items %}
        <div class="total-container">
            <h3 class="mb-2">Total: ${{ subtotal|floatformat:0|intcomma }}</h3>
            <div class="d-grid gap-2">
                <button type="button" class="btn btn-light btn-pos btn-success-pos" onclick="procesarTransaccion()">
                    <span id="boton-accion">üí≥ PROCESAR VENTA</span>
                </button>
            </div>
        </div>
    {% endif %}

    <!-- Botones de navegaci√≥n -->
    <div class="d-grid gap-2 m-3">
        <a href="{% url 'pos_historial_ventas' %}" class="btn btn-outline-primary btn-pos">
            üìã Historial de Ventas
        </a>
        <a href="{% url 'pos_configuracion' %}" class="btn btn-outline-secondary btn-pos">
            ‚öôÔ∏è Configuraci√≥n
        </a>
    </div>
</div>

<!-- Modal para crear cliente r√°pido -->
<div class="modal fade" id="clienteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Crear Cliente R√°pido</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="cliente-form">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label class="form-label">Nombre *</label>
                        <input type="text" class="form-control" name="nombre" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Tel√©fono</label>
                        <input type="text" class="form-control" name="telefono">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="crearCliente()">Crear</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let searchTimeout;
let isBarcodeMode = false;
let barcodeBuffer = '';
let barcodeTimeout;
let isProcessingBarcode = false;
let lastBarcodeTime = 0;

// ========================
// FUNCIONALIDAD DE COTIZACIONES
// ========================

let modoActual = '{{ modo_actual|default:"venta" }}'; // 'venta' o 'cotizacion'

function cambiarModo() {
    if (modoActual === 'venta') {
        modoActual = 'cotizacion';
        document.getElementById('modo-titulo').textContent = 'üìã Modo Cotizaci√≥n';
        document.getElementById('modo-boton').textContent = 'üõí Modo Venta';
        document.getElementById('boton-accion').textContent = 'üìã GENERAR COTIZACI√ìN';
        
        // Cambiar color del header
        document.querySelector('.pos-header').style.background = 'linear-gradient(135deg, #17a2b8 0%, #138496 100%)';
        
        // Mostrar mensaje informativo
        mostrarMensaje('Modo Cotizaci√≥n activado - No se afectar√° el stock', 'info');
    } else {
        modoActual = 'venta';
        document.getElementById('modo-titulo').textContent = 'üõí Punto de Venta';
        document.getElementById('modo-boton').textContent = 'üìã Modo Cotizaci√≥n';
        document.getElementById('boton-accion').textContent = 'üí≥ PROCESAR VENTA';
        
        // Restaurar color original
        document.querySelector('.pos-header').style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
        
        mostrarMensaje('Modo Venta activado - Se afectar√° el stock', 'success');
    }
    
    // Actualizar modo en el servidor
    actualizarModoEnServidor(modoActual);
}

function actualizarModoEnServidor(modo) {
    // Intentar actualizar el modo en el servidor (opcional)
    try {
        fetch('{% url "pos_actualizar_modo" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({modo: modo})
        })
        .catch(error => {
            console.log('Funci√≥n de actualizaci√≥n de modo no disponible:', error);
        });
    } catch (error) {
        console.log('URL de actualizaci√≥n de modo no configurada');
    }
}

function procesarTransaccion() {
    if (modoActual === 'venta') {
        // Redirigir a procesar venta
        window.location.href = '{% url "pos_procesar_venta" %}';
    } else {
        // Redirigir a procesar cotizaci√≥n
        window.location.href = '{% url "pos_procesar_cotizacion" %}';
    }
}

// ========================
// B√öSQUEDA Y C√ìDIGO DE BARRAS
// ========================

document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('busqueda-repuesto');
    
    // Auto-focus en el campo de b√∫squeda
    searchInput.focus();
    
    // B√∫squeda de repuestos
    searchInput.addEventListener('input', function(e) {
        const query = e.target.value.trim();
        const currentTime = Date.now();
        
        clearTimeout(searchTimeout);
        
        if (query.length < 2) {
            document.getElementById('search-results').style.display = 'none';
            isBarcodeMode = false;
            return;
        }
        
        // Detectar si es c√≥digo de barras (solo n√∫meros, longitud >= 8)
        const isNumeric = /^\d+$/.test(query);
        if (isNumeric && query.length >= 8) {
            isBarcodeMode = true;
            
            // Prevenir m√∫ltiples ejecuciones del mismo c√≥digo de barras
            if (isProcessingBarcode || (currentTime - lastBarcodeTime < 1000)) {
                return;
            }
            
            lastBarcodeTime = currentTime;
            // Para c√≥digos de barras, buscar inmediatamente
            buscarRepuestos(query, true);
        } else {
            isBarcodeMode = false;
            // Para b√∫squeda normal, esperar 300ms
            searchTimeout = setTimeout(() => {
                buscarRepuestos(query, false);
            }, 300);
        }
    });
    
    // Manejo de Enter para c√≥digos de barras
    searchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            const query = this.value.trim();
            if (query.length >= 2) {
                buscarRepuestos(query, true);
            }
        }
    });
});

function buscarRepuestos(query, isDirect = false) {
    // Marcar que estamos procesando un c√≥digo de barras
    if (isDirect) {
        isProcessingBarcode = true;
    }
    
    fetch(`{% url 'pos_buscar_repuestos' %}?q=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => {
            if (isDirect && data.repuestos.length === 1) {
                // Si es b√∫squeda directa y hay exactamente 1 resultado, agregar autom√°ticamente
                const repuesto = data.repuestos[0];
                agregarAlCarrito(repuesto.id, repuesto.nombre, repuesto.precio_venta, repuesto.stock, true);
            } else if (isDirect && data.repuestos.length === 0) {
                // Si es c√≥digo de barras pero no se encuentra
                mostrarStatus('error', 'C√≥digo de barras no encontrado en el inventario');
            } else {
                mostrarResultados(data.repuestos);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            if (isDirect) {
                mostrarStatus('error', 'Error al buscar el c√≥digo de barras');
            }
        })
        .finally(() => {
            // Liberar el flag de procesamiento despu√©s de un delay
            if (isDirect) {
                setTimeout(() => {
                    isProcessingBarcode = false;
                }, 2000);
            }
        });
}

function mostrarResultados(repuestos) {
    const resultsContainer = document.getElementById('search-results');
    
    if (repuestos.length === 0) {
        resultsContainer.innerHTML = '<div class="search-item text-muted">No se encontraron repuestos</div>';
    } else {
        resultsContainer.innerHTML = repuestos.map(repuesto => `
            <div class="search-item" onclick="agregarAlCarrito(${repuesto.id}, '${repuesto.nombre}', ${repuesto.precio_venta}, ${repuesto.stock}, false)">
                <div class="fw-bold">${repuesto.nombre}</div>
                <small class="text-muted">
                    SKU: ${repuesto.sku} | Stock: ${repuesto.stock} | $${repuesto.precio_venta}
                </small>
            </div>
        `).join('');
    }
    
    resultsContainer.style.display = 'block';
}

// Ocultar resultados al hacer clic fuera
document.addEventListener('click', function(e) {
    if (!e.target.closest('.search-container')) {
        document.getElementById('search-results').style.display = 'none';
    }
});

function agregarAlCarrito(repuestoId, nombre, precio, stock, isDirect = false) {
    if (stock <= 0) {
        mostrarMensaje('No hay stock disponible para este repuesto', 'error');
        return;
    }
    
    // Prevenir m√∫ltiples agregados del mismo producto en poco tiempo
    const currentTime = Date.now();
    const lastAddKey = `last_add_${repuestoId}`;
    const lastAddTime = window[lastAddKey] || 0;
    
    if (isDirect && (currentTime - lastAddTime < 2000)) {
        console.log('Prevenido agregado duplicado del mismo producto');
        return;
    }
    
    if (isDirect) {
        window[lastAddKey] = currentTime;
    }
    
    const formData = new FormData();
    formData.append('repuesto_id', repuestoId);
    formData.append('cantidad', 1); // Siempre 1 unidad para c√≥digos de barras
    formData.append('precio_unitario', precio);
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    fetch('{% url "pos_agregar_carrito" %}', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const mensaje = isDirect ? 
                `‚úÖ ${nombre} agregado (c√≥digo de barras)` : 
                `‚úÖ ${nombre} agregado al carrito`;
            mostrarMensaje(mensaje, 'success');
            
            // Limpiar campo de b√∫squeda y mantener foco
            const searchInput = document.getElementById('busqueda-repuesto');
            searchInput.value = '';
            searchInput.focus();
            
            // Ocultar resultados
            document.getElementById('search-results').style.display = 'none';
            
            // Recargar p√°gina para mostrar el nuevo item
            location.reload();
        } else {
            mostrarMensaje('Error: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        mostrarMensaje('Error al agregar al carrito', 'error');
    });
}

// ========================
// GESTI√ìN DEL CARRITO
// ========================

function actualizarCantidad(itemId, cantidad) {
    actualizarItem(itemId, 'cantidad', cantidad);
}

function actualizarPrecio(itemId, precio) {
    actualizarItem(itemId, 'precio_unitario', precio);
}

function actualizarItem(itemId, campo, valor) {
    const formData = new FormData();
    formData.append(campo, valor);
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    fetch(`{% url "pos_actualizar_carrito" 0 %}`.replace('0', itemId), {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al actualizar item');
    });
}

function eliminarItem(itemId) {
    if (!confirm('¬øEliminar este item del carrito?')) return;
    
    fetch(`{% url "pos_eliminar_carrito" 0 %}`.replace('0', itemId), {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al eliminar item');
    });
}

function limpiarCarrito() {
    if (!confirm('¬øLimpiar todo el carrito?')) return;
    
    fetch('{% url "pos_limpiar_carrito" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => {
        if (response.ok) {
            location.reload();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al limpiar carrito');
    });
}

// ========================
// GESTI√ìN DE CLIENTES
// ========================

function crearCliente() {
    const form = document.getElementById('cliente-form');
    const formData = new FormData(form);
    
    fetch('{% url "pos_crear_cliente" %}', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Cliente creado exitosamente');
            bootstrap.Modal.getInstance(document.getElementById('clienteModal')).hide();
            form.reset();
        } else {
            alert('Error: ' + JSON.stringify(data.errors));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al crear cliente');
    });
}

// ========================
// UTILIDADES
// ========================

function mostrarMensaje(texto, tipo) {
    // Crear elemento de mensaje
    const mensaje = document.createElement('div');
    mensaje.className = `alert alert-${tipo} alert-dismissible fade show position-fixed`;
    mensaje.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    mensaje.innerHTML = `
        ${texto}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(mensaje);
    
    // Auto-remover despu√©s de 3 segundos
    setTimeout(() => {
        if (mensaje.parentNode) {
            mensaje.remove();
        }
    }, 3000);
}

function mostrarStatus(tipo, mensaje) {
    // Funci√≥n para mostrar mensajes de estado en el POS
    const statusDiv = document.createElement('div');
    statusDiv.className = `alert alert-${tipo === 'error' ? 'danger' : tipo} alert-dismissible fade show position-fixed`;
    statusDiv.style.cssText = 'top: 80px; right: 20px; z-index: 9998; min-width: 300px;';
    statusDiv.innerHTML = `
        ${mensaje}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // Agregar al DOM
    document.body.appendChild(statusDiv);
    
    // Auto-remover despu√©s de 4 segundos
    setTimeout(() => {
        if (statusDiv.parentNode) {
            statusDiv.remove();
        }
    }, 4000);
}

// Mantener foco en el campo de b√∫squeda despu√©s de recargar
window.addEventListener('load', function() {
    setTimeout(() => {
        const searchInput = document.getElementById('busqueda-repuesto');
        if (searchInput) {
            searchInput.focus();
        }
        
        // Inicializar el modo correcto en la interfaz
        if (modoActual === 'cotizacion') {
            document.getElementById('modo-titulo').textContent = 'üìã Modo Cotizaci√≥n';
            document.getElementById('modo-boton').textContent = 'üõí Modo Venta';
            document.getElementById('boton-accion').textContent = 'üìã GENERAR COTIZACI√ìN';
            document.querySelector('.pos-header').style.background = 'linear-gradient(135deg, #17a2b8 0%, #138496 100%)';
        }
    }, 100);
});

// Funci√≥n para mostrar compatibilidad de repuestos
function mostrarCompatibilidad(repuestoId, repuestoNombre) {
    // Crear modal din√°micamente
    const modalHtml = `
        <div class="modal fade" id="modalCompatibilidad" tabindex="-1" aria-labelledby="modalCompatibilidadLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalCompatibilidadLabel">
                            üîó Veh√≠culos Compatibles
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <strong>Repuesto:</strong> ${repuestoNombre}
                        </div>
                        <div id="compatibilidad-content">
                            <div class="text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Cargando...</span>
                                </div>
                                <p class="mt-2">Cargando veh√≠culos compatibles...</p>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remover modal existente si existe
    const existingModal = document.getElementById('modalCompatibilidad');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Agregar modal al DOM
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Mostrar modal
    const modal = new bootstrap.Modal(document.getElementById('modalCompatibilidad'));
    modal.show();
    
    // Cargar datos de compatibilidad
    cargarCompatibilidad(repuestoId);
}

// Funci√≥n para cargar datos de compatibilidad
function cargarCompatibilidad(repuestoId) {
    fetch(`/car/api/repuesto-compatibilidad/${repuestoId}/`)
        .then(response => response.json())
        .then(data => {
            const content = document.getElementById('compatibilidad-content');
            
            if (data.vehiculos && data.vehiculos.length > 0) {
                let html = '<div class="row">';
                
                data.vehiculos.forEach(vehiculo => {
                    html += `
                        <div class="col-md-6 mb-3">
                            <div class="card">
                                <div class="card-body">
                                    <h6 class="card-title">${vehiculo.marca} ${vehiculo.modelo}</h6>
                                    <p class="card-text">
                                        <small class="text-muted">
                                            A√±os: ${vehiculo.anio_desde}-${vehiculo.anio_hasta}<br>
                                            ${vehiculo.motor ? `Motor: ${vehiculo.motor}<br>` : ''}
                                            ${vehiculo.carroceria ? `Carrocer√≠a: ${vehiculo.carroceria}<br>` : ''}
                                            ${vehiculo.posicion ? `Posici√≥n: ${vehiculo.posicion}` : ''}
                                        </small>
                                    </p>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                content.innerHTML = html;
            } else {
                content.innerHTML = `
                    <div class="text-center text-muted">
                        <i class="fas fa-car fa-3x mb-3"></i>
                        <p>No hay veh√≠culos compatibles registrados para este repuesto.</p>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error cargando compatibilidad:', error);
            document.getElementById('compatibilidad-content').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i>
                    Error al cargar los veh√≠culos compatibles.
                </div>
            `;
        });
}
</script>
{% endblock %}
