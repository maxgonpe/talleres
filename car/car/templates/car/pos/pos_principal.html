{% extends "base.html" %}
{% load static %}
{% load humanize %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'css/centralized-colors.css' %}">
{% endblock %}

{% block title %}Punto de Venta - POS{% endblock %}

{% block extra_head %}
<script>
    // Aplicar tema automáticamente al cargar
    document.addEventListener('DOMContentLoaded', function() {
        const saved = localStorage.getItem("theme") || "piedra";
        document.body.className = `theme-${saved}`;
    });
</script>
<style>
    .pos-container {
        max-width: 100%;
        margin: 0;
        padding: 0;
    }
    
    .pos-header {
        background: linear-gradient(135deg, var(--btn-bg) 0%, var(--muted) 100%);
        color: var(--btn-fg);
        padding: var(--spacing-md);
        position: sticky;
        top: 0;
        z-index: 1000;
    }
    
    .search-container {
        background: var(--card-bg);
        border-radius: var(--border-radius-lg);
        padding: var(--spacing-md);
        margin: var(--spacing-md);
        box-shadow: var(--shadow-md);
    }
    
    .search-results {
        max-height: 300px;
        overflow-y: auto;
        border: 2px solid #dee2e6;
        border-radius: var(--border-radius-sm);
        background: #ffffff !important;
        position: absolute;
        width: 100%;
        z-index: 1000;
        display: none;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
    }
    
    body.theme-oscuro .search-results {
        background: #2d2d2d !important;
        border-color: #555;
    }
    
    .search-item {
        padding: 0.75rem;
        border-bottom: 1px solid #e0e0e0;
        cursor: pointer;
        transition: var(--transition-fast);
        color: #333 !important;
        background: #ffffff;
    }
    
    body.theme-oscuro .search-item {
        color: #e0e0e0 !important;
        background: #2d2d2d;
        border-bottom-color: #444;
    }
    
    .search-item .fw-bold {
        color: #333 !important;
        font-weight: 600 !important;
    }
    
    body.theme-oscuro .search-item .fw-bold {
        color: #ffffff !important;
    }
    
    .search-item .text-secondary,
    .search-item small {
        color: #666 !important;
    }
    
    body.theme-oscuro .search-item .text-secondary,
    body.theme-oscuro .search-item small {
        color: #999 !important;
    }
    
    .search-item:hover {
        background-color: #f0f0f0 !important;
    }
    
    body.theme-oscuro .search-item:hover {
        background-color: #3a3a3a !important;
    }
    
    .search-item:last-child {
        border-bottom: none;
    }
    
    .carrito-container {
        background: var(--card-bg);
        border-radius: var(--border-radius-lg);
        margin: var(--spacing-md);
        padding: var(--spacing-md);
        box-shadow: var(--shadow-md);
        max-height: 400px;
        overflow-y: auto;
    }
    
    .carrito-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem;
        border-bottom: 1px solid var(--border-color);
        background-color: var(--bg-secondary);
        margin-bottom: 0.5rem;
        border-radius: var(--border-radius-sm);
        gap: 1rem;
    }
    
    .carrito-item:last-child {
        border-bottom: none;
        margin-bottom: 0;
    }
    
    .item-info {
        flex: 1;
    }
    
    .item-controls {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        flex-wrap: nowrap;
        min-width: 0;
    }
    
    .quantity-input {
        width: 80px;
        text-align: center;
        min-width: 80px;
    }
    
    .price-input {
        width: 120px;
        min-width: 120px;
    }
    
    .total-container {
        background: #28a745;
        color: var(--text-inverse);
        padding: var(--spacing-md);
        margin: var(--spacing-md);
        border-radius: var(--border-radius-lg);
        text-align: center;
    }
    
    .btn-pos {
        border-radius: var(--border-radius-full);
        padding: 0.75rem 1.5rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .btn-primary-pos {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
    }
    
    .btn-success-pos {
        background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
        border: none;
    }
    
    .btn-danger-pos {
        background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
        border: none;
    }
    
    .stats-row {
        display: flex;
        justify-content: space-around;
        margin: var(--spacing-md);
        gap: 0.5rem;
    }
    
    .stat-card {
        background: var(--card-bg);
        border-radius: var(--border-radius-lg);
        padding: var(--spacing-md);
        text-align: center;
        box-shadow: var(--shadow-md);
        flex: 1;
    }
    
    .stat-number {
        font-size: 1.5rem;
        font-weight: bold;
        color: var(--btn-bg);
    }
    
    .stat-label {
        font-size: 0.8rem;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    @media (max-width: 768px) {
        .pos-container {
            padding: 0;
        }
        
        .search-container,
        .carrito-container,
        .total-container {
            margin: var(--spacing-sm);
        }
        
        .stats-row {
            margin: var(--spacing-sm);
        }
        
        .carrito-item {
            flex-direction: column;
            align-items: stretch;
            gap: 0.5rem;
        }
        
        .item-controls {
            justify-content: space-between;
        }
    }
    
    /* ========================
       ESTILOS PARA MODALES DE BOOTSTRAP
       ======================== */
    
    /* Fondo del backdrop del modal */
    .modal-backdrop {
        background-color: rgba(0, 0, 0, 0.7);
    }
    
    /* Contenido del modal con fondo sólido */
    .modal-content {
        background: #ffffff !important;
        border: 2px solid #e0e0e0;
        border-radius: 1rem;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    }
    
    /* Tema oscuro para modales */
    body.theme-oscuro .modal-content {
        background: #2d2d2d !important;
        border-color: #444;
    }
    
    /* Header del modal */
    .modal-header {
        background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%);
        color: #ffffff;
        border-bottom: none;
        border-radius: 1rem 1rem 0 0;
    }
    
    .modal-header .modal-title {
        color: #ffffff !important;
        font-weight: 600;
    }
    
    .modal-header .btn-close {
        filter: brightness(0) invert(1);
    }
    
    /* Body del modal */
    .modal-body {
        background: #ffffff !important;
        color: #333 !important;
        padding: 1.5rem;
    }
    
    body.theme-oscuro .modal-body {
        background: #2d2d2d !important;
        color: #e0e0e0 !important;
    }
    
    .modal-body strong {
        color: #333;
    }
    
    body.theme-oscuro .modal-body strong {
        color: #e0e0e0;
    }
    
    .modal-body .text-secondary {
        color: #666 !important;
    }
    
    body.theme-oscuro .modal-body .text-secondary {
        color: #999 !important;
    }
    
    /* Cards dentro del modal */
    .modal-body .card {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
    }
    
    body.theme-oscuro .modal-body .card {
        background: #1a1a1a;
        border-color: #444;
    }
    
    .modal-body .card-body {
        color: #333;
    }
    
    body.theme-oscuro .modal-body .card-body {
        color: #e0e0e0;
    }
    
    .modal-body .card-title {
        color: #333 !important;
    }
    
    body.theme-oscuro .modal-body .card-title {
        color: #e0e0e0 !important;
    }
    
    /* Footer del modal */
    .modal-footer {
        background: #f5f5f5;
        border-top: 1px solid #e0e0e0;
        border-radius: 0 0 1rem 1rem;
    }
    
    body.theme-oscuro .modal-footer {
        background: #1a1a1a;
        border-top-color: #444;
    }
    
    /* Alerts dentro del modal */
    .modal-body .alert {
        background: #e3f2fd;
        border: 1px solid #90caf9;
        color: #1565c0;
    }
    
    body.theme-oscuro .modal-body .alert {
        background: #1a3a52;
        border-color: #2980b9;
        color: #90caf9;
    }
    
    /* Badges dentro del modal */
    .modal-body .badge {
        opacity: 1 !important;
    }
    
    /* Spinner de carga */
    .modal-body .spinner-border {
        color: #4a90e2;
    }
    
    body.theme-oscuro .modal-body .spinner-border {
        color: #90caf9;
    }
    
    /* Inputs y selects dentro del modal */
    .modal-body .form-control,
    .modal-body .form-select {
        background: #f8f9fa !important;
        border: 1px solid #ced4da !important;
        color: #333 !important;
    }
    
    body.theme-oscuro .modal-body .form-control,
    body.theme-oscuro .modal-body .form-select {
        background: #1a1a1a !important;
        border-color: #555 !important;
        color: #e0e0e0 !important;
    }
    
    .modal-body .form-control:focus,
    .modal-body .form-select:focus {
        background: #ffffff !important;
        border-color: #4a90e2 !important;
        color: #333 !important;
        box-shadow: 0 0 0 0.2rem rgba(74, 144, 226, 0.25);
    }
    
    body.theme-oscuro .modal-body .form-control:focus,
    body.theme-oscuro .modal-body .form-select:focus {
        background: #2d2d2d !important;
        border-color: #4a90e2 !important;
        color: #e0e0e0 !important;
    }
    
    .modal-body .form-label {
        color: #333 !important;
        font-weight: 500;
    }
    
    body.theme-oscuro .modal-body .form-label {
        color: #e0e0e0 !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="pos-container">
    <!-- Header -->
    <div class="pos-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h4 class="mb-0">
                    <span id="modo-titulo">🛒 Punto de Venta</span>
                </h4>
                <small>Sesión: {{ sesion.id }} - {{ sesion.fecha_inicio|date:"d/m/Y H:i" }}</small>
            </div>
            <div>
                <button type="button" class="btn btn-light btn-sm me-2" onclick="cambiarModo()">
                    <span id="modo-boton">📋 Modo Cotización</span>
                </button>
                <a href="{% url 'pos_dashboard' %}" class="btn btn-light btn-sm me-2">
                    📊 Dashboard
                </a>
                <a href="{% url 'pos_cerrar_sesion' %}" class="btn btn-outline-light btn-sm">
                    🔒 Cerrar Sesión
                </a>
            </div>
        </div>
    </div>

    <!-- Estadísticas rápidas -->
    <div class="stats-row">
        <div class="stat-card">
            <div class="stat-number">{{ sesion.numero_ventas }}</div>
            <div class="stat-label">Ventas</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">${{ sesion.total_ventas|floatformat:0|intcomma }}</div>
            <div class="stat-label">Total</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ carrito_items|length }}</div>
            <div class="stat-label">Items</div>
        </div>
    </div>

    <!-- Búsqueda de repuestos -->
    <div class="search-container">
        <form id="search-form">
            {% csrf_token %}
            <div class="position-relative">
                <input type="text" 
                       id="busqueda-repuesto" 
                       class="form-control form-control-lg" 
                       placeholder="🔍 Buscar por nombre, SKU, código de barras..."
                       autocomplete="off">
                <div id="search-results" class="search-results"></div>
            </div>
        </form>
    </div>

    <!-- Carrito de compras -->
    <div class="carrito-container">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">🛒 Carrito de Compras</h5>
            <div class="btn-group" role="group">
                {% if carrito_items %}
                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="limpiarCarrito()">
                        🗑️ Limpiar Carrito
                    </button>
                {% endif %}
                <button type="button" class="btn btn-outline-warning btn-sm" onclick="limpiarSesiones()">
                    🔄 Nueva Sesión
                </button>
            </div>
        </div>

        <div id="carrito-items">
            {% for item in carrito_items %}
                <div class="carrito-item" data-item-id="{{ item.id }}">
                    <div class="item-info">
                        <div class="fw-bold">{{ item.repuesto.nombre }}</div>
                        <small class="text-secondary">
                            SKU: {{ item.repuesto.sku|default:"N/A" }} | 
                            Stock: {{ item.repuesto.stock_total|default:0 }}
                        </small>
                    </div>
                    <div class="item-controls">
                        <input type="number" 
                               class="form-control quantity-input" 
                               value="{{ item.cantidad }}" 
                               min="1"
                               onchange="actualizarCantidad({{ item.id }}, this.value)">
                        <span class="text-secondary">x</span>
                        <input type="number" 
                               class="form-control price-input" 
                               value="{{ item.precio_unitario }}" 
                               step="0.01"
                               onchange="actualizarPrecio({{ item.id }}, this.value)">
                        <span class="fw-bold text-success">${{ item.subtotal|floatformat:0|intcomma }}</span>
                        <button type="button" 
                                class="btn btn-outline-info btn-sm me-1" 
                                onclick="mostrarCompatibilidad({{ item.repuesto.id }}, '{{ item.repuesto.nombre }}')"
                                title="Ver vehículos compatibles"
                                style="min-width: 35px; font-size: 14px;">
                            🔗
                        </button>
                        <button type="button" 
                                class="btn btn-outline-danger btn-sm" 
                                onclick="eliminarItem({{ item.id }})">
                            ❌
                        </button>
                    </div>
                </div>
            {% empty %}
                <div class="text-center text-secondary py-4">
                    <i class="fas fa-shopping-cart fa-3x mb-3"></i>
                    <p>El carrito está vacío</p>
                    <small>Busca repuestos para agregar al carrito</small>
                </div>
            {% endfor %}
        </div>
    </div>

    <!-- Total y botones de acción -->
    {% if carrito_items %}
        <div class="total-container">
            <h3 class="mb-2">Total: ${{ subtotal|floatformat:0|intcomma }}</h3>
            <div class="d-grid gap-2">
                <button type="button" class="btn btn-light btn-pos btn-success-pos" onclick="procesarTransaccion()">
                    <span id="boton-accion">💳 PROCESAR VENTA</span>
                </button>
            </div>
        </div>
    {% endif %}

    <!-- Botones de navegación -->
    <div class="d-grid gap-2 m-3">
        <a href="{% url 'pos_historial_ventas' %}" class="btn btn-outline-primary btn-pos">
            📋 Historial de Ventas
        </a>
        <a href="{% url 'pos_configuracion' %}" class="btn btn-outline-secondary btn-pos">
            ⚙️ Configuración
        </a>
    </div>
</div>

<!-- Modal para crear cliente rápido -->
<div class="modal fade" id="clienteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">👤 Crear Cliente Rápido</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="cliente-form">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label class="form-label"><strong>Nombre *</strong></label>
                        <input type="text" class="form-control" name="nombre" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label"><strong>Teléfono</strong></label>
                        <input type="text" class="form-control" name="telefono">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="crearCliente()">
                    <i class="fas fa-save me-2"></i>Crear
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let searchTimeout;

// Variables para detección de código de barras
let barcodeBuffer = '';
let barcodeTimeout;
let lastBarcodeTime = 0;
const BARCODE_MIN_LENGTH = 8; // Longitud mínima para considerar código de barras
const BARCODE_TIMEOUT = 100; // Tiempo máximo entre caracteres para considerar código de barras

// Búsqueda de repuestos
document.getElementById('busqueda-repuesto').addEventListener('input', function(e) {
    const query = e.target.value.trim();
    
    clearTimeout(searchTimeout);
    
    // Detectar si es un código de barras (solo números y longitud mínima)
    if (query.length >= BARCODE_MIN_LENGTH && /^\d+$/.test(query)) {
        // Es un código de barras, procesar inmediatamente
        clearTimeout(barcodeTimeout);
        barcodeTimeout = setTimeout(() => {
            procesarCodigoBarras(query);
        }, BARCODE_TIMEOUT);
        return;
    }
    
    if (query.length < 2) {
        document.getElementById('search-results').style.display = 'none';
        return;
    }
    
    searchTimeout = setTimeout(() => {
        buscarRepuestos(query);
    }, 300);
});

// Detectar Enter para códigos de barras
document.getElementById('busqueda-repuesto').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        const query = e.target.value.trim();
        
        // Si es un código de barras, procesarlo
        if (query.length >= BARCODE_MIN_LENGTH && /^\d+$/.test(query)) {
            procesarCodigoBarras(query);
        }
    }
});

function procesarCodigoBarras(codigoBarras) {
    console.log('🔍 Procesando código de barras:', codigoBarras);
    
    // Buscar el repuesto por código de barras
    fetch(`{% url 'pos_buscar_repuestos' %}?q=${encodeURIComponent(codigoBarras)}`)
        .then(response => response.json())
        .then(data => {
            if (data.repuestos && data.repuestos.length > 0) {
                const repuesto = data.repuestos[0];
                
                // Verificar si hay stock
                if (repuesto.stock > 0) {
                    // Agregar directamente al carrito
                    agregarAlCarritoDirecto(repuesto.id, repuesto.nombre, repuesto.precio_venta, repuesto.stock);
                } else {
                    mostrarMensaje(`❌ Sin stock para: ${repuesto.nombre}`, 'warning');
                    limpiarCampoBusqueda();
                }
            } else {
                mostrarMensaje(`❌ Producto no encontrado: ${codigoBarras}`, 'danger');
                limpiarCampoBusqueda();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            mostrarMensaje('❌ Error al buscar producto', 'danger');
            limpiarCampoBusqueda();
        });
}

function buscarRepuestos(query) {
    fetch(`{% url 'pos_buscar_repuestos' %}?q=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => {
            mostrarResultados(data.repuestos);
        })
        .catch(error => {
            console.error('Error:', error);
        });
}

function mostrarResultados(repuestos) {
    const resultsContainer = document.getElementById('search-results');
    
    if (repuestos.length === 0) {
        resultsContainer.innerHTML = '<div class="search-item text-secondary">No se encontraron repuestos</div>';
    } else {
        resultsContainer.innerHTML = repuestos.map(repuesto => `
            <div class="search-item" onclick="agregarAlCarrito(${repuesto.id}, '${repuesto.nombre}', ${repuesto.precio_venta}, ${repuesto.stock})">
                <div class="fw-bold">${repuesto.nombre}</div>
                <small class="text-secondary">
                    SKU: ${repuesto.sku} | Stock: ${repuesto.stock} | $${repuesto.precio_venta}
                </small>
            </div>
        `).join('');
    }
    
    resultsContainer.style.display = 'block';
}

// Ocultar resultados al hacer clic fuera
document.addEventListener('click', function(e) {
    if (!e.target.closest('.search-container')) {
        document.getElementById('search-results').style.display = 'none';
    }
});

function agregarAlCarritoDirecto(repuestoId, nombre, precio, stock) {
    console.log('🛒 Agregando directamente al carrito:', nombre);
    
    const formData = new FormData();
    formData.append('repuesto_id', repuestoId);
    formData.append('cantidad', 1);
    formData.append('precio_unitario', precio);
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    fetch('{% url "pos_agregar_carrito" %}', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            mostrarMensaje(`✅ ${nombre} agregado al carrito`, 'success');
            limpiarCampoBusqueda();
            // Recargar la página manteniendo el modo
            location.reload();
        } else {
            mostrarMensaje(`❌ Error: ${data.error}`, 'danger');
            limpiarCampoBusqueda();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        mostrarMensaje('❌ Error al agregar al carrito', 'danger');
        limpiarCampoBusqueda();
    });
}

function limpiarCampoBusqueda() {
    const campoBusqueda = document.getElementById('busqueda-repuesto');
    campoBusqueda.value = '';
    campoBusqueda.focus();
    document.getElementById('search-results').style.display = 'none';
}

function agregarAlCarrito(repuestoId, nombre, precio, stock) {
    if (stock <= 0) {
        alert('No hay stock disponible para este repuesto');
        return;
    }
    
    const formData = new FormData();
    formData.append('repuesto_id', repuestoId);
    formData.append('cantidad', 1);
    formData.append('precio_unitario', precio);
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    fetch('{% url "pos_agregar_carrito" %}', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Ocultar resultados de búsqueda
            document.getElementById('search-results').style.display = 'none';
            
            // Limpiar campo de búsqueda
            document.getElementById('busqueda-repuesto').value = '';
            
            // Recargar la página manteniendo el modo
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al agregar al carrito');
    });
}

function actualizarCantidad(itemId, cantidad) {
    actualizarItem(itemId, 'cantidad', cantidad);
}

function actualizarPrecio(itemId, precio) {
    actualizarItem(itemId, 'precio_unitario', precio);
}

function actualizarItem(itemId, campo, valor) {
    const formData = new FormData();
    formData.append(campo, valor);
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    fetch(`{% url "pos_actualizar_carrito" 0 %}`.replace('0', itemId), {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Recargar manteniendo el modo
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al actualizar item');
    });
}

function eliminarItem(itemId) {
    if (!confirm('¿Eliminar este item del carrito?')) return;
    
    fetch(`{% url "pos_eliminar_carrito" 0 %}`.replace('0', itemId), {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Recargar manteniendo el modo
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al eliminar item');
    });
}

function limpiarCarrito() {
    if (!confirm('¿Limpiar todo el carrito?')) return;
    
    fetch('{% url "pos_limpiar_carrito" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => {
        if (response.ok) {
            // Recargar manteniendo el modo
            location.reload();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al limpiar carrito');
    });
}

function limpiarSesiones() {
    if (!confirm('¿Limpiar todas las sesiones y comenzar desde cero?\n\nEsto cerrará todas las sesiones activas y limpiará carritos antiguos.')) return;
    
    window.location.href = '{% url "pos_limpiar_sesiones" %}';
}

function crearCliente() {
    const form = document.getElementById('cliente-form');
    const formData = new FormData(form);
    
    fetch('{% url "pos_crear_cliente" %}', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Cliente creado exitosamente');
            bootstrap.Modal.getInstance(document.getElementById('clienteModal')).hide();
            form.reset();
        } else {
            alert('Error: ' + JSON.stringify(data.errors));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al crear cliente');
    });
}

// Soporte para escáner de código de barras
document.getElementById('busqueda-repuesto').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        const query = this.value.trim();
        if (query.length >= 8) { // Códigos de barras suelen ser largos
            buscarRepuestos(query);
        }
    }
});

// ========================
// FUNCIONALIDAD DE COTIZACIONES
// ========================

let modoActual = 'venta'; // 'venta' o 'cotizacion'

// Inicializar modo desde localStorage o sesión
function inicializarModo() {
    const modoGuardado = localStorage.getItem('pos_modo') || 'venta';
    modoActual = modoGuardado;
    aplicarModo();
}

function cambiarModo() {
    if (modoActual === 'venta') {
        modoActual = 'cotizacion';
    } else {
        modoActual = 'venta';
    }
    
    // Guardar en localStorage para persistir entre recargas
    localStorage.setItem('pos_modo', modoActual);
    localStorage.setItem('pos_modo_cambiado', 'true'); // Marcar que se cambió manualmente
    
    aplicarModo();
}

function aplicarModo() {
    if (modoActual === 'cotizacion') {
        document.getElementById('modo-titulo').textContent = '📋 Modo Cotización';
        document.getElementById('modo-boton').textContent = '🛒 Modo Venta';
        document.getElementById('boton-accion').textContent = '📋 GENERAR COTIZACIÓN';
        
        // Cambiar color del header
        document.querySelector('.pos-header').style.background = 'linear-gradient(135deg, #17a2b8 0%, #138496 100%)';
        
        // Mostrar mensaje informativo solo si se cambió manualmente
        if (localStorage.getItem('pos_modo_cambiado') === 'true') {
            mostrarMensaje('Modo Cotización activado - No se afectará el stock', 'info');
            localStorage.removeItem('pos_modo_cambiado');
        }
    } else {
        document.getElementById('modo-titulo').textContent = '🛒 Punto de Venta';
        document.getElementById('modo-boton').textContent = '📋 Modo Cotización';
        document.getElementById('boton-accion').textContent = '💳 PROCESAR VENTA';
        
        // Restaurar color original
        document.querySelector('.pos-header').style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
        
        // Mostrar mensaje informativo solo si se cambió manualmente
        if (localStorage.getItem('pos_modo_cambiado') === 'true') {
            mostrarMensaje('Modo Venta activado - Se afectará el stock', 'success');
            localStorage.removeItem('pos_modo_cambiado');
        }
    }
}

function procesarTransaccion() {
    if (modoActual === 'venta') {
        // Redirigir a procesar venta
        window.location.href = '{% url "pos_procesar_venta" %}';
    } else {
        // Redirigir a procesar cotización
        window.location.href = '{% url "pos_procesar_cotizacion" %}';
    }
}

function mostrarMensaje(texto, tipo) {
    // Crear elemento de mensaje
    const mensaje = document.createElement('div');
    mensaje.className = `alert alert-${tipo} alert-dismissible fade show position-fixed`;
    mensaje.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    mensaje.innerHTML = `
        ${texto}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(mensaje);
    
    // Auto-remover después de 3 segundos
    setTimeout(() => {
        if (mensaje.parentNode) {
            mensaje.remove();
        }
    }, 3000);
}

// Inicializar modo al cargar la página
document.addEventListener('DOMContentLoaded', function() {
    inicializarModo();
    
    // Enfocar automáticamente el campo de búsqueda
    const campoBusqueda = document.getElementById('busqueda-repuesto');
    if (campoBusqueda) {
        campoBusqueda.focus();
    }
});

// Función para mostrar compatibilidad de repuestos
function mostrarCompatibilidad(repuestoId, repuestoNombre) {
    // Crear modal dinámicamente
    const modalHtml = `
        <div class="modal fade" id="modalCompatibilidad" tabindex="-1" aria-labelledby="modalCompatibilidadLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalCompatibilidadLabel">
                            🔗 Vehículos Compatibles
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <strong>Repuesto:</strong> ${repuestoNombre}
                        </div>
                        <div id="compatibilidad-content">
                            <div class="text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Cargando...</span>
                                </div>
                                <p class="mt-2">Cargando vehículos compatibles...</p>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remover modal existente si existe
    const existingModal = document.getElementById('modalCompatibilidad');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Agregar modal al DOM
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Mostrar modal
    const modal = new bootstrap.Modal(document.getElementById('modalCompatibilidad'));
    modal.show();
    
    // Cargar datos de compatibilidad
    cargarCompatibilidad(repuestoId);
}

// Función para cargar datos de compatibilidad
function cargarCompatibilidad(repuestoId) {
    fetch(`/car/api/repuesto-compatibilidad/${repuestoId}/`)
        .then(response => response.json())
        .then(data => {
            const content = document.getElementById('compatibilidad-content');
            
            if (data.vehiculos && data.vehiculos.length > 0) {
                let html = '<div class="row">';
                
                data.vehiculos.forEach(vehiculo => {
                    let badgeClass = 'bg-primary';
                    let badgeText = 'Directo';
                    
                    if (vehiculo.tipo === 'coincidencia_motor') {
                        badgeClass = 'bg-warning';
                        badgeText = 'Coincidencia Motor';
                    } else if (vehiculo.tipo === 'coincidencia_carroceria') {
                        badgeClass = 'bg-info';
                        badgeText = 'Coincidencia Carrocería';
                    }
                    
                    html += `
                        <div class="col-md-6 mb-3">
                            <div class="card">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <h6 class="card-title mb-0">${vehiculo.marca} ${vehiculo.modelo}</h6>
                                        <span class="badge ${badgeClass}">${badgeText}</span>
                                    </div>
                                    <p class="card-text">
                                        <small class="text-secondary">
                                            Años: ${vehiculo.anio_desde}-${vehiculo.anio_hasta}<br>
                                            ${vehiculo.motor ? `Motor: ${vehiculo.motor}<br>` : ''}
                                            ${vehiculo.carroceria ? `Carrocería: ${vehiculo.carroceria}<br>` : ''}
                                            ${vehiculo.posicion ? `Posición: ${vehiculo.posicion}` : ''}
                                        </small>
                                    </p>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                content.innerHTML = html;
            } else {
                content.innerHTML = `
                    <div class="text-center text-secondary">
                        <i class="fas fa-car fa-3x mb-3"></i>
                        <p>No hay vehículos compatibles registrados para este repuesto.</p>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error cargando compatibilidad:', error);
            document.getElementById('compatibilidad-content').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i>
                    Error al cargar los vehículos compatibles.
                </div>
            `;
        });
}
</script>

<!-- Componente de búsqueda externa de repuestos -->
{% include 'car/busqueda_externa_repuestos.html' %}

{% endblock %}
