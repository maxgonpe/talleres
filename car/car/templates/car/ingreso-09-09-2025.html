{% extends 'base.html' %}
{% load crispy_forms_tags %}
{% load static %}
{% block content %}

<div class="container py-4">
  <h2>Ingreso de Diagnóstico</h2>

  <form id="form-ingreso" method="post" novalidate>
    {% csrf_token %}

    <!-- ---------------- CLIENTE ---------------- -->
    <h3>Cliente</h3>
    <div class="mb-3">
      <label class="form-label">Elegir cliente existente:</label>
      <select id="cliente_existente" name="cliente_existente" class="form-select">
        <option value="">-- Nuevo cliente --</option>
        {% for cliente in clientes_existentes %}
          <option value="{{ cliente.id }}"
            {% if selected_cliente and selected_cliente|stringformat:"s" == cliente.id|stringformat:"s" %} selected {% endif %}>
            {{ cliente.nombre }} - {{ cliente.telefono }}
          </option>
        {% endfor %}
      </select>
    </div>
    <div id="nuevo_cliente_campos">
      {{ cliente_form|crispy }}
    </div>
    <hr>

    <!-- ---------------- VEHÍCULO ---------------- -->
    <h3>Vehículo</h3>
    <div class="mb-3">
      <label class="form-label">Seleccionar vehículo existente:</label>
      <select id="vehiculo_select" name="vehiculo_existente" class="form-select" data-selected="{{ selected_vehiculo|default:'' }}">
        <option value="">-- Nuevo vehículo --</option>
      </select>
    </div>
    <div id="vehiculo_fields">
      {{ vehiculo_form|crispy }}
    </div>
    <hr>

    <!-- ---------------- DIAGNÓSTICO ---------------- -->
    <h3>Diagnóstico</h3>
    <div class="row">
      <!-- Columna izquierda: acordeón -->
      <div class="col-md-6 border-end">
        <h5>Seleccionar por lista</h5>

        <div class="accordion" id="componentesAccordion">
          {% for padre in componentes %}
            <div class="accordion-item">
              <h2 class="accordion-header" id="heading-{{ padre.id }}">
                <button class="accordion-button collapsed" type="button"
                        data-bs-toggle="collapse" data-bs-target="#collapse-{{ padre.id }}"
                        aria-expanded="false" aria-controls="collapse-{{ padre.id }}">
                  {{ padre.nombre }}
                </button>
              </h2>
              <div id="collapse-{{ padre.id }}" class="accordion-collapse collapse"
                   aria-labelledby="heading-{{ padre.id }}" data-bs-parent="#componentesAccordion">
                <div class="accordion-body">
                  {% for hijo in padre.hijos.all %}
                    <div class="form-check">
                      <input class="form-check-input"
                             type="checkbox"
                             name="componentes_seleccionados"
                             value="{{ hijo.id }}"
                             id="comp-{{ hijo.id }}"
                             data-nombre="{{ hijo.nombre }}"
                             {% if hijo.id in selected_componentes_ids %}checked{% endif %}>
                      <label class="form-check-label" for="comp-{{ hijo.id }}">
                        {{ hijo.nombre }}
                      </label>
                    </div>
                  {% empty %}
                    <p class="text-muted small">No hay subcomponentes registrados.</p>
                  {% endfor %}
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      </div>

      <!-- Columna derecha: plano SVG -->
      <div class="col-md-6">
        <h5>Seleccionar en el plano</h5>
        <button id="btn-reset-plano" type="button" class="btn btn-sm btn-outline-secondary mb-2">
          ⬅️ Volver al plano inicial
        </button>

        <div id="plano-container"
             style="border:1px solid #ccc; max-height:100%; overflow:auto;"
             data-inicial-url="{% static 'images/vehiculo-desde-abajo.svg' %}">
          <div style="transform:scale(0.9); transform-origin: top left;">
            {{ svg|safe }}
          </div>
        </div>

        <!-- 🔽 Lista de componentes elegidos -->
        <div id="componentes-seleccionados" class="mt-3">
          <h6>Componentes seleccionados:</h6>
          <ul id="lista-seleccionados" class="list-group small"></ul>

          <!-- ====== BLOQUE ACCIONES ====== -->
          <div class="card mt-2">
            <div class="card-body p-2">
              <h3 class="h6">Acciones para componentes seleccionados</h3>
              <ul id="acciones-para-componentes" class="list-group list-group-flush small"></ul>
              <input type="hidden" id="acciones_componentes_json" name="acciones_componentes_json" value="[]">
              <div class="d-flex justify-content-end mt-2">
                <div class="text-end">
                  <div class="small text-muted">Total mano de obra</div>
                  <div class="fw-bold" id="total_mano_obra">$0</div>
                </div>
              </div>
            </div>
          </div>
          <!-- ====== FIN BLOQUE ACCIONES ====== -->

          <!-- ====== BLOQUE REPUESTOS (meta + botones) ====== -->
          <!-- Un solo diagnostico-meta en el template -->
          <div id="diagnostico-meta"
               data-diagnostico-id="{{ diagnostico.id|default:'' }}"
               data-csrf="{{ csrf_token }}">
          </div>

          <hr>
          <h3>🔧 Repuestos sugeridos</h3>
          <button type="button" class="btn btn-outline-primary mb-2" onclick="cargarRepuestos()">
            Buscar repuestos sugeridos
          </button>

          <!-- Un solo contenedor #repuestos-list -->
          <div id="repuestos-list"
               data-preview-url="{% url 'sugerir_repuestos_preview' %}"
               data-with-id-template="{% url 'sugerir_repuestos' 0 %}">
            <p class="text-muted">Aquí aparecerán los repuestos sugeridos.</p>
          </div>

          <hr>
          <h4>🧾 Repuestos agregados al diagnóstico</h4>
          <div id="tabla-contenido"></div>
          <!-- ====== FIN BLOQUE REPUESTOS ====== -->

        </div>
      </div>
    </div>

    <div class="mt-3">
      <label class="form-label">Descripción del problema:</label>
      {{ diagnostico_form|crispy }}
    </div>
    <!-- hidden que envía los repuestos seleccionados -->
    <input type="hidden" name="repuestos_json" id="repuestos-json">


    <button type="submit" class="btn btn-primary">Guardar</button>
    <!--button type="submit" class="btn btn-primary" onclick="prepararRepuestosParaEnvio()">Guardar</button-->

    <a href="{% url 'panel_principal' %}" class="btn btn-sm btn-warning">Regresar</a>
  </form>
</div>

<!-- Punto de referencia para build de endpoints (una sola vez) -->
<div id="acciones-endpoints" data-acciones-url-template="{% url 'acciones_por_componente' 0 %}"></div>

<div id="componentes-endpoints"
     data-lookup-url="{% url 'componentes_lookup' %}">
</div>

<div id="repuestos-endpoints"
     data-preview-url="{% url 'sugerir_repuestos_preview' %}"
     data-with-id-template="{% url 'sugerir_repuestos' 0 %}">
</div>



<!-- ---------------- SCRIPTS (TODO integrado aquí) ---------------- -->
<script src="{% static 'js/ingreso.js' %}"></script>

{% endblock %}
