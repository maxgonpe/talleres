{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container mt-4">
  <h2>🔧 Trabajo #{{ trabajo.id }} - {{ trabajo.vehiculo }}</h2>
  <p><strong>Estado actual:</strong> 
    <span class="badge bg-info">{{ trabajo.get_estado_display }}</span>
  </p>
  <p><strong>Observaciones:</strong> {{ trabajo.observaciones|default:"-" }}</p>

  <hr>

  <!-- Mecánicos -->
  <h4>👷 Mecánicos asignados</h4>
  {% if trabajo.mecanicos.all %}
    <ul>
      {% for mec in trabajo.mecanicos.all %}
        <li>{{ mec.nombre }}</li>
      {% endfor %}
    </ul>
  {% else %}
    <p>No hay mecánicos asignados.</p>
  {% endif %}

  <form method="post">
    {% csrf_token %}
    {{ asignar_form.as_p }}
    <button type="submit" name="asignar_mecanicos" class="btn btn-primary">Asignar Mecánicos</button>
  </form>

  <hr>

  <!-- Acciones -->
  <h4>🛠️ Acciones</h4>
  <form method="post">
    {% csrf_token %}
    <ul class="list-group">
      {% for acc in trabajo.acciones.all %}
        <li class="list-group-item d-flex justify-content-between align-items-center">
          {{ acc.accion.nombre }} - {{ acc.componente.nombre }}
          <div>
            {% if acc.completado %}
              <span class="badge bg-success">✔️ Completado</span>
            {% else %}
              <button type="submit" name="accion_completar" value="{{ acc.id }}" 
                      class="btn btn-sm btn-outline-success">Marcar Completado</button>
            {% endif %}
          </div>
        </li>
      {% empty %}
        <li class="list-group-item">No hay acciones registradas</li>
      {% endfor %}
    </ul>
  </form>

  <hr>

  <!-- Repuestos -->
  <h4>⚙️ Repuestos</h4>
  <form method="post">
    {% csrf_token %}
    <ul class="list-group">
      {% for rep in trabajo.repuestos.all %}
        <li class="list-group-item d-flex justify-content-between align-items-center">
          {{ rep.repuesto.nombre }} (x{{ rep.cantidad }}) - ${{ rep.subtotal }}
          <div>
            {% if rep.estado == "instalado" %}
              <span class="badge bg-success">✔️ Instalado</span>
            {% else %}
              <button type="submit" name="repuesto_instalar" value="{{ rep.id }}" 
                      class="btn btn-sm btn-outline-primary">Marcar Instalado</button>
            {% endif %}
          </div>
        </li>
      {% empty %}
        <li class="list-group-item">No hay repuestos registrados</li>
      {% endfor %}
    </ul>
  </form>

  <hr>

  <!-- Fotos -->
  <h4>📷 Fotos del proceso</h4>
  <div class="row">
    {% for foto in trabajo.fotos.all %}
      <div class="col-md-4 mb-3">
        <div class="card shadow-sm">
          <img src="{{ foto.imagen.url }}" class="card-img-top img-fluid rounded">
          <div class="card-body">
            <p class="card-text small">{{ foto.descripcion|default:"(Sin descripción)" }}</p>
            <p class="text-muted small">{{ foto.fecha|date:"d/m/Y H:i" }}</p>
          </div>
        </div>
      </div>
    {% empty %}
      <p>No hay fotos todavía.</p>
    {% endfor %}
  </div>

  <form method="post" enctype="multipart/form-data" class="mt-3">
    {% csrf_token %}
    {{ foto_form.as_p }}
    <button type="submit" name="subir_foto" class="btn btn-secondary">Subir Foto</button>
  </form>

  <hr>

  <!-- Totales -->
  <h4>📊 Totales</h4>
  <ul>
    <li>💵 Mano de obra: ${{ trabajo.total_mano_obra }}</li>
    <li>⚙️ Repuestos: ${{ trabajo.total_repuestos }}</li>
    <li><strong>Total general:</strong> ${{ trabajo.total_general }}</li>
  </ul>

  <hr>

  <!-- Botones de estado -->
  <form method="post">
    {% csrf_token %}
    {% if trabajo.estado == "iniciado" %}
      <button type="submit" name="marcar_trabajando" class="btn btn-warning">➡️ Marcar como Trabajando</button>
    {% elif trabajo.estado == "trabajando" %}
      <button type="submit" name="marcar_completado" class="btn btn-success">✔️ Marcar como Completado</button>
    {% elif trabajo.estado == "completado" %}
      <button type="submit" name="marcar_entregado" class="btn btn-dark">📦 Marcar como Entregado</button>
    {% endif %}
  </form>
</div>
{% endblock %}
