<!--  hola -->
{% extends "base.html" %}
{% load static %}
{% load humanize %}
{% block content %}
<div class="container mt-4">

  <h2 class="mb-4">ðŸ›’ Nueva Venta</h2>

  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <form method="post" id="venta-form">
        {% csrf_token %}

        <div class="row mb-3">
          <!-- Cliente y mÃ©todo de pago -->
          <div class="col-md-6">
            <h5>Datos de la venta</h5>
            {{ form.as_p }}
          </div>

          <!-- Buscador -->
          <div class="col-md-6">
            <h5>Buscar repuesto</h5>
            <label for="producto-search" class="form-label">SKU, OEM, referencia, nombre, marca, cÃ³digo</label>
            <input type="text" id="producto-search" style="border: 1px solid var(--border-color);"/>
            <div id="search-results" class="mt-2" style="border: 1px solid var(--border-color);"></div>
            <div class="mt-2">
              <button type="button" id="add-selected" class="btn btn-primary me-2">âž• Agregar</button>
              <button type="button" id="clear-search" class="btn btn-light">Limpiar</button>
            </div>
          </div>
        </div>

        <!-- Campo oculto: serializamos carrito -->
        <input type="hidden" name="cart_json" id="id_cart_json" value="[]">

        <h5 class="mt-4">Productos</h5>
        <table id="productos-table" class="table table-sm table-striped align-middle">
          <thead class="table-light">
            <tr>
              <th style="width: 50%;">Repuesto</th>
              <th style="width: 10%;">Cant</th>
              <th style="width: 15%;">Precio</th>
              <th style="width: 15%;">Subtotal</th>
              <th style="width: 10%;"></th>
            </tr>
          </thead>
          <tbody>
            <!-- filas generadas por JS -->
          </tbody>
        </table>

        <div class="d-flex justify-content-between align-items-center mt-3">
          <small class="text-secondary">Puedes buscar y agregar varios productos antes de guardar.</small>
          <h4>Total: $ <span id="total">0</span></h4>
        </div>

        <div class="mt-3 text-end">
          <button type="submit" class="btn btn-success">ðŸ’¾ Finalizar Venta</button>
          <a href="{% url 'ventas_historial' %}" class="btn btn-secondary">Historial</a>
        </div>
      </form>
    </div>
  </div>

  <!-- Filtro de fecha -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <h5>ðŸ“… Arqueo Diario</h5>
      <form method="get" action="">
        <div class="row g-3 align-items-center">
          <div class="col-auto">
            <label for="fecha" class="col-form-label">Seleccionar fecha:</label>
          </div>
          <div class="col-auto">
            <input type="date" id="fecha" name="fecha" class="form-control" value="{{ request.GET.fecha|default:today }}">
          </div>
          <div class="col-auto">
            <button type="submit" class="btn btn-outline-primary">Filtrar</button>
          </div>
        </div>
      </form>

      <!-- Totales -->
      <div class="row text-center mt-3">
        <div class="col-md-3">
          <div class="card bg-secondary border-success">
            <div class="card-body">
              <h6 class="text-secondary">Efectivo</h6>
              <h4 class="text-success">${{ total_efectivo|default:"0"|floatformat:0|intcomma }}</h4>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card bg-light border-info">
            <div class="card-body">
              <h6 class="text-secondary">Tarjeta</h6>
              <h4 class="text-info">${{ total_tarjeta|default:"0"|floatformat:0|intcomma }}</h4>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card bg-light border-warning">
            <div class="card-body">
              <h6 class="text-secondary">Transferencia</h6>
              <h4 class="text-warning">${{ total_transferencia|default:"0"|floatformat:0|intcomma }}</h4>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card bg-light border-dark">
            <div class="card-body">
              <h6 class="text-secondary">Total General</h6>
              <h4 class="text-primary">${{ total_general|default:"0"|floatformat:0|intcomma }}</h4>
            </div>
          </div>
        </div>
        <a href="javascript:history.back()" class="btn btn-sm btn-warning mt-2">Regresar</a>
      </div>

    </div>
  </div>

</div>

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
$(function() {
  // cart: array de items
  let cart = [];

  function updateHiddenCart() {
    $('#id_cart_json').val(JSON.stringify(cart));
  }

  function calcularTotal() {
    let total = 0;
    cart.forEach(it => { total += parseFloat(it.subtotal || 0); });
    $('#total').text(Math.round(total));
  }

  function renderTable() {
    const tbody = $('#productos-table tbody').empty();
    cart.forEach((it, i) => {
      const tr = $('<tr/>');
      const repCol = $('<td/>').html(`<div><strong>${it.repuesto_nombre}</strong></div><div class="text-secondary small">${it.text}</div><div class="text-secondary small">Dep: ${it.deposito} â€” Stock: ${it.stock}</div>`);
      const qtyInput = $(`<input type="number" class="form-control form-control-sm qty" min="1" value="${it.cantidad}" style="width: 90px;">`);
      qtyInput.on('change input', function() {
        let q = parseInt($(this).val() || 0);
        if (q < 1) { q = 1; $(this).val(q); }
        it.cantidad = q;
        it.subtotal = Math.round(parseFloat(it.precio_unitario) * q);
        updateHiddenCart();
        renderTable();
      });
      const qtyCol = $('<td/>').append(qtyInput);
      const priceCol = $('<td/>').text(Math.round(parseFloat(it.precio_unitario)));
      const subtotalInput = $('<input type="text" readonly class="form-control form-control-sm subtotal" style="width: 120px;">').val(Math.round(parseFloat(it.subtotal)));
      const subCol = $('<td/>').append(subtotalInput);
      const delBtn = $('<button type="button" class="btn btn-danger btn-sm">âœ–</button>');
      delBtn.on('click', function() {
        cart.splice(i, 1);
        updateHiddenCart();
        renderTable();
      });
      const delCol = $('<td/>').append(delBtn);

      tr.append(repCol, qtyCol, priceCol, subCol, delCol);
      tbody.append(tr);
    });
    updateHiddenCart();
    calcularTotal();
  }

  // Manejar bÃºsqueda con caja de texto
  $('#producto-search').on('input', function() {
    const query = $(this).val();
    if (query.length < 1) {
      $('#search-results').empty(); 
      return; // Si no hay texto, no hacer nada
    }

    $.ajax({
      url: "{% url 'repuesto_lookup' %}",
      dataType: "json",
      data: { q: query },
      success: function(data) {
        // Mostrar los resultados de bÃºsqueda
        let resultsContainer = $('#search-results').empty();
        data.results.forEach(item => {
          const resultItem = $('<div class="result-item" style="cursor: pointer; padding: var(--spacing-xs);">')
            .text(item.text + ` (Stock: ${item.stock})`)
            .data('item', item) // Guardamos el item en el elemento
            .on('click', function() {
              addProductToCart($(this).data('item'));
              resultsContainer.empty(); // Limpiar resultados despuÃ©s de seleccionar
            });
          resultsContainer.append(resultItem);
        });
      },
      error: function(e) {
        console.error(e);
      }
    });
  });

  // FunciÃ³n para agregar el producto al carrito
  function addProductToCart(selectedItem) {
    const existing = cart.find(c => String(c.repuesto_stock_id) === String(selectedItem.id));
    if (existing) {
      existing.cantidad = (existing.cantidad || 0) + 1;
      existing.subtotal = Math.round(parseFloat(existing.precio_unitario) * existing.cantidad);
    } else {
      const precio = (selectedItem.precio_venta !== undefined) ? parseFloat(String(selectedItem.precio_venta)) : 0;
      cart.push({
        repuesto_stock_id: selectedItem.id,
        cantidad: 1,
        precio_unitario: Math.round(precio),
        subtotal: Math.round(precio),
        repuesto_nombre: selectedItem.repuesto_nombre || selectedItem.text,
        text: selectedItem.text || "",
        stock: selectedItem.stock || 0,
        deposito: selectedItem.deposito || ""
      });
    }
    renderTable();
    $('#producto-search').val(''); // Limpiar el campo de bÃºsqueda
  }

  $('#clear-search').on('click', function() {
    $('#producto-search').val('');
    $('#search-results').empty(); // Limpiar resultados
  });

  // Al enviar el form: asegurarnos que cart no estÃ© vacÃ­o
  $('#venta-form').on('submit', function(e) {
    if (cart.length === 0) {
      e.preventDefault();
      alert("Agrega al menos un producto a la venta.");
      return false;
    }
    // hidden already updated por renderTable/updateHiddenCart()
    return true;
  });
});
</script>

{% endblock %}