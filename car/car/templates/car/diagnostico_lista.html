{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'css/centralized-colors.css' %}">
  <style>
    /* Pesta√±as temporales para diagn√≥sticos */
    .tiempo-tabs {
      display: flex;
      gap: var(--spacing-xs);
      margin-bottom: var(--spacing-lg);
      overflow-x: auto;
      padding: var(--spacing-xs);
      background: var(--bg-card);
      border-radius: var(--border-radius-lg);
      box-shadow: var(--shadow-sm);
    }
    
    .tiempo-tab {
      flex: 1;
      min-width: 120px;
      padding: var(--spacing-sm) var(--spacing-md);
      background: var(--bg);
      border: 2px solid var(--border-color);
      border-radius: var(--border-radius);
      color: var(--text-primary);
      font-weight: 600;
      font-size: 0.9rem;
      text-align: center;
      cursor: pointer;
      transition: var(--transition);
      white-space: nowrap;
    }
    
    .tiempo-tab:hover {
      background: var(--hover-bg);
      transform: translateY(-2px);
    }
    
    .tiempo-tab.active {
      background: var(--primary-600);
      color: var(--text-inverse);
      border-color: var(--primary-600);
      box-shadow: var(--shadow-md);
    }
    
    .tiempo-tab .count {
      display: block;
      font-size: 1.2rem;
      font-weight: bold;
      margin-top: 0.25rem;
    }
    
    @media (max-width: 768px) {
      .tiempo-tabs {
        flex-wrap: nowrap;
        gap: var(--spacing-xs);
      }
      
      .tiempo-tab {
        min-width: 90px;
        padding: var(--spacing-xs) var(--spacing-sm);
        font-size: 0.8rem;
      }
      
      .tiempo-tab .count {
        font-size: 1rem;
      }
    }
  </style>
{% endblock %}

{% block content %}

<style>
/* üé® Mejorar contraste del texto en diagn√≥sticos usando variables centralizadas */

/* Estilos generales para cards de diagn√≥stico */
.diagnostico-card {
    background-color: var(--bg-card);
    border: 1px solid var(--border-color);
    color: var(--text-primary);
    position: relative;
    overflow: hidden;
}

/* Ribbon/Tri√°ngulo APROBADO en esquina superior derecha */
.diagnostico-card.aprobado::before {
    content: '';
    position: absolute;
    top: 0;
    right: 0;
    width: 0;
    height: 0;
    border-style: solid;
    border-width: 0 80px 80px 0;
    border-color: transparent #28a745 transparent transparent;
    z-index: 5;
    pointer-events: none;
}

.diagnostico-card.aprobado::after {
    content: '‚úÖ';
    position: absolute;
    top: 8px;
    right: 8px;
    color: white;
    font-size: 2rem;
    font-weight: 900;
    z-index: 6;
    pointer-events: none;
    transform: rotate(0deg);
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
}

/* Badge "APROBADO" adicional debajo del tri√°ngulo */
.diagnostico-card.aprobado .card-body::before {
    content: 'APROBADO';
    position: absolute;
    top: 15px;
    right: 15px;
    background: #28a745;
    color: white;
    padding: 8px 20px;
    font-size: 0.85rem;
    font-weight: 700;
    border-radius: 20px;
    z-index: 4;
    pointer-events: none;
    text-transform: uppercase;
    letter-spacing: 1px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
}

/* Contenido sobre la marca de agua */
.diagnostico-card .card-body {
    position: relative;
    z-index: 2;
}

/* Bot√≥n ACEPTAR destacado */
.btn-aceptar-destacado {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%) !important;
    border: 3px solid #28a745 !important;
    color: white !important;
    font-size: 1.2rem !important;
    font-weight: 700 !important;
    padding: 0.75rem 2rem !important;
    border-radius: 50px !important;
    box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4) !important;
    transition: all 0.3s ease !important;
    text-transform: uppercase !important;
    letter-spacing: 1px !important;
    animation: pulse-aceptar 2s ease-in-out infinite;
}

.btn-aceptar-destacado:hover {
    background: linear-gradient(135deg, #20c997 0%, #28a745 100%) !important;
    box-shadow: 0 6px 20px rgba(40, 167, 69, 0.6) !important;
    transform: translateY(-2px) scale(1.05) !important;
}

.btn-aceptar-destacado:active {
    transform: translateY(0) scale(1) !important;
}

@keyframes pulse-aceptar {
    0%, 100% {
        box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4);
    }
    50% {
        box-shadow: 0 4px 25px rgba(40, 167, 69, 0.7);
    }
}

/* Badge APROBADO */
.badge-aprobado-grande {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%) !important;
    color: white !important;
    font-size: 1rem !important;
    font-weight: 700 !important;
    padding: 0.5rem 1.5rem !important;
    border-radius: 25px !important;
    box-shadow: 0 2px 10px rgba(40, 167, 69, 0.3) !important;
    border: 2px solid rgba(255, 255, 255, 0.3) !important;
}

.diagnostico-card .list-group-item {
    background-color: var(--bg-card);
    border-color: var(--border-color);
    color: var(--text-primary);
}

.diagnostico-card .list-group-item strong {
    color: var(--text-primary);
    font-weight: 600;
}

/* Mejoras espec√≠ficas para tema Piedra (oscuro) */
.theme-piedra .diagnostico-card .list-group-item strong {
    color: #ffffff !important; /* Blanco brillante para contraste m√°ximo */
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);
}

.theme-piedra .diagnostico-card .list-group-item {
    color: #e6e6e6 !important; /* Gris claro brillante */
    background-color: var(--bg-card);
}

.theme-piedra .diagnostico-card .list-group-item:hover {
    background-color: var(--bg-secondary);
    color: #ffffff !important;
}

/* Mejoras para tema Charcoal (oscuro) */
.theme-charcoal .diagnostico-card .list-group-item strong {
    color: #ffffff !important;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);
}

.theme-charcoal .diagnostico-card .list-group-item {
    color: #e6e6e6 !important;
}

/* Mejoras para tema Forest (oscuro) */
.theme-forest .diagnostico-card .list-group-item strong {
    color: #ffffff !important;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);
}

.theme-forest .diagnostico-card .list-group-item {
    color: #e6e6e6 !important;
}

/* Mejoras para tema Plum (oscuro) */
.theme-plum .diagnostico-card .list-group-item strong {
    color: #ffffff !important;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);
}

.theme-plum .diagnostico-card .list-group-item {
    color: #e6e6e6 !important;
}

/* Mejoras para tema Cyan (oscuro) */
.theme-cyan .diagnostico-card .list-group-item strong {
    color: #ffffff !important;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);
}

.theme-cyan .diagnostico-card .list-group-item {
    color: #e6e6e6 !important;
}

/* Estilos para temas claros (mantener contraste) */
.theme-sand .diagnostico-card .list-group-item strong {
    color: #1a1a1a !important; /* Negro profundo para contraste */
}

.theme-sand .diagnostico-card .list-group-item {
    color: #2c2c2c !important;
}

.theme-sage .diagnostico-card .list-group-item strong {
    color: #1a1a1a !important;
}

.theme-sage .diagnostico-card .list-group-item {
    color: #2c2c2c !important;
}

.theme-sky .diagnostico-card .list-group-item strong {
    color: #1a1a1a !important;
}

.theme-sky .diagnostico-card .list-group-item {
    color: #2c2c2c !important;
}

/* Mejoras adicionales para badges y elementos especiales */
.diagnostico-card .badge {
    color: var(--text-inverse) !important;
    font-weight: 600;
}

.theme-piedra .diagnostico-card .badge {
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);
}

/* Mejorar contraste de enlaces */
.diagnostico-card a {
    color: var(--accent);
    text-decoration: none;
}

.diagnostico-card a:hover {
    color: var(--accent-600);
    text-decoration: underline;
}

.theme-piedra .diagnostico-card a {
    color: #87ceeb !important; /* Azul claro brillante */
}

.theme-piedra .diagnostico-card a:hover {
    color: #ffffff !important;
}
</style>
<h3>Diagn√≥sticos ‚û°Ô∏è Presupuestos</h3>

<input type="text" id="filterInput" class="form-control my-2" placeholder="Buscar por veh√≠culo, cliente, tel√©fono, diagn√≥stico, partes...">

<!-- Pesta√±as de filtrado temporal -->
<div class="tiempo-tabs">
  <div class="tiempo-tab active" data-tiempo="todos">
    <span>üîç Todos</span>
    <span class="count" id="count-todos">{{ diagnosticos|length }}</span>
  </div>
  <div class="tiempo-tab" data-tiempo="hoy">
    <span>üìÖ Hoy</span>
    <span class="count" id="count-hoy">0</span>
  </div>
  <div class="tiempo-tab" data-tiempo="semana">
    <span>üìÜ Esta Semana</span>
    <span class="count" id="count-semana">0</span>
  </div>
  <div class="tiempo-tab" data-tiempo="antiguos">
    <span>üìú M√°s de 2 Semanas</span>
    <span class="count" id="count-antiguos">0</span>
  </div>
</div>

{% for diagnostico in diagnosticos %}
<div class="card mb-3 diagnostico-card diagnostico-item {% if diagnostico.estado == 'aprobado' %}aprobado{% endif %}" data-fecha="{{ diagnostico.fecha|date:'Y-m-d' }}">
  <div class="card-body">
    <strong>Veh√≠culo:</strong> {{ diagnostico.vehiculo }}<br>
    
    <strong>VIN:</strong> <strong style="color: var(--danger-600);"> {{ diagnostico.vehiculo.vin }}</strong> <br>
    <strong>Cliente:</strong> {{ diagnostico.vehiculo.cliente.nombre }}<br>
    <strong>Tel√©fono:</strong> {{ diagnostico.vehiculo.cliente.telefono }}<br>

    <strong>Diagn√≥stico:</strong> {{ diagnostico.descripcion_problema }}<br>
    <strong>Partes Afectadas:</strong> 
    {% for comp in diagnostico.componentes.all %}
      {{ comp.nombre }}{% if not forloop.last %}, {% endif %}
    {% empty %}
      Ninguno
    {% endfor %}
    <br>

    <!-- ==== Acciones y Mano de Obra ==== -->
    <strong>Acciones realizadas:</strong><br>
    {% with diagnostico.acciones_componentes.all as acciones %}
      {% if acciones %}
        <ul class="list-group list-group-flush my-2">
          {% for dca in acciones %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <span>
                <strong>{{ dca.componente.nombre }}</strong> ‚Äî {{ dca.accion.nombre }}
              </span>
              <span class="badge bg-primary rounded-pill">
                ${{ dca.precio_mano_obra|default:0|floatformat:0|intcomma }}
              </span>
            </li>
          {% endfor %}
        </ul>
        <div class="text-end fw-bold">
          Total mano de obra: 
          ${{ diagnostico.total_mano_obra|default:0|floatformat:0|intcomma }}
        </div>
      {% else %}
        <span class="text-secondary">No se registraron acciones</span>
      {% endif %}
    {% endwith %}

    <!-- ==== Repuestos ==== -->
    <strong>Repuestos utilizados:</strong><br>
    {% with diagnostico.repuestos.all as repuestos %}
      {% if repuestos %}
        <ul class="list-group list-group-flush my-2">
          {% for dr in repuestos %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <span>
                <strong>{{ dr.repuesto.nombre }}</strong> (x{{ dr.cantidad }})
              </span>
              <span class="badge bg-primary rounded-pill">
                ${{ dr.subtotal|default:0|floatformat:0|intcomma }}
              </span>
            </li>
          {% endfor %}
        </ul>
        <div class="text-end fw-bold">
          Total repuestos: 
          ${{ diagnostico.total_repuestos|default:0|floatformat:0|intcomma }}
        </div>
      {% else %}
        <span class="text-secondary">No se registraron repuestos</span>
      {% endif %}
    {% endwith %}

    <!-- == TOTAL PRESUPUESTO == -->
    <div class="text-end fw-bold mt-2 text-success">
      üí∞ Total presupuesto: 
      {{ diagnostico.total_mano_obra|default:0|add:diagnostico.total_repuestos|default:0|floatformat:0|intcomma }}
    </div>

    <strong>√öltima Visita:</strong> {{ diagnostico.fecha }}<br>

    <!-- ==== Botones ==== -->
    <a href="{% url 'diagnostico_excel' diagnostico.pk %}" class="btn btn-success btn-sm mt-2">Excel</a>
    <a href="{% url 'diagnostico_pdf' diagnostico.pk %}" class="btn btn-danger btn-sm mt-2">PDF</a>
    <a href="{% url 'editar_diagnostico' diagnostico.pk %}" class="btn btn-sm btn-primary mt-2">
        <i class="fas fa-edit"></i> Editar
    </a>
    <a href="{% url 'eliminar_diagnostico' diagnostico.pk %}" class="btn btn-sm btn-danger mt-2">Eliminar</a>
    <a href="{% url 'panel_principal' %}" class="btn btn-sm btn-warning mt-2">Regresar</a>

    <!-- ==== Bot√≥n Aceptar / Estado ==== -->
    {% if diagnostico.estado == "pendiente" %}
      <a href="{% url 'aprobar_diagnostico' diagnostico.pk %}" class="btn btn-aceptar-destacado mt-3">
        ‚úÖ Aceptar Presupuesto
      </a>
    {% elif diagnostico.estado == "aprobado" %}
      <span class="badge badge-aprobado-grande mt-3">‚úÖ Presupuesto Aprobado</span>
    {% endif %}

  </div>
</div>
{% empty %}
<p>No hay diagn√≥sticos registrados.</p>
{% endfor %}

<a href="javascript:history.back()" class="btn btn-sm btn-warning mt-2">Regresar</a>

<script>
let tiempoActivo = 'todos';

document.addEventListener('DOMContentLoaded', function () {
  // Contar diagn√≥sticos por tiempo
  contarDiagnosticos();
  
  // Filtro de b√∫squeda
  const filterInput = document.getElementById('filterInput');
  const diagnosticoItems = document.querySelectorAll('.diagnostico-item');
  
  filterInput.addEventListener('keyup', function () {
    const filterValue = filterInput.value.toLowerCase();
    diagnosticoItems.forEach(function (item) {
      const text = item.textContent.toLowerCase();
      const matchesSearch = text.includes(filterValue);
      const matchesTiempo = tiempoActivo === 'todos' || cumpleFiltro(item.dataset.fecha, tiempoActivo);
      
      item.style.display = (matchesSearch && matchesTiempo) ? 'block' : 'none';
    });
  });
  
  // Event listeners para las pesta√±as temporales
  document.querySelectorAll('.tiempo-tab').forEach(tab => {
    tab.addEventListener('click', function() {
      filtrarPorTiempo(this.dataset.tiempo);
    });
  });
});

function filtrarPorTiempo(tiempo) {
  tiempoActivo = tiempo;
  const diagnosticoItems = document.querySelectorAll('.diagnostico-item');
  const filterInput = document.getElementById('filterInput');
  const filterValue = filterInput.value.toLowerCase();
  
  // Actualizar pesta√±as activas
  document.querySelectorAll('.tiempo-tab').forEach(tab => {
    tab.classList.remove('active');
  });
  document.querySelector(`.tiempo-tab[data-tiempo="${tiempo}"]`).classList.add('active');
  
  // Filtrar diagn√≥sticos
  diagnosticoItems.forEach(function (item) {
    const matchesTiempo = tiempo === 'todos' || cumpleFiltro(item.dataset.fecha, tiempo);
    const matchesSearch = filterValue === '' || item.textContent.toLowerCase().includes(filterValue);
    
    item.style.display = (matchesTiempo && matchesSearch) ? 'block' : 'none';
  });
}

function cumpleFiltro(fechaStr, filtro) {
  // Normalizar fechas para comparaci√≥n (sin hora)
  const fecha = new Date(fechaStr + 'T00:00:00');
  const hoy = new Date();
  hoy.setHours(0, 0, 0, 0);
  
  // Calcular d√≠as de diferencia (hoy - fecha = positivo si fecha es anterior)
  const diffTime = hoy.getTime() - fecha.getTime();
  const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
  
  console.log(`Fecha: ${fechaStr}, Diff d√≠as: ${diffDays}, Filtro: ${filtro}`);
  
  switch(filtro) {
    case 'hoy':
      return diffDays === 0; // Exactamente hoy
    case 'semana':
      return diffDays >= 0 && diffDays <= 7; // √öltimos 7 d√≠as (incluye hoy)
    case 'antiguos':
      return diffDays > 14; // M√°s de 2 semanas
    default:
      return true;
  }
}

function contarDiagnosticos() {
  const diagnosticoItems = document.querySelectorAll('.diagnostico-item');
  const contadores = {
    'hoy': 0,
    'semana': 0,
    'antiguos': 0
  };
  
  diagnosticoItems.forEach(item => {
    const fecha = item.dataset.fecha;
    if (cumpleFiltro(fecha, 'hoy')) {
      contadores['hoy']++;
    }
    if (cumpleFiltro(fecha, 'semana')) {
      contadores['semana']++;
    }
    if (cumpleFiltro(fecha, 'antiguos')) {
      contadores['antiguos']++;
    }
  });
  
  // Actualizar los contadores en las pesta√±as
  document.getElementById('count-hoy').textContent = contadores['hoy'];
  document.getElementById('count-semana').textContent = contadores['semana'];
  document.getElementById('count-antiguos').textContent = contadores['antiguos'];
}
</script>
{% endblock %}
